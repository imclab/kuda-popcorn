/**
 * @author alteredq / http://alteredqualia.com/
 * @author mr.doob / http://mrdoob.com/
 */
Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");a.style.fontFamily="monospace",a.style.fontSize="13px",a.style.textAlign="center",a.style.background="#eee",a.style.color="#000",a.style.padding="1em",a.style.width="475px",a.style.margin="5em auto 0",this.webgl||(a.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n"));return a},addGetWebGLMessage:function(a){var b,c,d;a=a||{},b=a.parent!==undefined?a.parent:document.body,c=a.id!==undefined?a.id:"oldie",d=Detector.getWebGLErrorMessage(),d.id=c,b.appendChild(d)}}/**
 * Copyright 2009 Tim Down.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var Hashtable=(function(){var w="undefined",f="function",k="string",j="equals",t="hashCode",o="toString";var r=(typeof Array.prototype.splice==f)?function(y,x){y.splice(x,1)}:function(A,z){var y,B,x;if(z===A.length-1){A.length=z}else{y=A.slice(z+1);A.length=z;for(B=0,x=y.length;B<x;++B){A[z+B]=y[B]}}};function v(y){var x;if(typeof y==k){return y}else{if(typeof y[t]==f){x=y.hashCode();return(typeof x==k)?x:v(x)}else{if(typeof y[o]==f){return y.toString()}else{return String(y)}}}}function s(x,y){return x.equals(y)}function b(x,y){return(typeof y[j]==f)?y.equals(x):(x===y)}function d(x){return function(y){if(y===null){throw new Error("null is not a valid "+x)}else{if(typeof y==w){throw new Error(x+" must not be undefined")}}}}var g=d("key"),c=d("value");function i(y,z,x){this.entries=[];this.addEntry(y,z);if(x!==null){this.getEqualityFunction=function(){return x}}}var a=0,l=1,h=2;function p(x){return function(z){var y=this.entries.length,B,A=this.getEqualityFunction(z);while(y--){B=this.entries[y];if(A(z,B[0])){switch(x){case a:return true;case l:return B;case h:return[y,B[1]]}}}return false}}function u(x){return function(A){var B=A.length;for(var z=0,y=this.entries.length;z<y;++z){A[B+z]=this.entries[z][x]}}}i.prototype={getEqualityFunction:function(x){return(typeof x[j]==f)?s:b},getEntryForKey:p(l),getEntryAndIndexForKey:p(h),removeEntryForKey:function(y){var x=this.getEntryAndIndexForKey(y);if(x){r(this.entries,x[0]);return x[1]}return null},addEntry:function(x,y){this.entries[this.entries.length]=[x,y]},keys:u(0),values:u(1),getEntries:function(y){var A=y.length;for(var z=0,x=this.entries.length;z<x;++z){y[A+z]=this.entries[z].slice(0)}},containsKey:p(a),containsValue:function(y){var x=this.entries.length;while(x--){if(y===this.entries[x][1]){return true}}return false}};function q(){}q.prototype=[];function e(A,x){var y=A.length,z;while(y--){z=A[y];if(x===z[0]){return y}}return null}function n(y,x){var z=y[x];return(z&&(z instanceof q))?z[1]:null}function m(A,x){var B=this;var E=[];var y={};var C=(typeof A==f)?A:v;var z=(typeof x==f)?x:null;this.put=function(I,K){g(I);c(K);var F=C(I),J,H,G=null;var L=n(y,F);if(L){H=L.getEntryForKey(I);if(H){G=H[1];H[1]=K}else{L.addEntry(I,K)}}else{J=new q();J[0]=F;J[1]=new i(I,K,z);E[E.length]=J;y[F]=J}return G};this.get=function(H){g(H);var F=C(H);var I=n(y,F);if(I){var G=I.getEntryForKey(H);if(G){return G[1]}}return null};this.containsKey=function(G){g(G);var F=C(G);var H=n(y,F);return H?H.containsKey(G):false};this.containsValue=function(G){c(G);var F=E.length;while(F--){if(E[F][1].containsValue(G)){return true}}return false};this.clear=function(){E.length=0;y={}};this.isEmpty=function(){return !E.length};var D=function(F){return function(){var G=[],H=E.length;while(H--){E[H][1][F](G)}return G}};this.keys=D("keys");this.values=D("values");this.entries=D("getEntries");this.remove=function(I){g(I);var G=C(I),F,H=null;var J=n(y,G);if(J){H=J.removeEntryForKey(I);if(H!==null){if(!J.entries.length){F=e(E,G);r(E,F);y[G]=null;delete y[G]}}}return H};this.size=function(){var G=0,F=E.length;while(F--){G+=E[F][1].entries.length}return G};this.each=function(I){var F=B.entries(),G=F.length,H;while(G--){H=F[G];I(H[0],H[1])}};this.putAll=function(N,I){var H=N.entries();var K,L,J,F,G=H.length;var M=(typeof I==f);while(G--){K=H[G];L=K[0];J=K[1];if(M&&(F=B.get(L))){J=I(L,F,J)}B.put(L,J)}};this.clone=function(){var F=new m(A,x);F.putAll(B);return F}}return m})();/*
 * Port of O3D's gpu-enabled particle system to Three.js with minor modifications.
 * @author Erik Kitson
 */

/*
 * Copyright 2009, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
var hemi=hemi||{};(function(){function g(a){var b=new Uint8Array(a.length),c;for(var d=0;d<a.length;++d)c=a[d]*256,b[d]=c>255?255:c<0?0:c;return b}function f(a,b,c,d,e){var f=this.material.attributes.positionStartTime,g=this._particleSystem._randomFunction,h=function(a){return(g()-.5)*a*2},i=function(a,b){var c=[];for(var d=0,e=a.length;d<e;++d)c[d]=a[d]+h(b[d]);return c};for(var j=a,k=a+b;j<k;++j){var l=i(d,e);for(var m=0;m<4;++m){var n=j*4+m;f.value[n].x=l[0],f.value[n].y=l[1],f.value[n].z=l[2],f.value[n].w=c}}f.needsUpdate=!0}function e(b){this.validateParameters(b);var c=a[b.billboard?"particle2d":"particle3d"];this.material.attributes=THREE.UniformsUtils.clone(c.attributes),this.material.uniforms=THREE.UniformsUtils.clone(c.uniforms),this.material.vertexShader=c.vertexShader,this.material.fragmentShader=c.fragmentShader,this._timeParam=this.material.uniforms.time}function d(a,c,d){var e=this.material.attributes,f=this.material.uniforms,g=e.uvLifeTimeFrameStart,h=e.positionStartTime,i=e.velocityStartSize,j=e.accelerationEndSize,k=e.spinStartSpinSpeed,l=e.orientation,m=e.colorMult,n=c.worldVelocity,o=c.worldAcceleration,p=this._particleSystem._randomFunction,q=function(a){return(p()-.5)*a*2},r=function(a,b){var c=[];for(var d=0,e=a.length;d<e;++d)c[d]=a[d]+q(b[d]);return c};f.colorSampler.texture=this._colorTexture,f.rampSampler.texture=this._rampTexture,f.timeRange.value=c.timeRange,f.numFrames.value=c.numFrames,f.frameDuration.value=c.frameDuration,f.worldVelocity.value.set(n[0],n[1],n[2]),f.worldAcceleration.value.set(o[0],o[1],o[2]),c.billboard&&(f.viewInverse.value=this._camera.matrixWorld);for(var s=0;s<a;++s){d&&d(s,c);var t=c.lifeTime,u=c.startTime===null?s*t/a:c.startTime,v=c.frameStart+q(c.frameStartRange),w=r(c.position,c.positionRange),x=r(c.velocity,c.velocityRange),y=r(c.acceleration,c.accelerationRange),z=r(c.colorMult,c.colorMultRange),A=c.spinStart+q(c.spinStartRange),B=c.spinSpeed+q(c.spinSpeedRange),C=c.startSize+q(c.startSizeRange),D=c.endSize+q(c.endSizeRange),E=c.orientation;for(var F=0;F<4;++F){var G=s*4+F;g.value[G]=new THREE.Vector4(b[F][0],b[F][1],t,v),h.value[G]=new THREE.Vector4(w[0],w[1],w[2],u),i.value[G]=new THREE.Vector4(x[0],x[1],x[2],C),j.value[G]=new THREE.Vector4(y[0],y[1],y[2],D),k.value[G]=new THREE.Vector4(A,B,0,0),m.value[G]=new THREE.Vector4(z[0],z[1],z[2],z[3]),l&&(l.value[G]=new THREE.Vector4(E[0],E[1],E[2],E[3]))}}g.needsUpdate=!0,h.needsUpdate=!0,i.needsUpdate=!0,j.needsUpdate=!0,k.needsUpdate=!0,m.needsUpdate=!0,l&&(l.needsUpdate=!0)}function c(a){for(var b=0;b<a;++b){for(var c=0;c<4;++c)this.shape.vertices.push(new THREE.Vertex);var d=b*4;this.shape.faces.push(new THREE.Face3(d,d+1,d+3)),this.shape.faces.push(new THREE.Face3(d+1,d+2,d+3))}}hemi.particles=hemi.particles||{};var a={particle3d:{attributes:{uvLifeTimeFrameStart:{type:"v4",value:[]},positionStartTime:{type:"v4",value:[]},velocityStartSize:{type:"v4",value:[]},accelerationEndSize:{type:"v4",value:[]},spinStartSpinSpeed:{type:"v4",value:[]},orientation:{type:"v4",value:[]},colorMult:{type:"v4",value:[]}},uniforms:{worldVelocity:{type:"v3",value:new THREE.Vector3},worldAcceleration:{type:"v3",value:new THREE.Vector3},timeRange:{type:"f",value:0},time:{type:"f",value:0},timeOffset:{type:"f",value:0},frameDuration:{type:"f",value:0},numFrames:{type:"f",value:0},rampSampler:{type:"t",value:0,texture:null},colorSampler:{type:"t",value:1,texture:null}},vertexShader:"uniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart; \nattribute vec4 positionStartTime; \nattribute vec4 velocityStartSize; \nattribute vec4 accelerationEndSize; \nattribute vec4 spinStartSpinSpeed; \nattribute vec4 orientation; \nattribute vec4 colorMult; \n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\nvarying float v_discard;\n\nvoid main() {\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = positionStartTime.xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (objectMatrix * vec4(velocityStartSize.xyz, 0)).xyz\n      + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (objectMatrix *\n      vec4(accelerationEndSize.xyz, 0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  if (startTime < 0.0) {\n    v_discard = 1.0;\n    gl_Position = vec4(0);\n    return;\n  } else {\n    v_discard = -1.0;\n  }\n\n  float localTime = mod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1.0 / numFrames);\n\n  v_texcoord = vec2(u, uv.y + 0.5);\n  v_colorMult = colorMult;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0.0,\n                               (uv.x * s - uv.y * c) * size, 1.0);\n  vec3 center = velocity * localTime +\n                  acceleration * localTime * localTime + \n                  position;\n  \n      vec4 q2 = orientation + orientation;\n      vec4 qx = orientation.xxxw * q2.xyzx;\n      vec4 qy = orientation.xyyw * q2.xyzy;\n      vec4 qz = orientation.xxzw * q2.xxzz;\n  \n      mat4 localMatrix = mat4(\n        (1.0 - qy.y) - qz.z, \n        qx.y + qz.w, \n        qx.z - qy.w,\n        0,\n  \n        qx.y - qz.w, \n        (1.0 - qx.x) - qz.z, \n        qy.z + qx.w,\n        0,\n  \n        qx.z + qy.w, \n        qy.z - qx.w, \n        (1.0 - qx.x) - qy.y,\n        0,\n  \n        center.x, center.y, center.z, 1.0);\n  rotatedPoint = localMatrix * rotatedPoint;\n  gl_Position = projectionMatrix * modelViewMatrix * rotatedPoint;\n  v_percentLife = percentLife;\n}\n",fragmentShader:"varying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\nvarying float v_discard;\n\n// We need to implement 1D!\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\nvoid main() {\n  if (v_discard > 0.0) {\n    discard;\n  }\n\n  vec4 colorMult = texture2D(rampSampler, \n      vec2(v_percentLife, 0.5)) * v_colorMult;\n  vec4 color = texture2D(colorSampler, v_texcoord) * colorMult;\n  gl_FragColor = color;\n}\n"},particle2d:{attributes:{uvLifeTimeFrameStart:{type:"v4",value:[]},positionStartTime:{type:"v4",value:[]},velocityStartSize:{type:"v4",value:[]},accelerationEndSize:{type:"v4",value:[]},spinStartSpinSpeed:{type:"v4",value:[]},colorMult:{type:"v4",value:[]}},uniforms:{viewInverse:{type:"m4",value:null},worldVelocity:{type:"v3",value:new THREE.Vector3},worldAcceleration:{type:"v3",value:new THREE.Vector3},timeRange:{type:"f",value:0},time:{type:"f",value:0},timeOffset:{type:"f",value:0},frameDuration:{type:"f",value:0},numFrames:{type:"f",value:0},rampSampler:{type:"t",value:0,texture:null},colorSampler:{type:"t",value:1,texture:null}},vertexShader:"uniform mat4 viewInverse;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\nattribute vec4 uvLifeTimeFrameStart; \nattribute vec4 positionStartTime; \nattribute vec4 velocityStartSize; \nattribute vec4 accelerationEndSize; \nattribute vec4 spinStartSpinSpeed; \nattribute vec4 colorMult; \n\nvarying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\nvarying float v_discard;\n\nvoid main() {\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = (objectMatrix * vec4(positionStartTime.xyz, 1.0)).xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (objectMatrix * vec4(velocityStartSize.xyz, 0)).xyz \n      + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (objectMatrix *\n      vec4(accelerationEndSize.xyz, 0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  if (startTime < 0.0) {\n    v_discard = 1.0;\n    gl_Position = vec4(0);\n    return;\n  } else {\n    v_discard = -1.0;\n  }\n\n  float localTime = mod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                     numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1.0 / numFrames);\n\n  v_texcoord = vec2(u, uv.y + 0.5);\n  v_colorMult = colorMult;\n\n  vec3 basisX = viewInverse[0].xyz;\n  vec3 basisZ = viewInverse[1].xyz;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0.0 || percentLife > 1.0) ? 0.0 : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec2 rotatedPoint = vec2(uv.x * c + uv.y * s, \n                               -uv.x * s + uv.y * c);\n  vec3 localPosition = vec3(basisX * rotatedPoint.x +\n                                basisZ * rotatedPoint.y) * size +\n                         velocity * localTime +\n                         acceleration * localTime * localTime + \n                         position;\n\n  gl_Position = (projectionMatrix * viewMatrix * vec4(localPosition, 1.0));\n  v_percentLife = percentLife;\n}\n",fragmentShader:"varying vec4 v_position;\nvarying vec2 v_texcoord;\nvarying float v_percentLife;\nvarying vec4 v_colorMult;\nvarying float v_discard;\n\n// We need to implement 1D!\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\nvoid main() {\n  if (v_discard > 0.0) {\n    discard;\n  }\n\n  vec4 colorMult = texture2D(rampSampler, \n      vec2(v_percentLife, 0.5)) * v_colorMult;\n  vec4 color = texture2D(colorSampler, v_texcoord) * colorMult;\n  gl_FragColor = color;\n}\n"}},b=[[-0.5,-0.5],[.5,-0.5],[.5,.5],[-0.5,.5]];hemi.particles.System=function(a){var b=[0,.2,.7,1,.7,.2,0,0],c=[];for(var d=0;d<8;++d)for(var e=0;e<8;++e){var f=b[e]*b[d];c.push(f,f,f,f)}var h=g(c),i=new THREE.DataTexture(h,8,8,THREE.RGBAFormat),j=g([1,1,1,1,1,1,1,.5,1,1,1,0]),k=new THREE.DataTexture(j,3,1,THREE.RGBAFormat);k.wrapT=THREE.RepeatWrapping,i.needsUpdate=k.needsUpdate=!0,this._randomFunction=a||function(){return Math.random()},this.defaultColorTexture=i,this.defaultRampTexture=k,this.emitters=[]},hemi.particles.System.prototype.createEmitter=function(a,b){return new hemi.particles.Emitter(this,a,b)},hemi.particles.System.prototype.createTrail=function(a,b,c,d,e){return new hemi.particles.Trail(this,a,b,c,d,e)},hemi.particles.System.prototype.update=function(a){for(var b=0,c=this.emitters.length;b<c;++b)this.emitters[b]._timeParam.value+=a},hemi.particles.Spec=function(){this.numParticles=1,this.numFrames=1,this.frameDuration=1,this.frameStart=0,this.frameStartRange=0,this.timeRange=99999999,this.startTime=null,this.lifeTime=1,this.lifeTimeRange=0,this.startSize=1,this.startSizeRange=0,this.endSize=1,this.endSizeRange=0,this.position=[0,0,0],this.positionRange=[0,0,0],this.velocity=[0,0,0],this.velocityRange=[0,0,0],this.acceleration=[0,0,0],this.accelerationRange=[0,0,0],this.spinStart=0,this.spinStartRange=0,this.spinSpeed=0,this.spinSpeedRange=0,this.colorMult=[1,1,1,1],this.colorMultRange=[0,0,0,0],this.worldVelocity=[0,0,0],this.worldAcceleration=[0,0,0],this.billboard=!0,this.orientation=[0,0,0,1]},hemi.particles.Emitter=function(a,b,c){this._camera=b,this._colorTexture=c||null,this._particleSystem=null,this._rampTexture=null,this._timeParam=null,this.material=new THREE.ShaderMaterial({blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0}),this.material.name="particles",this.shape=new THREE.Geometry,a&&(this._colorTexture=c||a.defaultColorTexture,this._rampTexture=a.defaultRampTexture,this._particleSystem=a,a.emitters.push(this))},hemi.particles.Emitter.prototype.setBlending=function(a){this.material.blending=a},hemi.particles.Emitter.prototype.setColorRamp=function(a){var b=a.length/4;b%1!==0&&hemi.error("colorRamp must have multiple of 4 entries");var c=g(a);this._rampTexture===this._particleSystem.defaultRampTexture||this._rampTexture.image.width!==b?(this._rampTexture=new THREE.DataTexture(c,b,1,THREE.RGBAFormat),this._rampTexture.wrapT=THREE.RepeatWrapping,this._rampTexture.needsUpdate=!0,this.material.uniforms.rampSampler&&(this.material.uniforms.rampSampler.texture=this._rampTexture)):this._rampTexture.image.data=c},hemi.particles.Emitter.prototype.validateParameters=function(a){var b=new hemi.particles.Spec;for(var c in a)typeof b[c]=="undefined"&&hemi.error('unknown particle parameter "'+c+'"');for(c in b)typeof a[c]=="undefined"&&(a[c]=b[c])},hemi.particles.Emitter.prototype.setParameters=function(a,b){e.call(this,a);var f=a.numParticles;c.call(this,f),d.call(this,f,a,b)},hemi.particles.Emitter.prototype.createOneShot=function(a){return new hemi.particles.OneShot(this,a)},hemi.particles.OneShot=function(a,b){this._emitter=a,this._timeOffsetParam=a.material.uniforms.timeOffset,this._transform=new THREE.Mesh(a.shape,a.material),this._transform.doubleSided=!0,this._transform.visible=!1,this._transform.matrixAutoUpdate=!1,b&&b.add(this._transform)},hemi.particles.OneShot.prototype.trigger=function(a,b){b&&b.add(this._transform),a&&(this._transform.position.copy(a),this._transform.updateMatrix()),this._transform.visible=!0,this._timeOffsetParam.value=this._emitter._timeParam.value},hemi.particles.Trail=function(a,b,f,g,h,i){hemi.particles.Emitter.call(this,a,b,h),this._birthIndex=0,this._maxParticles=f,this._parameters=g,this._paramSetter=i,g.startTime=-1,this.shape.dynamic=!0,c.call(this,f),e.call(this,g),d.call(this,f,g,i)},hemi.particles.Trail.prototype=new hemi.particles.Emitter,hemi.particles.Trail.constructor=hemi.particles.Trail,hemi.particles.Trail.prototype.birthParticles=function(a){var b=this._parameters.numParticles,c=this._parameters.positionRange,d=this._timeParam.value;while(this._birthIndex+b>=this._maxParticles){var e=this._maxParticles-this._birthIndex;f.call(this,this._birthIndex,e,d,a,c),b-=e,this._birthIndex=0}f.call(this,this._birthIndex,b,d,a,c),this._birthIndex+=b}})()/*
 * Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 * The MIT License (MIT)
 * 
 * Copyright (c) 2011 SRI International
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated  documentation files (the "Software"), to deal in the Software without restriction,
 * including without limitation the rights to use, copy, modify, merge, publish, distribute,
 * sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or
 * substantial portions of the  Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT
 * NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}());var hemi=hemi||{};(function(){function i(a){var b=null;return Detector.webgl?b=new THREE.WebGLRenderer({antialias:!0}):(Detector.canvas&&(b=new THREE.CanvasRenderer),Detector.addGetWebGLMessage({id:"warn_"+a.id,parent:a}),function(a){setTimeout(function(){var b=document.getElementById("warn_"+a.id);a.removeChild(b)},5e3)}(a)),b}function j(a){requestAnimationFrame(j);var b=(new Date).getTime(),f={elapsedTime:c};while(b-e>d){a=!0,e+=d;for(h=0;h<g.length;++h)g[h].onRender(f)}h=-1;if(a)for(var i=0,k=hemi.clients.length;i<k;++i)hemi.clients[i].onRender(f)}function k(){for(var a=0;a<hemi.clients.length;++a)hemi.clients[a]._resize()}var a=null,b=60,c=1/b,d=c*1e3,e=0,f={},g=[],h=-1;hemi.DEG_TO_RAD=Math.PI/180,hemi.HALF_PI=Math.PI/2,hemi.RAD_TO_DEG=180/Math.PI,hemi.version="2.0.2",hemi.clients=[],hemi._getRenderer=function(a){var b=f[a];if(!b){console.log("No rendererer matches id "+a),b=null;for(var c in f){b=f[c];break}}return b},hemi._makeRenderers=function(){var a=document.getElementsByTagName("div");for(var b=0,c=a.length;b<c;++b){var d=a[b],e=d.id;if(e&&e.match(/^kuda/))if(f[e])console.log("Renderer already exists for id "+e);else{var g=i(d);if(g){var h=g.domElement;d.appendChild(h),h.style.width="100%",h.style.height="100%",hemi.input.init(h),f[e]=g}}}},hemi._resetRenderListeners=function(a){var b=g;return g=a||[],b},hemi.addRenderListener=function(a){g.indexOf(a)===-1&&g.push(a)},hemi.error=function(b){if(!a){var c=new Error(b);throw c.name="HemiError",c}a(b)},hemi.getClient=function(a){var b=a.parent;while(b.parent!==undefined)b=b.parent;for(var c=0,d=hemi.clients.length;c<d;++c){var e=hemi.clients[c];if(b===e.scene)return e}return null},hemi.getFPS=function(){return b},hemi.getTimeOfFrame=function(a){return a*c},hemi.init=function(a){var b=a&&a.resizeHandler?a.resizeHandler:k;window.addEventListener("resize",b,!1),e=(new Date).getTime(),j(!0)},hemi.makeClients=function(a){var b=a&&a.shared?a.shared:{};hemi._makeRenderers();for(var c in f){var d=f[c];if(b[c]){var e=b[c],g=new hemi.SharedClient(!0,e[0]),h=g.scene;d.enableScissorTest(!0),g.setRenderer(d);for(var i=1,j=e.length;i<j;++i)g=new hemi.SharedClient(!1,e[i]),g.setCamera(new hemi.Camera),g.setScene(h),g.setRenderer(d)}else{var g=new hemi.Client(!0);g.setRenderer(d)}}return hemi.init(a),hemi.clients},hemi.removeRenderListener=function(a){var b=g.indexOf(a),c=null;return b!==-1&&(c=g.splice(b,1)[0],b<=h&&h--),c},hemi.setErrorCallback=function(b){a=b},hemi.setFPS=function(a){b=a,c=1/b,d=c*1e3}})(),function(){hemi.utils=hemi.utils||{},hemi.utils.Hashtable=Hashtable,hemi.utils.Hashtable.prototype.query=function(a){var b=this.values(),c=[],d=[],e=[],f,g,h,i,j,k,l,m;for(var n in a)hemi.utils.isArray(a[n])?d.push(n):c.push(n);var o=c.length,p=d.length;for(var q=0,r=b.length;q<r;++q){f=b[q],m=!0;for(j=0;m&&j<o;++j)g=c[j],m=f[g]===a[g];for(j=0;m&&j<p;++j){m=!1,g=d[j],h=f[g],i=a[g],l=i.length;for(k=0;!m&&k<l;++k)m=h===i[k]}m&&e.push(f)}return e}}(),function(){hemi.utils.clone=function(a,b){var c=hemi.utils.isArray(a)?[]:{};return b=b===undefined?!0:b,hemi.utils.join(c,a,b),c},hemi.utils.compareArrays=function(a,b){var c=a.length===b.length;for(var d=0,e=a.length;c&&d<e;++d)hemi.utils.isArray(a[d])?c=hemi.utils.compareArrays(a[d],b[d]):c=Math.abs(a[d]-b[d])<=.001;return c},hemi.utils.get=function(a,b,c){var d=new window.XMLHttpRequest;c&&d.overrideMimeType(c),d.onreadystatechange=function(){if(this.readyState===4){this.onreadystatechange=hemi.utils.noop;var a=null;if(this.status===200||window.location.href.indexOf("http")===-1){var c=this.getResponseHeader("content-type");c&&c.indexOf("xml")>=0?a=this.responseXML:a=this.responseText}b(a,this.statusText)}},d.open("GET",a,!0);try{d.send(null)}catch(e){b(null,e.name+": "+e.message)}},hemi.utils.isArray=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},hemi.utils.isFunction=function(a){return Object.prototype.toString.call(a)==="[object Function]"},hemi.utils.join=function(){var a=arguments[0],b=arguments.length,c=arguments[b-1],d=!0;typeof c=="boolean"&&(d=c,--b);for(var e=1;e<b;e++){var f=arguments[e];for(var g in f){var h=f[g];if(d&&h!=null&&typeof h=="object"){var i=a[g],j=hemi.utils.isArray(h);if(i==null||typeof i!="object"||hemi.utils.isArray(i)!==j)i=j?[]:{};a[g]=hemi.utils.join(i,h)}else a[g]=h}}return a},hemi.utils.noop=function(){}}(),function(){var a=new THREE.Vector3;hemi.utils.cartesianToSpherical=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d),f=Math.acos(c/e),g=Math.atan2(b,d);return[e,f,g]},hemi.utils.choose=function(a,b){return hemi.utils.factorial(a,a-b+1)/hemi.utils.factorial(b)},hemi.utils.clamp=function(a,b,c){return a>c?c:a<b?b:a},hemi.utils.computeNormal=function(b,c,d){var e=(new THREE.Vector3).sub(d,c),f=a.sub(b,c);return e.crossSelf(f),e.isZero()||e.normalize(),e},hemi.utils.cubicHermite=function(a,b,c,d,e){var f=a*a,g=f*a,h=2*g-3*f+1,i=g-2*f+a,j=-2*g+3*f,k=g-f;return h*b+i*c+j*d+k*e},hemi.utils.factorial=function(a,b){var c=1,d=b?b:2;while(d<=a)c*=d++;return c},hemi.utils.intersect=function(a,b){var c=a.direction,d=a.origin,e=b[0],f=b[1],g=b[2],h=hemi.utils.invertMat3([[c.x,f.x-e.x,g.x-e.x],[c.y,f.y-e.y,g.y-e.y],[c.z,f.z-e.z,g.z-e.z]]),i=[d.x-e.x,d.y-e.y,d.z-e.z],j=h[0][0]*i[0]+h[0][1]*i[1]+h[0][2]*i[2],k=h[1][0]*i[0]+h[1][1]*i[1]+h[1][2]*i[2],l=h[2][0]*i[0]+h[2][1]*i[1]+h[2][2]*i[2];return[j,k,l]},hemi.utils.invertMat3=function(a){var b=a[1][1]*a[2][2]-a[1][2]*a[2][1],c=a[0][1]*a[2][2]-a[0][2]*a[2][1],d=a[0][1]*a[1][2]-a[0][2]*a[1][1],e=1/(a[0][0]*b-a[1][0]*c+a[2][0]*d);return[[e*b,-e*c,e*d],[-e*(a[1][0]*a[2][2]-a[1][2]*a[2][0]),e*(a[0][0]*a[2][2]-a[0][2]*a[2][0]),-e*(a[0][0]*a[1][2]-a[0][2]*a[1][0])],[e*(a[1][0]*a[2][1]-a[1][1]*a[2][0]),-e*(a[0][0]*a[2][1]-a[0][1]*a[2][0]),e*(a[0][0]*a[1][1]-a[0][1]*a[1][0])]]},hemi.utils.lerp=function(a,b,c){var d;if(hemi.utils.isArray(a)){d=[];for(var e=0,f=a.length;e<f;++e)d[e]=hemi.utils.lerp(a[e],b[e],c)}else d=a+(b-a)*c;return d},hemi.utils.lerpVec3=function(a,b,c,d){return d=d||new THREE.Vector3,d.x=hemi.utils.lerp(a.x,b.x,c),d.y=hemi.utils.lerp(a.y,b.y,c),d.z=hemi.utils.lerp(a.z,b.z,c),d},hemi.utils.linearToExponential=function(a,b){return(Math.pow(b,a)-1)/(b-1)},hemi.utils.linearToExponentialInverse=function(a,b){return 1-hemi.utils.linearToExponential(1-a,b)},hemi.utils.linearToParabolic=function(a){return a*a},hemi.utils.linearToParabolicInverse=function(a){return 1-(1-a)*(1-a)},hemi.utils.linearToSine=function(a){return(Math.sin(Math.PI*a-hemi.HALF_PI)+1)/2},hemi.utils.penner={linearTween:function(a,b,c,d){return c*a/d+b},easeInQuad:function(a,b,c,d){return a/=d,c*a*a+b},easeOutQuad:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},easeInOutQuad:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a+b:(a--,-c/2*(a*(a-2)-1)+b)},easeInCubic:function(a,b,c,d){return a/=d,c*a*a*a+b},easeOutCubic:function(a,b,c,d){return a/=d,a--,c*(a*a*a+1)+b},easeInOutCubic:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a+b:(a-=2,c/2*(a*a*a+2)+b)},easeInQuart:function(a,b,c,d){return a/=d,c*a*a*a*a+b},easeOutQuart:function(a,b,c,d){return a/=d,a--,-c*(a*a*a*a-1)+b},easeInOutQuart:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a*a+b:(a-=2,-c/2*(a*a*a*a-2)+b)},easeInQuint:function(a,b,c,d){return a/=d,c*a*a*a*a*a+b},easeOutQuint:function(a,b,c,d){return a/=d,a--,c*(a*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a*a*a+b:(a-=2,c/2*(a*a*a*a*a+2)+b)},easeInSine:function(a,b,c,d){return-c*Math.cos(a/d*hemi.HALF_PI)+c+b},easeOutSine:function(a,b,c,d){return c*Math.sin(a/d*hemi.HALF_PI)+b},easeInOutSine:function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},easeInExpo:function(a,b,c,d){return c*Math.pow(2,10*(a/d-1))+b},easeOutExpo:function(a,b,c,d){return c*(-Math.pow(2,-10*a/d)+1)+b},easeInOutExpo:function(a,b,c,d){return a/=d/2,a<1?c/2*Math.pow(2,10*(a-1))+b:(a--,c/2*(-Math.pow(2,-10*a)+2)+b)},easeInCirc:function(a,b,c,d){return a/=d,-c*(Math.sqrt(1-a*a)-1)+b},easeOutCirc:function(a,b,c,d){return a/=d,a--,c*Math.sqrt(1-a*a)+b},easeInOutCirc:function(a,b,c,d){return a/=d/2,a<1?-c/2*(Math.sqrt(1-a*a)-1)+b:(a-=2,c/2*(Math.sqrt(1-a*a)+1)+b)}},hemi.utils.quaternionToVector3=function(a){return(new THREE.Vector3).getRotationFromMatrix((new THREE.Matrix4).setRotationFromQuaternion(a))},hemi.utils.sphericalToCartesian=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sin(c);return[b*e*Math.cos(d),b*e*Math.sin(d),b*Math.cos(c)]},hemi.utils.uvToXYZ=function(b,c){var d=c[0],e=c[1],f=c[2],g=(new THREE.Vector3).sub(e,d).multiplyScalar(b[0]),h=a.sub(f,d).multiplyScalar(b[1]);return g.addSelf(h).addSelf(d)},hemi.utils.worldToScreen=function(a,b){var c=a.camera.threeCamera;c.matrixWorldInverse.multiplyVector3(b);var d=b.z;c.projectionMatrix.multiplyVector3(b);var e=b.x,f=b.y;return d>0&&(e=-e,f=-f),b.x=(1+e)*.5*a.getWidth(),b.y=(1-f)*.5*a.getHeight(),new THREE.Vector2(Math.round(b.x),Math.round(b.y))},hemi.utils.worldToScreenFloat=function(a,b){var c=a.camera.threeCamera;c.matrixWorldInverse.multiplyVector3(b);var d=b.z;c.projectionMatrix.multiplyVector3(b);var e=b.x,f=b.y;return d>0&&(e=-e,f=-f),b.x=(1+e)*.5*a.getWidth(),b.y=(1-f)*.5*a.getHeight(),b}}(),function(){function a(a,b,c){var d=hemi.utils.parseSrc(a,c);return hemi.utils.join(d,b),hemi.utils.buildSrc(d)}hemi.utils.buildSrc=function(a){var b=(a.preHdr?a.preHdr:"")+(a.hdr?a.hdr:"")+(a.postHdr?a.postHdr:"")+(a.preSprt?a.preSprt:"")+(a.sprt?a.sprt:"")+(a.postSprt?a.postSprt:"")+a.main+(a.preBody?a.preBody:"")+(a.body?a.body:"")+(a.postBody?a.postBody:"")+(a.preGlob?a.preGlob:"")+(a.glob?a.glob:"")+(a.postGlob?a.postGlob:"")+a.end;return b},hemi.utils.combineFragSrc=function(b,c){return a(b,c,"gl_FragColor")},hemi.utils.combineVertSrc=function(b,c){return a(b,c,"gl_Position")},hemi.utils.getShaders=function(a,b){var c=a.renderer.context,d=b.program,e=c.getAttachedShaders(d),f=c.getShaderSource(e[0]),g=c.getShaderSource(e[1]),h;return f.search("gl_FragColor")>0?h={fragShd:e[0],fragSrc:f,vertShd:e[1],vertSrc:g}:h={fragShd:e[1],fragSrc:g,vertShd:e[0],vertSrc:f},h},hemi.utils.parseSrc=function(a,b){var c=a.lastIndexOf(";",a.indexOf("{"))+1,d=a.indexOf("void main",c),e=a.indexOf("{",d)+1,f=a.lastIndexOf(b),g=a.lastIndexOf("}");a.charAt(c)==="\n"&&++c,a.charAt(e)==="\n"&&++e,a.charAt(f)==="\n"&&++f,a.charAt(g)==="\n"&&++g;var h={hdr:a.slice(0,c),sprt:a.slice(c,d),main:a.slice(d,e),body:a.slice(e,f),glob:a.slice(f,g),end:a.slice(g)};return h}}(),function(){function b(b,c,d){var e=c,f=0,g=b.length,h=c-Math.max(c-d,0),i=Math.min(c+d,g-1)-c,j,k;for(var l=parseInt(c-h,10);l<=c+i;++l){k=a[b.charAt(l)];if(k===undefined)continue;j=k/Math.abs(c-l),j>f&&(e=l,f=j)}return Math.min(e+1,g-1)}function c(a){return a.replace("\n"," ")}var a={" ":10,",":20,";":30,".":10,"!":40,"?":40};hemi.utils.capitalize=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},hemi.utils.isNumeric=function(a){return a!==null&&!isNaN(a)&&a.length!==0},hemi.utils.trim=function(a){return a.replace(/^\s*/,"").replace(/\s*$/,"")},hemi.utils.wrapText=function(a,d,e){a=c(a);var f=[],g=a.length,h=parseInt(d/e,10),i=Math.ceil(g/h),j=h,k=0,l;for(var m=0;m<i-1;++m)l=k,k=b(a,j,10),f.push(hemi.utils.trim(a.substring(l,k))),j=k+h;return f.push(a.substring(k,g)),f},hemi.utils.wrapTextStrict=function(b,d,e){b=c(b);var f=[],g=b.length,h=e.measureText(b),i=h.width/g,j=Math.floor(d/i),k=Math.ceil(j/10),l=0,m=j,n,o;while(m<g){n=hemi.utils.trim(b.substring(l,m)),h=e.measureText(n),o=h.width;while(o<d&&m<g)m+=k,m>g&&(m=g),n=hemi.utils.trim(b.substring(l,m)),h=e.measureText(n),o=h.width;while(o>d)m--,n=hemi.utils.trim(b.substring(l,m)),h=e.measureText(n),o=h.width;var p=m-1,q=b.charAt(p);while(a[q]===undefined&&p>l)p--,q=b.charAt(p);p>l&&(m=p+1),n=hemi.utils.trim(b.substring(l,m)),f.push(n),l=m,m+=j}if(l!==g||f.length===0)n=hemi.utils.trim(b.substring(l,g)),f.push(n);return f}}(),function(){function d(a,b){var c=b.x,d=b.y,e=b.z;return b.x=a.m[0]*c+a.m[3]*d+a.m[6]*e,b.y=a.m[1]*c+a.m[4]*d+a.m[7]*e,b.z=a.m[2]*c+a.m[5]*d+a.m[8]*e,b}function e(a,b){var d=b.x,e=b.y,f=b.z;return c.set(d*a.n11+e*a.n21+f*a.n31,d*a.n12+e*a.n22+f*a.n32,d*a.n13+e*a.n23+f*a.n33)}function f(a){var b=a.geometryGroupsList;for(var c=0,d=b.length;c<d;++c){var e=b[c],f=e.faces3.length*3+e.faces4.length*4;e.__uvArray=new Float32Array(f*2),e.__inittedArrays=!0}a.__dirtyUvs=!0}function g(a){if(a.__webglInit){var b=a.geometry,c=a.parent;while(c.parent!==undefined)c=c.parent;b.dynamic=!0,delete b.geometryGroupsList[0].__webglVertexBuffer,a.__webglInit=!1,c.__objectsAdded.push(a)}}var a=new THREE.Matrix4,b=new THREE.Quaternion,c=new THREE.Vector3;hemi.utils.axisRotate=function(a,d,e){e.useQuaternion?(b.setFromAxisAngle(a,d),e.quaternion.multiplySelf(b)):(c.copy(a).multiplyScalar(d),e.rotation.addSelf(c)),e.updateMatrix(),e.updateMatrixWorld(!0)},hemi.utils.centerGeometry=function(b){var c=THREE.GeometryUtils.center(b.geometry);c.multiplySelf(b.scale),b.useQuaternion?b.quaternion.multiplyVector3(c):(a.setRotationFromEuler(b.rotation,b.eulerOrder),c=e(a,c)),b.position.subSelf(c),b.updateMatrix(),b.updateMatrixWorld(!0),g(b)},hemi.utils.cloneMaterial=function(a){var b=new a.constructor,c=["fragmentShader","id","program","uniforms","uniformsList","vertexShader"];for(var d in a){var e=a[d];!hemi.utils.isFunction(e)&&c.indexOf(d)===-1&&(b[d]=e)}return b.name=b.name+"_clone",b},hemi.utils.pointAsLocal=function(b,c){var d=a.getInverse(b.matrixWorld);return d.multiplyVector3(c)},hemi.utils.pointAsWorld=function(a,b){return a.matrixWorld.multiplyVector3(b)},hemi.utils.pointYAt=function(a,b,c){var d=c.x-b.x,e=c.y-b.y,f=c.z-b.z,g=Math.sqrt(d*d+f*f),h=Math.atan2(d,f),i=Math.atan2(g,e);return a.rotation.y+=h,a.rotation.x+=i,a.updateMatrix(),a.updateMatrixWorld(!0),a},hemi.utils.pointZAt=function(a,b,d){var e=c.sub(d,b),f=Math.atan2(e.x,e.z),g=-Math.asin(e.y/e.length());return a.rotation.y+=f,a.rotation.x+=g,a.updateMatrix(),a.updateMatrixWorld(!0),a},hemi.utils.rotateUVs=function(a,b){var c=a.faceVertexUvs[0],d=Math.cos(b),e=Math.sin(b);for(var g=0,h=c.length;g<h;++g){var i=c[g];for(var j=0,k=i.length;j<k;++j){var l=i[j],m=l.u,n=l.v;l.u=m*d-n*e,l.v=m*e+n*d}}f(a)},hemi.utils.scaleUVs=function(a,b,c){var d=a.faceVertexUvs[0];for(var e=0,g=d.length;e<g;++e){var h=d[e];for(var i=0,j=h.length;i<j;++i)h[i].u*=b,h[i].v*=c}f(a)},hemi.utils.scrubTriangles=function(a,b){b===undefined&&(b=1e-5);if(a.geometry){var c=a.geometry,d=c.vertices,e=c.faces;for(var f=e.length-1;f>=0;--f){var g=e[f];if(g instanceof THREE.Face3){var h=d[g.a].position,i=d[g.b].position,j=d[g.c].position,k=THREE.GeometryUtils.triangleArea(h,i,j);if(k<b){e.splice(f,1);for(var l=0,m=c.faceUvs.length;l<m;++l){var n=c.faceUvs[l];f<n.length&&n.splice(f,1)}for(var l=0,m=c.faceVertexUvs.length;l<m;++l){var n=c.faceVertexUvs[l];f<n.length&&n.splice(f,1)}}}else if(g instanceof THREE.Face4){var h=d[g.a].position,i=d[g.b].position,j=d[g.c].position,o=d[g.d].position,p=THREE.GeometryUtils.triangleArea(h,i,o),q=THREE.GeometryUtils.triangleArea(i,j,o);if(p<=b)if(q<=b){e.splice(f,1);for(var l=0,m=c.faceUvs.length;l<m;++l){var n=c.faceUvs[l];f<n.length&&n.splice(f,1)}for(var l=0,m=c.faceVertexUvs.length;l<m;++l){var n=c.faceVertexUvs[l];f<n.length&&n.splice(f,1)}}else{var r=new THREE.Face3(g.b,g.c,g.d,g.normal,g.color,g.materialIndex);g.vertexNormals.length>0&&(r.vertexNormals[0]=g.vertexNormals[1],r.vertexNormals[1]=g.vertexNormals[2],r.vertexNormals[2]=g.vertexNormals[3]),g.vertexColors.length>0&&(r.vertexColors[0]=g.vertexColors[1],r.vertexColors[1]=g.vertexColors[2],r.vertexColors[2]=g.vertexColors[3]),e[f]=r;for(var l=0,m=c.faceUvs.length;l<m;++l){var n=c.faceUvs[l];f<n.length&&n[f].shift()}for(var l=0,m=c.faceVertexUvs.length;l<m;++l){var n=c.faceVertexUvs[l];f<n.length&&n[f].shift()}}else if(q<=b){var r=new THREE.Face3(g.a,g.b,g.d,g.normal,g.color,g.materialIndex);g.vertexNormals.length>0&&(r.vertexNormals[0]=g.vertexNormals[0],r.vertexNormals[1]=g.vertexNormals[1],r.vertexNormals[2]=g.vertexNormals[3]),g.vertexColors.length>0&&(r.vertexColors[0]=g.vertexColors[0],r.vertexColors[1]=g.vertexColors[1],r.vertexColors[2]=g.vertexColors[3]),e[f]=r;for(var l=0,m=c.faceUvs.length;l<m;++l){var n=c.faceUvs[l];f<n.length&&n[f].splice(2,1)}for(var l=0,m=c.faceVertexUvs.length;l<m;++l){var n=c.faceVertexUvs[l];f<n.length&&n[f].splice(2,1)}}}}}var s=a.children;for(var f=0,t=s.length;f<t;++f)this.scrubTriangles(s[f],b)},hemi.utils.translateGeometry=function(b,c){b.geometry.applyMatrix(a.makeTranslation(c.x,c.y,c.z)),b.geometry.computeBoundingBox(),c.multiplySelf(b.scale),b.useQuaternion?b.quaternion.multiplyVector3(c):(a.setRotationFromEuler(transform.rotation,transform.eulerOrder),c=e(a,c)),b.position.subSelf(c),b.updateMatrix(),b.updateMatrixWorld(!0),g(b)},hemi.utils.translateUVs=function(a,b,c){var d=a.faceVertexUvs[0];for(var e=0,g=d.length;e<g;++e){var h=d[e];for(var i=0,j=h.length;i<j;++i)h[i].u+=b,h[i].v+=c}f(a)},hemi.utils.useEuler=function(b){b.useQuaternion&&(a.setRotationFromQuaternion(b.quaternion),b.rotation.getRotationFromMatrix(a),b.useQuaternion=!1)},hemi.utils.validateTriangles=function(a){function b(a){return"["+a.x+", "+a.y+", "+a.z+"]"}if(a.geometry){var c=a.geometry.vertices,d=a.geometry.faces;for(var e=0,f=d.length;e<f;++e){var g=d[e];if(g instanceof THREE.Face3){var h=c[g.a].position,i=c[g.b].position,j=c[g.c].position,k=THREE.GeometryUtils.triangleArea(h,i,j);k<1e-4&&(console.log("Zero area triangle: face "+e+" of "+a.name),console.log("Verts: "+b(h)+", "+b(i)+", "+b(j)))}else if(g instanceof THREE.Face4){var h=c[g.a].position,i=c[g.b].position,j=c[g.c].position,l=c[g.d].position,k=THREE.GeometryUtils.triangleArea(h,i,l);k<1e-4&&(console.log("Zero area triangle (in quad): face "+e+" of "+a.name),console.log("Verts: "+b(h)+", "+b(i)+", "+b(l))),k=THREE.GeometryUtils.triangleArea(i,j,l),k<1e-4&&(console.log("Zero area triangle (in quad): face "+e+" of "+a.name),console.log("Verts: "+b(i)+", "+b(j)+", "+b(l)))}}}var m=a.children;for(var e=0,f=m.length;e<f;++e)this.validateTriangles(m[e])},hemi.utils.vector3Equals=function(a,b,c){return c||(c=0),Math.abs(a.x-b.x)<=c&&Math.abs(a.y-b.y)<=c&&Math.abs(a.z-b.z)<=c},hemi.utils.worldRotate=function(b,c,d){var f=a.getInverse(d.parent.matrixWorld),g=e(f,b);hemi.utils.axisRotate(g,c,d)},hemi.utils.worldScale=function(a,b){var e=THREE.Matrix4.makeInvert3x3(b.parent.matrixWorld);c.copy(a),b.scale.multiplySelf(d(e,c)),b.updateMatrix(),b.updateMatrixWorld(!0)},hemi.utils.worldTranslate=function(b,c){var d=a.getInverse(c.parent.matrixWorld),f=e(d,b);c.position.addSelf(f),c.updateMatrix(),c.updateMatrixWorld(!0)},hemi.utils.decompose=function(a){var b=a.scale.clone(),c=a,d=(new THREE.Matrix4).copy(a.matrixWorld),e=a.useQuaternion?new THREE.Quaternion:new THREE.Vector3,f=new THREE.Vector3(d.n14,d.n24,d.n34);while(c.parent)b.multiplySelf(c.parent.scale),c=c.parent;return d.n11/=b.x,d.n21/=b.x,d.n31/=b.x,d.n12/=b.y,d.n22/=b.y,d.n32/=b.y,d.n13/=b.z,d.n23/=b.z,d.n33/=b.z,e instanceof THREE.Quaternion?e.setFromRotationMatrix(d):e.getRotationFromMatrix(d),{translation:f,rotation:e,scale:b}}}(),function(){hemi.msg={animate:"hemi.animate",burst:"hemi.burst",cleanup:"hemi.cleanup",enable:"hemi.enable",keyDown:"hemi.keyDown",keyPress:"hemi.keyPress",keyUp:"hemi.keyUp",load:"hemi.load",move:"hemi.move",pick:"hemi.pick",progress:"hemi.progress",ready:"hemi.ready",resize:"hemi.resize",start:"hemi.start",stop:"hemi.stop",unload:"hemi.unload",visible:"hemi.visible",worldCleanup:"hemi.worldCleanup"}}(),function(){function d(){--c===0&&(c=1,hemi.send(hemi.msg.ready,{}),b&&(b(),b=null))}function e(){var b=a.size(),c=a.values(),d=0;for(var e=0;e<b;e++){var f=c[e];d+=f.percent/b}return hemi.send(hemi.msg.progress,{task:"Total Progress",isTotal:!0,percent:d}),d>=99.9&&a.clear(),d}function f(a,b,e){a=hemi.getLoadPath(a),++c,hemi.createTask(a),e.load(a,function(c){b&&b(c),hemi.updateTask(a,100),d()})}var a=new Hashtable,b=null,c=1;hemi.loadPath="",hemi.getLoadPath=function(a){return a.substr(0,4)==="http"?a:hemi.loadPath+a},hemi.loadHtml=function(a,b){a=hemi.getLoadPath(a),hemi.utils.get(a,function(a,c){a===null?hemi.error(c):b(a)})},hemi.loadCollada=function(a,b,e){var f=new THREE.ColladaLoader;e&&hemi.utils.join(f.options,e),a=hemi.getLoadPath(a),++c,hemi.createTask(a),f.load(a,function(c){b&&b(c),hemi.updateTask(a,100),d()},function(b){b.loaded!==null&&b.total!==null&&hemi.updateTask(a,b.loaded/b.total*100)})},hemi.loadUTF8=function(a,b,e){var f=new THREE.UTF8Loader;a=hemi.getLoadPath(a),++c,hemi.createTask(a),f.load(a,function(c){b&&b(c),hemi.updateTask(a,100),d()},e)},hemi.loadJson=function(a,b){var c=new THREE.JSONLoader;f(a,b,c)},hemi.loadBinary=function(a,b){var c=new THREE.BinaryLoader;f(a,b,c)},hemi.loadImage=function(a,b){var e=new Image;++c,e.onabort=function(){hemi.error("Aborted loading: "+a),d()},e.onerror=function(){hemi.error("Error loading: "+a),d()},e.onload=function(){b(e),d()},e.src=hemi.getLoadPath(a)},hemi.loadOctane=function(a,b){a=hemi.getLoadPath(a),++c,hemi.utils.get(a,function(a,c){d();if(a===null)hemi.error(c);else{typeof a=="string"&&(a=JSON.parse(a)),a.type||(hemi._makeRenderers(),hemi.init());var e=hemi.fromOctane(a);a.type||hemi.ready(),b&&b(e)}},"application/json")},hemi.loadTexture=function(a,b){hemi.loadImage(a,function(c){hemi.updateTask(a,100);var d=new THREE.Texture(c);d.needsUpdate=!0,b(d)}),hemi.createTask(a)},hemi.loadTextureSync=function(a,b){var e=new Image,f=new THREE.Texture(e);return++c,e.onabort=function(){hemi.error("Aborted loading: "+a),d()},e.onerror=function(){hemi.error("Error loading: "+a),d()},e.onload=function(){f.needsUpdate=!0,b(f),d()},e.src=hemi.getLoadPath(a),f},hemi.ready=d,hemi.resetLoadTasks=function(a){b=a,c=1},hemi.createTask=function(b){if(a.get(b)!==null)return!1;var c={percent:0};return a.put(b,c),e(),!0},hemi.updateTask=function(b,c){var d=a.get(b),f=d!==null;return f&&(d.percent=c,hemi.send(hemi.msg.progress,{task:b,percent:c,isTotal:!1}),e()),f}}(),function(){function d(){return this._worldId}function e(a){var c=this._worldId;this._worldId=a,c!==null&&(b.remove(c),b.put(a,this))}function f(a,b){hemi.dispatch.postMessage(this,a,b)}function g(a,b,c,d){return hemi.dispatch.registerTarget(this._worldId,a,b,c,d)}function h(a,b,c){return hemi.dispatch.registerTarget(this._worldId,hemi.dispatch.WILDCARD,a,b,c)}function i(a,b){return hemi.dispatch.removeTarget(a,{src:this._worldId,msg:b})}function j(a,b){var c=b.split("."),d=c.length-1,e=window;for(var f=0;f<d;++f){var g=c[f];e[g]||(e[g]={}),e=e[g]}e[c[d]]=a}var a={},b=new hemi.utils.Hashtable,c=1;hemi._resetCitizens=function(a){var c=b;return b=a||new hemi.utils.Hashtable,c},hemi.getBaseClass=function(b){return a[b]},hemi.makeCitizen=function(b,c,k){function m(){b.apply(this,arguments),this.name=this.name||"",this._worldId=null,hemi.world.addCitizen(this)}k=k||{},a[c]=b;var l=k.cleanup;return m.prototype=b.prototype,m.prototype.cleanup=function(){this.send(hemi.msg.cleanup,{}),l&&l.apply(this,arguments),hemi.dispatch.removeSpecs({src:this._worldId},!1),hemi.dispatch.removeTargets({handler:this},!1),hemi.world.removeCitizen(this)},m.prototype._getId=d,m.prototype._setId=e,m.prototype.send=f,m.prototype.subscribe=g,m.prototype.subscribeAll=h,m.prototype.unsubscribe=i,m.constructor=m,m.prototype._msgSent&&m.prototype._msgSent.push(hemi.msg.cleanup),hemi.makeOctanable(m,c,k.toOctane||[]),j(m,c),m},hemi.world=hemi.world||{},hemi.world.addCitizen=function(a){var d=a._getId();d===null?(d=this.getNextId(),a._setId(d)):d>=c&&(c=d+1);var e=b.get(d);e!==null&&(console.log("Citizen with id "+d+" already exists."),e.cleanup()),b.put(d,a)},hemi.world.checkNextId=function(){return c},hemi.world.cleanup=function(){hemi.resetLoadTasks(),hemi.send(hemi.msg.worldCleanup,{}),b.each(function(a,b){b.cleanup()}),b.size()>0&&console.log("World cleanup did not remove all citizens."),c=1},hemi.world.getAnimationGroups=function(a,b){return a=a||{},a._octaneType=hemi.AnimationGroup.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getAudio=function(a,b){return a=a||{},a._octaneType=hemi.Audio.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getCamCurves=function(a,b){return a=a||{},a._octaneType=hemi.CameraCurve.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getCitizenById=function(a){var c=b.get(a);return c===null&&console.log("Tried to get Citizen with id "+a+", returned null."),c},hemi.world.getCitizens=function(a,c){var d=b.query(a||{});if(c)for(var e=0,f=d.length;e<f;++e)c(d[e])||(d.splice(e,1),--e,--f);return d},hemi.world.getHudDisplays=function(a,b){return a=a||{},a._octaneType=hemi.HudDisplay.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getMeshes=function(a,b){return a=a||{},a._octaneType=hemi.Mesh.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getModels=function(a,b){return a=a||{},a._octaneType=hemi.Model.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getNextId=function(){return c++},hemi.world.getParticleEffects=function(a,b){a=a||{},a._octaneType=hemi.ParticleEmitter.prototype._octaneType;var c=this.getCitizens(a,b);return a._octaneType=hemi.ParticleBurst.prototype._octaneType,c=c.concat(this.getCitizens(a,b)),a._octaneType=hemi.ParticleTrail.prototype._octaneType,c=c.concat(this.getCitizens(a,b)),c},hemi.world.getShapes=function(a,b){return a=a||{},a._octaneType=hemi.Shape.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getStates=function(a,b){return a=a||{},a._octaneType=hemi.State.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getTimers=function(a,b){return a=a||{},a._octaneType=hemi.Timer.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getTransforms=function(a,b){return a=a||{},a._octaneType=hemi.Transform.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getViewpoints=function(a,b){return a=a||{},a._octaneType=hemi.Viewpoint.prototype._octaneType,this.getCitizens(a,b)},hemi.world.getLights=function(a,b){return a=a||{},a._octaneType=hemi.Light.prototype._octaneType,this.getCitizens(a,b)},hemi.world.removeCitizen=function(a){var c=a._getId(),d=b.remove(c);return d===null&&console.log("Unable to remove Citizen with id "+c),d!==null},hemi.world.setNextId=function(a){c=a},hemi.world.toOctane=function(a){var d={version:hemi.version,nextId:c,citizens:[]};return b.each(function(b,c){var e=a?a(c):!0;if(e){var f=c._toOctane();f!==null?d.citizens.push(f):console.log("Null Octane returned by Citizen with id "+c._getId())}}),d.dispatch=hemi.dispatch._toOctane(),d}}(),function(){function b(b){if(!b.type)return alert("Unable to process octane: missing type"),null;var c=a[b.type],d=null;return c?(d=new c,b.id!==undefined&&d._setId(b.id)):console.log("Cannot find constructor for type: "+b.type),d}function c(a,b){var c=[];for(var d=0,e=b.length;d<e;++d){var f=b[d],g=a[f],h={name:f};if(!g)h.val=g;else if(hemi.utils.isFunction(g))h.arg=[];else if(hemi.utils.isArray(g))if(g.length>0){var i=g[0];if(i._getId&&i._worldId){h.id=[];for(var j=0;j<g.length;++j)h.id[j]=g[j]._getId()}else if(i._toOctane){h.oct=[];for(var j=0;j<g.length;++j)h.oct[j]=g[j]._toOctane()}else h.val=g}else h.val=g;else g._getId&&g._worldId?h.id=g._getId():g._toOctane?h.oct=g._toOctane():h.val=g;c.push(h)}return c}function d(a,c){for(var e=0,f=c.props.length;e<f;++e){var g=c.props[e],h=g.name;if(g.oct!==undefined){if(hemi.utils.isArray(g.oct)){l=[];for(var i=0,j=g.oct.length;i<j;++i){var k=b(g.oct[i]);d(k,g.oct[i]),l.push(k)}}else l=b(g.oct),d(l,g.oct);a[h]=l}else if(g.val!==undefined)a[h]=g.val;else if(g.id!==undefined){var l;if(hemi.utils.isArray(g.id)){l=[];for(var i=0,j=g.id.length;i<j;++i)l.push(hemi.world.getCitizenById(g.id[i]))}else l=hemi.world.getCitizenById(g.id);a[h]=l}else if(g.arg!==undefined){var m=a[h],n=hemi.dispatch.getArguments(null,g.arg);m.apply(a,n)}else alert("Unable to process octane for "+c.id+": missing property value")}}var a={};hemi.fromOctane=function(a){var c=null;if(a.type)c=b(a),d(c,a);else{hemi.world.cleanup();var e=a.citizens.length;hemi.world.setNextId(e*-2);for(var f=0;f<e;++f)b(a.citizens[f]);hemi.world.setNextId(a.nextId);var g=a.dispatch.ents,h=[];for(var f=0,i=g.length;f<i;++f){var j=b(g[f]);d(j,g[f]),h.push(j)}hemi.dispatch.loadEntries(h),hemi.dispatch.setNextId(a.dispatch.nextId);for(var f=0;f<e;++f){var k=a.citizens[f];d(hemi.world.getCitizenById(k.id),k)}}return c},hemi.makeOctanable=function(b,d,e){e=e||[],a[d]=b,b.prototype._octaneType=d,b.prototype._toOctane=function(){var a=hemi.utils.isFunction(e)?e.call(this):c(this,e),b=null;return a!==null&&(b={type:this._octaneType,props:a},this._worldId!==undefined&&(b.id=this._worldId),this.name&&this.name.length>0&&!b.props.name&&b.props.unshift({name:"name",val:this.name})),b}}}(),function(){function b(){this.looping?this.audio.setAttribute("loop","loop"):this.audio.removeAttribute("loop")}var a=function(){this._seeking=!1,this._startPlay=!1,this._urls=[],this.audio=document.createElement("audio"),this.looping=!1;var a=this;this.audio.addEventListener("emptied",function(b){a.send(hemi.msg.unload,{})},!0),this.audio.addEventListener("loadeddata",function(b){a.send(hemi.msg.load,{src:a.audio.currentSrc})},!0),this.audio.addEventListener("playing",function(b){a.send(hemi.msg.start,{})},!0),this.audio.addEventListener("ended",function(b){a.looping&&a.play(),a.send(hemi.msg.stop,{})},!0)};a.prototype._clean=function(){this.audio=null,this._urls=[]},a.prototype._msgSent=[hemi.msg.load,hemi.msg.start,hemi.msg.stop,hemi.msg.unload],a.prototype._octane=function(){var a=[{name:"looping",val:this.looping}];for(var b=0,c=this._urls.length;b<c;++b){var d=this._urls[b];a.push({name:"addUrl",arg:[d.url,d.type]})}return a},a.prototype.addUrl=function(a,b){var c=document.createElement("source"),d=hemi.getLoadPath(a);c.setAttribute("src",d),c.setAttribute("type","audio/"+b),this.audio.appendChild(c),this._urls.push({url:a,type:b,node:c})},a.prototype.getDuration=function(){return this.audio?this.audio.duration:null},a.prototype.getVolume=function(){return this.audio?this.audio.volume:null},a.prototype.pause=function(){this.audio&&!this.audio.paused&&(this.audio.pause(),this._startPlay=!1)},a.prototype.play=function(){this.audio&&(this._seeking?this._startPlay=!0:(this.audio.paused||this.audio.ended)&&this.audio.play())},a.prototype.removeUrl=function(a){for(var b=0,c=this._urls.length;b<c;++b){var d=this._urls[b];if(d.url===a){this.audio.removeChild(d.node),this._urls.splice(b,1),d.node.src===this.audio.currentSrc&&this.audio.load();break}}},a.prototype.seek=function(a){if(this.audio&&a>=0&&a<this.audio.duration){var b=this,c=function(){b.audio.removeEventListener("seeked",c,!0),b._seeking=!1,b._startPlay&&(b._startPlay=!1,b.play())};this.audio.addEventListener("seeked",c,!0),this._seeking=!0,this._startPlay=!this.audio.paused,this.audio.currentTime=a}},a.prototype.setLoop=function(a){this.looping!==a&&(this.looping=a,!this.audio)},a.prototype.setVolume=function(a){this.audio&&(this.audio.volume=a)},hemi.makeCitizen(a,"hemi.Audio",{cleanup:a.prototype._clean,toOctane:a.prototype._octane})}(),function(){function g(b,c){var d=hemi.dispatch.getSpecsFast(b,c,!1),e;return d.length===0?(e=new hemi.dispatch.MessageSpec,e.src=b,e.msg=c,a.put(e.getHash(),e)):(d.length>1&&console.log("Found "+d.length+" MessageSpecs with the same src and msg."),e=d[0]),e}var a=new hemi.utils.Hashtable,b=0;hemi.dispatch=hemi.dispatch||{},hemi.dispatch.WILDCARD="*",hemi.dispatch.ID_ARG="id:",hemi.dispatch.MSG_ARG="msg:";var c=function(){this.src=null,this.msg=null,this.data={}};hemi.dispatch.Message=c;var d=function(){this.src=null,this.msg=null,this.targets=[]};d.prototype._octane=function(){var a=[];for(var b=0,c=this.targets.length;b<c;++b){var d=this.targets[b]._toOctane();d!==null?a.push(d):console.log("Null Octane returned by MessageTarget")}return[{name:"src",val:this.src},{name:"msg",val:this.msg},{name:"targets",oct:a}]},d.prototype.addTarget=function(a){this.targets.indexOf(a)!==-1&&console.log("MessageSpec already contains MessageTarget"),this.targets.push(a)},d.prototype.cleanup=function(){for(var a=0,b=this.targets.length;a<b;++a)this.targets[a].cleanup();this.targets=[]},d.prototype.removeTarget=function(a){var b=null,c=this.targets.indexOf(a);return c!==-1?b=this.targets.splice(c,1)[0]:console.log("MessageTarget not found in MessageSpec"),b},d.prototype.getHash=function(){return this.msg+this.src},hemi.dispatch.MessageSpec=d,hemi.makeOctanable(hemi.dispatch.MessageSpec,"hemi.dispatch.MessageSpec",hemi.dispatch.MessageSpec.prototype._octane);var e=function(){this._dispatchId=null,this.name="",this.handler=null,this.func=null,this.args=null};e.prototype._octane=function(){if(!this.handler._getId)return console.log("Handler object in MessageTarget can not be saved to Octane"),null;var a=["_dispatchId","name","func","args"],b=[{name:"handler",id:this.handler._getId()}];for(var c=0,d=a.length;c<d;++c){var e=a[c];b.push({name:e,val:this[e]})}return b},e.prototype.cleanup=function(){this.handler=null},hemi.dispatch.MessageTarget=e,hemi.makeOctanable(hemi.dispatch.MessageTarget,"hemi.dispatch.MessageTarget",hemi.dispatch.MessageTarget.prototype._octane),hemi.dispatch._toOctane=function(){var c={nextId:b,ents:[]};return a.each(function(a,b){var d=b._toOctane();d!==null?c.ents.push(d):console.log("Null Octane returned by MessageSpec")}),c},hemi.dispatch.checkNextId=function(){return b},hemi.dispatch.cleanup=function(){a.each(function(a,b){b.cleanup()}),a.clear()},hemi.dispatch.getNextId=function(){return b++},hemi.dispatch.getSpecs=function(b,c){var d;if(b===undefined)d=a.values();else{var e={};c?(b.src!==undefined&&(b.src===hemi.dispatch.WILDCARD?e.src=hemi.dispatch.WILDCARD:e.src=[b.src,hemi.dispatch.WILDCARD]),b.msg!==undefined&&(b.msg===hemi.dispatch.WILDCARD?e.msg=hemi.dispatch.WILDCARD:e.msg=[b.msg,hemi.dispatch.WILDCARD])):(b.src!==undefined&&(e.src=b.src),b.msg!==undefined&&(e.msg=b.msg)),d=a.query(e)}return d},hemi.dispatch.getSpecsFast=function(b,c,d){var e=[],f=c+b,g=a.get(f);g!==null&&e.push(g);if(d){var h=b===hemi.dispatch.WILDCARD;h||(f=c+hemi.dispatch.WILDCARD,g=a.get(f),g!==null&&e.push(g)),c!==hemi.dispatch.WILDCARD&&(f=hemi.dispatch.WILDCARD+b,g=a.get(f),g!==null&&e.push(g),h||(f=hemi.dispatch.WILDCARD+hemi.dispatch.WILDCARD,g=a.get(f),g!==null&&e.push(g)))}return e},hemi.dispatch.getTargets=function(a,b){var c=this.getSpecs(a,b),d=[],e,f,g;a!==undefined&&(e=a._dispatchId,f=a.name,g=a.handler);for(var h=0,i=c.length;h<i;++h){var j=c[h].targets;for(var k=0,l=j.length;k<l;++k){var m=j[k],n=!0;e!==undefined&&(n=m._dispatchId===e),n&&f!==undefined&&(n=m.name===f),n&&g!==undefined&&(n=m.handler===g),n&&d.push(m)}}return d},hemi.dispatch.getTargetSpec=function(a){var b=this.getSpecs(),c=a._dispatchId;for(var d=0,e=b.length;d<e;++d){var f=b[d],g=f.targets;for(var h=0,i=g.length;h<i;++h)if(g[h]._dispatchId===c)return f}return null},hemi.dispatch.loadEntries=function(b){for(var c=0,d=b.length;c<d;++c){var e=b[c];a.put(e.getHash(),e)}},hemi.dispatch.postMessage=function(a,b,c){var d=new hemi.dispatch.Message,e=a._getId();d.src=a,d.msg=b,d.data=c;var f=this.getSpecsFast(e,b,!0);for(var g=0,h=f.length;g<h;++g){var i=f[g].targets.slice(0);for(var j=0,k=i.length;j<k;++j){var l=i[j],m,n;l.args!==null?m=this.getArguments(d,l.args):m=[d],l.func?n=l.handler[l.func]:n=l.handler,n.apply(l.handler,m)}}},hemi.dispatch.registerTarget=function(a,b,c,d,e){var f=g(a,b),h=new hemi.dispatch.MessageTarget;return h._dispatchId=this.getNextId(),h.handler=c,d&&(h.func=d),e&&(h.args=e),f.addTarget(h),h},hemi.dispatch.removeSpecs=function(b,c){var d=hemi.dispatch.getSpecs(b,c),e=[],f;for(var g=0,h=d.length;g<h;++g)f=a.remove(d[g].getHash()),f&&e.push(f);return e},hemi.dispatch.removeTarget=function(a,b){var c=this.getSpecs(b,!1),d=null;for(var e=0,f=c.length;e<f;++e){var g=c[e];d=g.removeTarget(a);if(d!==null)break}return d===null&&console.log("MessageTarget was not found and therefore not removed"),d},hemi.dispatch.removeTargets=function(a,b){var c=this.getSpecs(a,b),d=[],e,f,g;a!==undefined&&(e=a._dispatchId,f=a.name,g=a.handler);for(var h=0,i=c.length;h<i;++h){var j=c[h],k=j.targets.slice(0);for(var l=0,m=k.length;l<m;++l){var n=k[l],o=!0;e!==undefined&&(o=n._dispatchId===e),o&&f!==undefined&&(o=n.name===f),o&&g!==undefined&&(o=n.handler===g),o&&(j.removeTarget(n),d.push(n))}}return d},hemi.dispatch.setNextId=function(a){b=a},hemi.dispatch.setTargetSpec=function(a,b,c){var d=this.getTargetSpec(a);d!==null?d.removeTarget(a):console.log("Previous MessageSpec for MessageTarget not found"),d=g(b,c),d.addTarget(a)},hemi.dispatch.getArguments=function(a,b){var c=[];for(var d=0,e=b.length;d<e;++d){var f=b[d];if(typeof f!="string")c[d]=f;else if(f.substring(0,3)===hemi.dispatch.ID_ARG){var g=parseInt(f.substring(3),10);c[d]=hemi.world.getCitizenById(g)}else if(f.substring(0,4)===hemi.dispatch.MSG_ARG){var h=f.substring(4).split("."),i=a;for(var j=0,k=h.length;i!=null&&j<k;++j)i=i[h[j]];c[d]=i}else c[d]=f}return c};var f={_getId:function(){return hemi.dispatch.WILDCARD}};hemi._resetMsgSpecs=function(b){var c=a;return a=b||new hemi.utils.Hashtable,c},hemi.send=function(a,b){hemi.dispatch.postMessage(f,a,b)},hemi.subscribe=function(a,b,c,d){return hemi.dispatch.registerTarget(hemi.dispatch.WILDCARD,a,b,c,d)},hemi.unsubscribe=function(a,b){return hemi.dispatch.removeTarget(a,{src:hemi.dispatch.WILDCARD,msg:b})}}(),function(){function h(a,b){a.push(b)}function i(a,b){var c=a.indexOf(b),d=null;return c!==-1&&(d=a.splice(c,1)[0]),d}function j(a){var b=a.target?a.target:a.srcElement,c={x:0,y:0};for(var d=b;d;d=d.offsetParent)c.x+=d.offsetLeft,c.y+=d.offsetTop;return c.x=a.pageX-c.x,c.y=a.pageY-c.y,c}function k(a){var b=hemi.utils.clone(a,!1),c=j(b);return b.x=c.x,b.y=c.y,b}function l(a){a||(a=window.event),a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var a=[],b=[],c=[],d=[],e=[],f=[],g=[];document.addEventListener("keypress",function(a){hemi.input.keyPress(a)},!0),document.addEventListener("keydown",function(a){hemi.input.keyDown(a)},!0),document.addEventListener("keyup",function(a){hemi.input.keyUp(a)},!0),hemi.input=hemi.input||{},hemi._resetKeyListeners=function(a){var b={down:e,up:f,press:g};return a=a||{},e=a.down||[],f=a.up||[],g=a.press||[],b},hemi._resetMouseListeners=function(e){var f={down:a,up:b,move:c,wheel:d};return e=e||{},a=e.down||[],b=e.up||[],c=e.move||[],d=e.wheel||[],f},hemi.input.init=function(a){a.addEventListener("mousedown",function(a){hemi.input.mouseDown(a)},!0),a.addEventListener("mousemove",function(a){hemi.input.mouseMove(a)},!0),a.addEventListener("mouseup",function(a){hemi.input.mouseUp(a)},!0),a.addEventListener("mousewheel",function(a){hemi.input.scroll(a)},!1),a.addEventListener("DOMMouseScroll",function(a){hemi.input.scroll(a)},!1)},hemi.input.addMouseDownListener=function(b){h(a,b)},hemi.input.addMouseUpListener=function(a){h(b,a)},hemi.input.addMouseMoveListener=function(a){h(c,a)},hemi.input.addMouseWheelListener=function(a){h(d,a)},hemi.input.addKeyDownListener=function(a){h(e,a)},hemi.input.addKeyUpListener=function(a){h(f,a)},hemi.input.addKeyPressListener=function(a){h(g,a)},hemi.input.removeMouseDownListener=function(b){return i(a,b)},hemi.input.removeMouseUpListener=function(a){return i(b,a)},hemi.input.removeMouseMoveListener=function(a){return i(c,a)},hemi.input.removeMouseWheelListener=function(a){return i(d,a)},hemi.input.removeKeyDownListener=function(a){return i(e,a)},hemi.input.removeKeyUpListener=function(a){return i(f,a)},hemi.input.removeKeyPressListener=function(a){return i(g,a)},hemi.input.mouseDown=function(b){var c=k(b);for(var d=0;d<a.length;d++)a[d].onMouseDown(c)},hemi.input.mouseUp=function(a){var c=k(a);for(var d=0;d<b.length;d++)b[d].onMouseUp(c)},hemi.input.mouseMove=function(a){var b=k(a);for(var d=0;d<c.length;d++)c[d].onMouseMove(b)},hemi.input.scroll=function(a){var b=k(a);b.deltaY=a.detail?-a.detail:a.wheelDelta,l(a);for(var c=0;c<d.length;c++)d[c].onScroll(b)},hemi.input.keyDown=function(a){for(var b=0;b<e.length;b++)e[b].onKeyDown(a)},hemi.input.keyUp=function(a){for(var b=0;b<f.length;b++)f[b].onKeyUp(a)},hemi.input.keyPress=function(a){for(var b=0;b<g.length;b++)g[b].onKeyPress(a)}}(),function(){var a=function(){this._keyDownListeners=new hemi.utils.Hashtable,this._keyUpListeners=new hemi.utils.Hashtable,this._keyPressListeners=new hemi.utils.Hashtable};a.prototype._msgSent=[hemi.msg.keyUp,hemi.msg.keyDown,hemi.msg.keyPress],a.prototype.init=function(){hemi.input.addKeyDownListener(this),hemi.input.addKeyUpListener(this),hemi.input.addKeyPressListener(this),hemi.keyDispatch=this},a.prototype.addKeyDownListener=function(a,b){this._keyDownListeners.put(a._getId(),b),hemi.subscribe(hemi.msg.keyDown,a,b)},a.prototype.addKeyUpListener=function(a,b){this._keyUpListeners.put(a._getId(),b),hemi.subscribe(hemi.msg.keyUp,a,b)},a.prototype.addKeyPressListener=function(a,b){this._keyPressListeners.put(a._getId(),b),hemi.subscribe(hemi.msg.keyPress,a,b)},a.prototype.removeKeyDownListener=function(a){hemi.unsubscribe(a,hemi.msg.keyDown),this._keyDownListeners.remove(a._getId())},a.prototype.removeKeyUpListener=function(a){hemi.unsubscribe(a,hemi.msg.keyUp),this._keyUpListeners.remove(a._getId())},a.prototype.removeKeyPressListener=function(a){hemi.unsubscribe(a,hemi.msg.keyDown),this._keyDownListeners.remove(a._getId())},a.prototype.onKeyDown=function(a){this.send(hemi.msg.keyDown,a)},a.prototype.onKeyUp=function(a){this.send(hemi.msg.keyUp,a)},a.prototype.onKeyPress=function(a){this.send(hemi.msg.keyPress,a)},a.prototype._octane=function(){return[{name:"loadListeners",arg:[{keyDown:{citizens:this._keyDownListeners.keys(),callbacks:this._keyDownListeners.values()},keyUp:{citizens:this._keyUpListeners.keys(),callbacks:this._keyUpListeners.values()},keyPress:{citizens:this._keyPressListeners.keys(),callbacks:this._keyPressListeners.values()}}]},{name:"init",arg:[]}]},a.prototype._cleanup=function(){hemi.KeyDispatch=null,hemi.input.removeKeyDownListener(this),hemi.input.removeKeyUpListener(this),hemi.input.removeKeyPressListener(this)},a.prototype.loadListeners=function(a){for(var b=0;b<a.keyDown.citizens.length;++b)this.addKeyDownListener(hemi.world.getCitizenById(a.keyDown.citizens[b]),a.keyDown.callbacks[b]);for(var b=0;b<a.keyUp.citizens.length;++b)this.addKeyUpListener(hemi.world.getCitizenById(a.keyUp.citizens[b]),a.keyUp.callbacks[b]);for(var b=0;b<a.keyPress.citizens.length;++b)this.addKeyPressListener(hemi.world.getCitizenById(a.keyPress.citizens[b]),a.keyPress.callbacks[b])},hemi.makeCitizen(a,"hemi.KeyDispatcher",{toOctane:a.prototype._octane});var b=new hemi.KeyDispatcher;b.init()}(),function(){function b(){!this.enabled||this.accel.isZero()&&this.vel.isZero()?hemi.removeRenderListener(this):hemi.addRenderListener(this)}function d(){this._transform.useQuaternion&&(this._transform.useQuaternion=!1),this._transform.rotation.copy(this.angle),this._transform.updateMatrix(),this._transform.updateMatrixWorld(!0)}function f(){this._transform.position.copy(this.pos),this._transform.updateMatrix(),this._transform.updateMatrixWorld(!0)}var a=new THREE.Vector3,c=function(a,b){var c=b||{};this._transform=null,this.accel=c.accel||new THREE.Vector3,this.angle=c.angle||new THREE.Vector3,this.vel=c.vel||new THREE.Vector3,this.time=0,this.stopTime=0,this.steadyRotate=!1,this.mustComplete=!1,this.startAngle=this.angle.clone(),this.stopAngle=this.angle.clone(),a!==undefined&&this.setTransform(a),this.enable()};c.prototype._octane=function(){return[{name:"_transform",id:this._transform._getId()},{name:"setAngle",arg:[this.angle]},{name:"setAcceleration",arg:[this.accel]},{name:"setVelocity",arg:[this.vel]}]},c.prototype.clear=function(){this.disable(),this.accel.set(0,0,0),this.angle.set(0,0,0),this.vel.set(0,0,0)},c.prototype.disable=function(){this.enabled&&(hemi.removeRenderListener(this),this.enabled=!1)},c.prototype.enable=function(){this.enabled=!0,b.call(this)},c.prototype.onRender=function(b){if(!this._transform)return;var c=b.elapsedTime;this.steadyRotate?(this.time+=c,this.time>=this.stopTime?(hemi.removeRenderListener(this),this.time=this.stopTime,this.angle.copy(this.stopAngle),this.steadyRotate=this.mustComplete=!1,this._transform.send(hemi.msg.stop,{})):hemi.utils.lerpVec3(this.startAngle,this.stopAngle,this.time/this.stopTime,this.angle)):(this.vel.addSelf(a.copy(this.accel).multiplyScalar(c)),this.angle.addSelf(a.copy(this.vel).multiplyScalar(c))),d.call(this)},c.prototype.turn=function(a,b,c){return!this.enabled||this.mustComplete?!1:(this.mustComplete=c||!1,this.time=0,this.stopTime=b||.001,this.steadyRotate=!0,this.startAngle.copy(this.angle),this.stopAngle.add(this.angle,a),hemi.addRenderListener(this),this._transform.send(hemi.msg.start,{}),!0)},c.prototype.setAcceleration=function(a){this.accel.copy(a),b.call(this)},c.prototype.setAngle=function(a){this.angle.copy(a),d.call(this)},c.prototype.setTransform=function(a){hemi.utils.useEuler(a),this._transform=a,this.angle.copy(a.rotation)},c.prototype.setVelocity=function(a){this.vel.copy(a),b.call(this)},hemi.Rotator=c,hemi.makeOctanable(hemi.Rotator,"hemi.Rotator",hemi.Rotator.prototype._octane);var e=function(a,b){var c=b||{};this._transform=null,this.pos=c.pos||new THREE.Vector3,this.vel=c.vel||new THREE.Vector3,this.accel=c.accel||new THREE.Vector3,this.time=0,this.stopTime=0,this.mustComplete=!1,this.steadyMove=!1,this.startPos=this.pos.clone(),this.stopPos=this.pos.clone(),a!==undefined&&this.setTransform(a),this.enable()};e.prototype._octane=function(){return[{name:"_transform",id:this._transform._getId()},{name:"setPosition",arg:[this.pos]},{name:"setAcceleration",arg:[this.accel]},{name:"setVelocity",arg:[this.vel]}]},e.prototype.clear=function(){this.disable(),this.pos.set(0,0,0),this.vel.set(0,0,0),this.accel.set(0,0,0)},e.prototype.disable=function(){this.enabled&&(hemi.removeRenderListener(this),this.enabled=!1)},e.prototype.enable=function(){this.enabled=!0,b.call(this)},e.prototype.move=function(a,b,c){return!this.enabled||this.mustComplete?!1:(this.mustComplete=c||!1,this.time=0,this.stopTime=b||.001,this.steadyMove=!0,this.startPos.copy(this.pos),this.stopPos.add(this.pos,a),hemi.addRenderListener(this),this._transform.send(hemi.msg.start,{}),!0)},e.prototype.onRender=function(b){if(!this._transform)return;var c=b.elapsedTime;this.steadyMove?(this.time+=c,this.time>=this.stopTime?(hemi.removeRenderListener(this),this.time=this.stopTime,this.pos.copy(this.stopPos),this.steadyMove=this.mustComplete=!1,this._transform.send(hemi.msg.stop,{})):hemi.utils.lerpVec3(this.startPos,this.stopPos,this.time/this.stopTime,this.pos)):(this.vel.addSelf(a.copy(this.accel).multiplyScalar(c)),this.pos.addSelf(a.copy(this.vel).multiplyScalar(c))),f.call(this)},e.prototype.setAcceleration=function(a){this.accel.copy(a),b.call(this)},e.prototype.setPosition=function(a){this.pos.copy(a),f.call(this)},e.prototype.setTransform=function(a){this._transform=a,this.pos.copy(a.position)},e.prototype.setVelocity=function(a){this.vel.copy(a),b.call(this)},hemi.Translator=e,hemi.makeOctanable(hemi.Translator,"hemi.Translator",hemi.Translator.prototype._octane)}(),function(){function g(b){var c=a[b],d;return c?d=c.storage.length>0?c.storage.pop():c.create():console.log("Unrecognized manipulation type: "+b),d.enable(),d}function h(a){var c=b[a],d;return c?d=c.storage.length>0?c.storage.pop():c.create():console.log("Unrecognized motion type: "+a),d.enable(),d}function i(a){var b=c[a];return b||(c[a]=b={}),b}function j(b,c){var d=a[c];b.clear(),d?d.storage.length>10?b.cleanup():d.storage.push(b):console.log("Unrecognized manipulation type: "+c)}function k(a,c){var d=b[c];a.clear(),d?d.storage.length>10?a.cleanup():d.storage.push(a):console.log("Unrecognized motion type: "+c)}var a=[],b=[],c={},d=new THREE.Vector3;hemi.MotionType={MOVE:"move",RESIZE:"resize",TURN:"turn"},a[hemi.MotionType.MOVE]={create:function(){return new hemi.Movable},storage:[]},a[hemi.MotionType.RESIZE]={create:function(){return new hemi.Resizable},storage:[]},a[hemi.MotionType.TURN]={create:function(){return new hemi.Turnable},storage:[]},b[hemi.MotionType.MOVE]={create:function(){return new hemi.Translator},storage:[]},b[hemi.MotionType.RESIZE]={create:function(){return new hemi.Scalor},storage:[]},b[hemi.MotionType.TURN]={create:function(){return new hemi.Rotator},storage:[]};var e=function(){THREE.Object3D.call(this),this._manip=null,this._rotator=null,this._translator=null,this.pickable=!0,this.matrixAutoUpdate=!1};e.prototype=new THREE.Object3D,e.constructor=e,e.prototype._clean=function(){this.cancelInteraction(),this.cancelMoving(),this.cancelResizing(),this.cancelTurning(),this.parent&&this.parent.remove(this);var a=[].concat(this.children);for(var b=0,d=a.length;b<d;++b)a[b].cleanup();c[this._getId()]=undefined},e.prototype._init=function(a,b,c){var d=this.children;this.matrix=a.matrix,this.matrixWorld=a.matrixWorld,this.updateMatrix(),this.updateMatrixWorld(),this.children=[],b[a.id]!==undefined&&(b[a.id]=this);for(var e=0,f=d.length;e<f;++e){var g=d[e],h=a.getChildByName(g.name,!1);this.add(g),g._init(h,b,c)}},e.prototype._msgSent=[hemi.msg.move,hemi.msg.resize,hemi.msg.start,hemi.msg.stop],e.prototype._octane=function(){var a=["pickable","visible","useQuaternion"],b=[],c=[];for(var d=0,e=a.length;d<e;++d){var f=a[d];b.push({name:f,val:this[f]})}for(var d=0,e=this.children.length;d<e;++d)c[d]=this.children[d]._getId();b.push({name:"children",id:c}),a=["_manip","_rotator","_translator","position","scale"],a.push(this.useQuaternion?"quaternion":"rotation");for(var d=0,e=a.length;d<e;++d){var f=a[d];this[f]&&b.push({name:f,oct:this[f]._toOctane()})}return b},e.prototype.cancelInteraction=function(){if(this._manip){var a=i(this._getId()),b;this._manip instanceof hemi.Movable?(b=hemi.MotionType.MOVE,a.uv=this._manip._uv.slice(0),a.angle=a.scale=undefined):this._manip instanceof hemi.Resizable?(b=hemi.MotionType.RESIZE,a.scale=this._manip._scale,a.angle=a.uv=undefined):this._manip instanceof hemi.Turnable&&(b=hemi.MotionType.TURN,a.angle=this._manip._angle,a.scale=a.uv=undefined),j(this._manip,b),this._manip=null}},e.prototype.cancelMoving=function(){this._translator&&(k(this._translator,hemi.MotionType.MOVE),this._translator=null)},e.prototype.cancelResizing=function(){},e.prototype.cancelTurning=function(a){this._rotator&&(k(this._rotator,hemi.MotionType.TURN),this._rotator=null)},e.prototype.getAcceleration=function(a,b){var c;b=b||new THREE.Vector3;switch(a){case hemi.MotionType.TURN:c=this._rotator;break;case hemi.MotionType.RESIZE:break;case hemi.MotionType.MOVE:c=this._translator;break;default:console.log("Unrecognized motion type: "+a)}return c?b.copy(c.accel):b.set(0,0,0),b},e.prototype.getAllChildren=function(a){a=a||[];for(var b=0,c=this.children.length;b<c;++b){var d=this.children[b];a.push(d),d.getAllChildren(a)}return a},e.prototype.getVelocity=function(a,b){var c;b=b||new THREE.Vector3;switch(a){case hemi.MotionType.TURN:c=this._rotator;break;case hemi.MotionType.RESIZE:break;case hemi.MotionType.MOVE:c=this._translator;break;default:console.log("Unrecognized motion type: "+a)}return c?b.copy(c.vel):b.set(0,0,0),b},e.prototype.identity=function(){this.position.set(0,0,0),this.quaternion.set(0,0,0,1),this.rotation.set(0,0,0),this.scale.set(1,1,1),this.matrix.identity(),this.updateMatrixWorld(!0)},e.prototype.move=function(a,b,c){return this._translator||(this._translator=h(hemi.MotionType.MOVE),this._translator.setTransform(this)),this._translator.move(a,b,c)},e.prototype.moveTo=function(a,b,c){return hemi.utils.pointAsLocal(this,d.copy(a)),this.move(d,b,c)},e.prototype.resize=function(a,b,c){},e.prototype.setMoving=function(a,b){this._translator||(this._translator=h(hemi.MotionType.MOVE),this._translator.setTransform(this)),b!=null&&this._translator.setAcceleration(b),a!=null&&this._translator.setVelocity(a)},e.prototype.setPickable=function(a,b){this.pickable=a;if(b)for(var c=0,d=this.children.length;c<d;++c)this.children[c].setPickable(a,b)},e.prototype.setResizing=function(a,b){},e.prototype.setTurning=function(a,b){this._rotator||(this._rotator=h(hemi.MotionType.TURN),this._rotator.setTransform(this)),b!=null&&this._rotator.setAcceleration(b),a!=null&&this._rotator.setVelocity(a)},e.prototype.setVisible=function(a,b){this.visible=a;if(b)for(var c=0,d=this.children.length;c<d;++c)this.children[c].setVisible(a,b)},e.prototype.turn=function(a,b,c){return this._rotator||(this._rotator=h(hemi.MotionType.TURN),this._rotator.setTransform(this)),this._rotator.turn(a,b,c)},e.prototype.turnTo=function(a,b,c){return this.useQuaternion?d.copy(a).subSelf(hemi.utils.quaternionToEuler(this.quaternion)):d.copy(a).subSelf(this.rotation),this.turn(d,b,c)},hemi.makeCitizen(e,"hemi.Transform",{cleanup:e.prototype._clean,toOctane:e.prototype._octane});var f=function(a,b){THREE.Mesh.call(this,a,b),this._manip=null,this._opacity=null,this._rotator=null,this._translator=null,this.pickable=!0,this.matrixAutoUpdate=!1};f.prototype=new THREE.Mesh,f.constructor=f,f.prototype._clean=e.prototype._clean,f.prototype._init=function(a,b,c){this.geometry=a.geometry,this.material=a.material,this.boundRadius=a.boundRadius,this.geometry.morphTargets.length&&(this.morphTargetBase=a.morphTargetBase,this.morphTargetForcedOrder=a.morphTargetForcedOrder,this.morphTargetInfluences=a.morphTargetInfluences,this.morphTargetDictionary=a.morphTargetDictionary);if(this._opacity!==null){var d=this._opacity;this._opacity=null,hemi.fx.setOpacity(this,d)}c.materials.indexOf(this.material)===-1&&c.materials.push(this.material),c.geometries.indexOf(this.geometry)===-1&&c.geometries.push(this.geometry),e.prototype._init.call(this,a,b,c)},f.prototype._msgSent=e.prototype._msgSent,f.prototype._octane=function(){var a=e.prototype._octane.call(this);return a.push({name:"_opacity",val:this._opacity}),a},f.prototype.cancelInteraction=e.prototype.cancelInteraction,f.prototype.cancelMoving=e.prototype.cancelMoving,f.prototype.cancelResizing=e.prototype.cancelResizing,f.prototype.cancelTurning=e.prototype.cancelTurning,f.prototype.getAcceleration=e.prototype.getAcceleration,f.prototype.getAllChildren=e.prototype.getAllChildren,f.prototype.getBoundingBox=function(){var a=this.geometry.boundingBox,b=this.matrixWorld;return a||(this.geometry.computeBoundingBox(),a=this.geometry.boundingBox),new hemi.BoundingBox(b.multiplyVector3(a.min.clone()),b.multiplyVector3(a.max.clone()))},f.prototype.getVelocity=e.prototype.getVelocity,f.prototype.identity=e.prototype.identity,f.prototype.move=e.prototype.move,f.prototype.moveTo=e.prototype.moveTo,f.prototype.resize=e.prototype.resize,f.prototype.setMovable=function(a,b,c){var d=i(this._getId()),e=a==null&&b==null&&c==null;this._manip instanceof hemi.Movable?this._manip.clearTransforms():(this.cancelInteraction(),this._manip=g(hemi.MotionType.MOVE)),d.uv===undefined?e=!1:e&&(this._manip._uv[0]=d.uv[0],this._manip._uv[1]=d.uv[1]),a!=null?(this._manip.setPlane(a),d.plane=a):e&&d.plane&&this._manip.setPlane(d.plane),b!=null?(this._manip.setLimits(b),d.limits=b):e&&d.limits&&this._manip.setLimits(d.limits),c!=null?(c=c.slice(0),this.parent&&c.unshift(this),d.transforms=c):e&&d.transforms?c=d.transforms:c=[this];for(var f=0,h=c.length;f<h;++f)this._manip.addTransform(c[f])},f.prototype.setMoving=e.prototype.setMoving,f.prototype.setPickable=e.prototype.setPickable,f.prototype.setResizable=function(a,b){var c=i(this._getId()),d=a==null&&b==null;this._manip instanceof hemi.Resizable?this._manip.clearTransforms():(this.cancelInteraction(),this._manip=g(hemi.MotionType.RESIZE)),c.scale===undefined?d=!1:d&&(this._manip._scale=c.scale),a!=null?(this._manip.setAxis(a),c.axis=a):d&&c.axis&&this._manip.setAxis(c.axis),b!=null?(b=b.slice(0),this.parent&&b.unshift(this),c.transforms=b):d&&c.transforms?b=c.transforms:b=[this];for(var e=0,f=b.length;e<f;++e)this._manip.addTransform(b[e])},f.prototype.setResizing=e.prototype.setResizing,f.prototype.setTurnable=function(a,b,c){var d=i(this._getId()),e=a==null&&b==null&&c==null;this._manip instanceof hemi.Turnable?this._manip.clearTransforms():(this.cancelInteraction(),this._manip=g(hemi.MotionType.TURN)),d.angle===undefined?e=!1:e&&(this._manip._angle=d.angle),a!=null?(this._manip.setAxis(a),d.axis=a):e&&d.axis&&this._manip.setAxis(d.axis),b!=null?(this._manip.setLimits(b),d.limits=b):e&&d.limits&&this._manip.setLimits(d.limits),c!=null?(c=c.slice(0),this.parent&&c.unshift(this),d.transforms=c):e&&d.transforms?c=d.transforms:c=[this];for(var f=0,h=c.length;f<h;++f)this._manip.addTransform(c[f])},f.prototype.setTurning=e.prototype.setTurning,f.prototype.setVisible=e.prototype.setVisible,f.prototype.turn=e.prototype.turn,f.prototype.turnTo=e.prototype.turnTo,hemi.makeCitizen(f,"hemi.Mesh",{cleanup:f.prototype._clean,toOctane:f.prototype._octane}),hemi.makeCitizen(THREE.Scene,"hemi.Scene"),hemi.makeOctanable(THREE.Vector3,"THREE.Vector3",["x","y","z"]),hemi.makeOctanable(THREE.Quaternion,"THREE.Quaternion",["x","y","z","w"])}(),function(){function p(a,b){var c=this.vd.last,d=this.vd.current,e=!1,f,g;if(this.state.curve){var h=this.easeFunc[0](a,0,1,b);f=this.state.curve.eye.interpolate(h),g=this.state.curve.target.interpolate(h)}else f=m,g=n,f.x=this.easeFunc[0](a,c.eye.x,d.eye.x-c.eye.x,b),f.y=this.easeFunc[1](a,c.eye.y,d.eye.y-c.eye.y,b),f.z=this.easeFunc[2](a,c.eye.z,d.eye.z-c.eye.z,b),g.x=this.easeFunc[0](a,c.target.x,d.target.x-c.target.x,b),g.y=this.easeFunc[1](a,c.target.y,d.target.y-c.target.y,b),g.z=this.easeFunc[2](a,c.target.z,d.target.z-c.target.z,b);d.fov!==c.fov&&(this.fov.current=this.easeFunc[0](a,c.fov,d.fov-c.fov,b),this.threeCamera.fov=this.fov.current*hemi.RAD_TO_DEG,e=!0),d.np!==c.np&&(this.threeCamera.near=this.easeFunc[0](a,c.np,d.np-c.np,b),e=!0),d.fp!==c.fp&&(this.threeCamera.far=this.easeFunc[0](a,c.fp,d.fp-c.fp,b),e=!0),e&&this.threeCamera.updateProjectionMatrix(),this.setEyeTarget(f,g)}function q(a){var b=this.state.time;this.state.moving&&(p.call(this,b.current,b.end),a!==undefined&&(b.current>=b.end&&(this.state.moving=!1,this.state.curve=null,this.state.vp!==null?(this.send(hemi.msg.stop,{viewpoint:this.state.vp}),this.state.vp=null):this.send(hemi.msg.stop,{viewdata:this.vd.current})),b.current+=a,b.current>=b.end&&(b.current=b.end))),this.updateWorldMatrices(),this.getEye(this.threeCamera.position),this.getTarget(m),this.threeCamera.matrix.setPosition(this.threeCamera.position),this.threeCamera.lookAt(m),this.threeCamera.updateMatrixWorld(!0),this.light.updateMatrix()}function r(){var a=Math.tan(this.fov.current/2)*this.distance,b=a*this.fov.aspect;this.threeCamera.bottom=a*-1,this.threeCamera.left=b*-1,this.threeCamera.right=b,this.threeCamera.top=a,this.threeCamera.updateProjectionMatrix()}var a=1e4,b=.707107,c=Math.PI/3,d=Math.PI/2.001,e=.05,f=-Math.PI/2.001,g=.0015,h=.005,i=1,j=13/12,k=11/12,l=.02,m=new THREE.Vector3,n=new THREE.Vector3,o=function(){this.panTilt=new THREE.Object3D,this.panTilt.name="panTilt",this.panTilt.eulerOrder="ZYX",this.panTilt.matrixAutoUpdate=!1,this.cam=new THREE.Object3D,this.cam.name="cam",this.cam.eulerOrder="ZYX",this.cam.matrixAutoUpdate=!1,this.panTilt.add(this.cam),this.cam.position.z=1,this.cam.updateMatrix(),this.updateWorldMatrices(),this.distance=1,this.vd={current:null,last:null},this.tiltMax=d,this.tiltMin=f,this.fov={current:b,min:e,max:c,aspect:window.innerWidth/window.innerHeight},this.lookLimits={panMax:null,panMin:null,tiltMax:null,tiltMin:null},this.mode={scroll:!0,scan:!0,fixed:!1,control:!1,ortho:!1},this.state={moving:!1,curve:null,time:{current:0,end:0},mouse:!1,xy:{current:[-1,-1],last:[-1,-1]},shift:!1,update:!1,vp:null},this.threeCamera=new THREE.PerspectiveCamera(this.fov.current*hemi.RAD_TO_DEG,this.fov.aspect,i,a),this.threeCamera.matrixAutoUpdate=!1,this.light=new THREE.SpotLight(16777215,1.35),this.light.position=this.threeCamera.position,this.light.rotation=this.threeCamera.rotation,this.light.scale=this.threeCamera.scale;var g=hemi.utils.penner.linearTween;this.easeFunc=[g,g,g],q.call(this),hemi.addRenderListener(this)};o.prototype._clean=function(){hemi.removeRenderListener(this),this.disableControl(),this.light=null,this.threeCamera=null},o.prototype._msgSent=[hemi.msg.start,hemi.msg.stop],o.prototype._octane=function(){var a=hemi.createViewData(this),b=[{name:this.mode.control?"enableControl":"disableControl",arg:[]},{name:"mode",val:this.mode},{name:"moveToView",arg:[a,0]}];return this.mode.ortho&&b.push({name:"setOrthographic",arg:[]}),b},o.prototype.disableControl=function(){return this.mode.control&&(hemi.input.removeMouseDownListener(this),hemi.input.removeMouseUpListener(this),hemi.input.removeMouseMoveListener(this),hemi.input.removeMouseWheelListener(this),hemi.input.removeKeyDownListener(this),hemi.input.removeKeyUpListener(this),this.mode.control=!1,this.state.mouse=!1),this},o.prototype.disableScan=function(){return this.mode.scan=!1,this},o.prototype.disableZoom=function(){return this.mode.scroll=!1,this},o.prototype.enableControl=function(a){return this.mode.control||(hemi.input.addMouseDownListener(this),hemi.input.addMouseUpListener(this),hemi.input.addMouseMoveListener(this),hemi.input.addMouseWheelListener(this),hemi.input.addKeyDownListener(this),hemi.input.addKeyUpListener(this),this.mode.control=!0),this},o.prototype.enableScan=function(){return this.mode.scan=!0,this},o.prototype.enableZoom=function(){return this.mode.scroll=!0,this},o.prototype.fixEye=function(){return this.mode.fixed=!0,q.call(this),this},o.prototype.freeEye=function(){return this.setEyeTarget(this.getEye(m),this.getTarget(n)),this.mode.fixed=!1,q.call(this),this},o.prototype.getEye=function(a){var b;return a?(a.copy(this.cam.matrixWorld.getPosition()),b=a):b=this.cam.matrixWorld.getPosition().clone(),b},o.prototype.getTarget=function(a){var b;return this.mode.fixed?(b=a?a.set(0,0,1):new THREE.Vector3(0,0,1),this.cam.matrixWorld.rotateAxis(b).multiplyScalar(-this.distance),b.addSelf(this.cam.matrixWorld.getPosition())):a?(a.copy(this.panTilt.matrixWorld.getPosition()),b=a):b=this.panTilt.matrixWorld.getPosition().clone(),b},o.prototype.moveOnCurve=function(a,b){this.vd.current!==null?this.vd.last=this.vd.current:this.vd.last=hemi.createViewData(this),this.vd.current=new hemi.ViewData({eye:a.eye.getEnd(),target:a.target.getEnd(),fov:this.fov.current,np:this.threeCamera.near,fp:this.threeCamera.far}),this.state.curve=a,this.state.moving=!0,this.state.vp=null,this.state.time.end=b===null?1:b>0?b:.001,this.state.time.current=0,this.send(hemi.msg.start,{viewdata:this.vd.current})},o.prototype.moveToView=function(a,b){var c=b===undefined?1:b,d;a.getData!==undefined?(this.vd.current=a.getData(),this.state.vp=a,d={viewpoint:a}):(this.vd.current=a,this.state.vp=null,d={viewdata:a}),this.vd.last=hemi.createViewData(this),this.state.curve=null,this.state.time.end=c>0?c:.001,this.state.time.current=0,this.state.moving=!0,this.send(hemi.msg.start,d)},o.prototype.onKeyDown=function(a){this.state.shift=a.keyCode===16},o.prototype.onKeyUp=function(a){a.keyCode===16&&(this.state.shift=!1)},o.prototype.onMouseDown=function(a){this.state.mouse=!0,this.state.xy.current[0]=this.state.xy.last[0]=a.x,this.state.xy.current[1]=this.state.xy.last[1]=a.y},o.prototype.onMouseMove=function(a){if(this.state.mouse){this.state.xy.last[0]=this.state.xy.current[0],this.state.xy.last[1]=this.state.xy.current[1],this.state.xy.current[0]=a.x,this.state.xy.current[1]=a.y;var b=this.state.xy.current[0]-this.state.xy.last[0],c=this.state.xy.current[1]-this.state.xy.last[1];if(this.state.shift){var d=g*this.distance;this.scan(-1*d*b,d*c)}else this.mode.fixed?this.rotate(-b*h,-c*h):this.orbit(-b*h,-c*h)}},o.prototype.onMouseUp=function(a){this.state.mouse=!1},o.prototype.onRender=function(a){var b=this.state,c=b.xy;(b.mouse&&(c.current[0]!==c.last[0]||c.current[1]!==c.last[1])||b.moving||b.update)&&q.call(this,a.elapsedTime),b.update=!1},o.prototype.onScroll=function(a){if(!this.mode.scroll)return;if(this.state.shift){var b=this.distance*l,c=a.deltaY>0?1:-1;this.truck(b*c)}else{if(this.mode.fixed){var d=(this.fov.max+this.fov.min)/2;a.deltaY>0?this.fov.current<d?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*k:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*j:this.fov.current<d?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*j:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*k,this.mode.ortho||(this.threeCamera.fov=this.fov.current*hemi.RAD_TO_DEG,this.threeCamera.updateProjectionMatrix())}else{var e=a.deltaY>0?k:j;this.cam.position.z=this.distance=hemi.utils.lerp(0,this.distance,e),this.cam.updateMatrix()}this.mode.ortho&&r.call(this),this.state.update=!0}},o.prototype.orbit=function(a,b){b===undefined&&(b=0);var c=this.panTilt.rotation.x+b;return this.panTilt.rotation.y+=a,this.panTilt.rotation.x=hemi.utils.clamp(c,this.tiltMin,this.tiltMax),this.panTilt.updateMatrix(),q.call(this),this},o.prototype.rotate=function(a,b){b===undefined&&(b=0);var c=this.lookLimits,d=this.cam.rotation.y+a,e=this.cam.rotation.x+b;return c.panMin!==null&&d<c.panMin?this.cam.rotation.y=c.panMin:c.panMax!==null&&d>c.panMax?this.cam.rotation.y=c.panMax:this.cam.rotation.y=d,c.tiltMin!==null&&e<c.tiltMin?this.cam.rotation.x=c.tiltMin:c.tiltMax!==null&&e>c.tiltMax?this.cam.rotation.x=c.tiltMax:this.cam.rotation.x=e,this.cam.updateMatrix(),q.call(this),this},o.prototype.scan=function(a,b){return this.mode.scan&&(this.panTilt.translateX(a),this.panTilt.translateY(b),this.panTilt.updateMatrix(),q.call(this)),this},o.prototype.setLookAroundLimits=function(a,b,c,d){return this.lookLimits.panMax=b,this.lookLimits.panMin=a,this.lookLimits.tiltMax=d,this.lookLimits.tiltMin=c,this},o.prototype.setEasing=function(a){return typeof a=="function"?this.easeFunc=[a,a,a]:this.easeFunc=[a.x||this.easeFunc[0],a.y||this.easeFunc[1],a.z||this.easeFunc[2]],this},o.prototype.setEyeTarget=function(a,b){var c=[a.x-b.x,a.y-b.y,a.z-b.z],d=hemi.utils.cartesianToSpherical(c);this.distance=d[0],this.panTilt.position.copy(b),this.panTilt.rotation.y=d[2],this.panTilt.rotation.x=d[1]-hemi.HALF_PI,this.panTilt.updateMatrix(),this.cam.rotation.y=0,this.cam.rotation.x=0,this.cam.position.z=this.distance,this.cam.updateMatrix(),m.set(0,0,this.distance),hemi.utils.pointAsLocal(this.cam,n.copy(b)),hemi.utils.pointZAt(this.cam,m,n),this.cam.rotation.y+=Math.PI,this.cam.updateMatrix(),this.updateWorldMatrices(),this.mode.ortho&&r.call(this)},o.prototype.setLightColor=function(a){return this.light.color.setRGB(a[0],a[1],a[2]),this},o.prototype.setOrthographic=function(){if(!this.mode.ortho){var a=this.threeCamera,b=(a.near+a.far)/2,c=Math.tan(this.fov.current/2)*this.distance,d=c*this.fov.aspect,e=a.parent;while(e.parent!==undefined)e=e.parent;this.mode.ortho=!0,this.threeCamera=new THREE.OrthographicCamera(d*-1,d,c,c*-1,a.near,a.far),this.threeCamera.matrixAutoUpdate=!1,this.light.position=this.threeCamera.position,this.light.rotation=this.threeCamera.rotation,this.light.scale=this.threeCamera.scale,e.remove(a),e.add(this.threeCamera),q.call(this)}return this},o.prototype.setPerspective=function(){if(this.mode.ortho){var a=this.threeCamera,b=a.parent;while(b.parent!==undefined)b=b.parent;this.mode.ortho=!1,this.threeCamera=new THREE.PerspectiveCamera(this.fov.current*hemi.RAD_TO_DEG,this.fov.aspect,a.near,a.far),this.threeCamera.matrixAutoUpdate=!1,this.light.position=this.threeCamera.position,this.light.rotation=this.threeCamera.rotation,this.light.scale=this.threeCamera.scale,b.remove(a),b.add(this.threeCamera),q.call(this)}return this},o.prototype.setZoomLimits=function(a,b){return this.fov.min=a,this.fov.max=b,this.fov.current>this.fov.max&&(this.fov.current=this.fov.max),this.fov.current<this.fov.min&&(this.fov.current=this.fov.min),this},o.prototype.truck=function(a){return this.panTilt.translateZ(-a),this.panTilt.updateMatrix(),q.call(this),this},o.prototype.updateProjection=function(a,b){var c=this.fov.aspect=a/b;this.mode.ortho?r.call(this):this.threeCamera.aspect=c,this.threeCamera.updateProjectionMatrix()},o.prototype.updateWorldMatrices=function(){this.panTilt.updateMatrixWorld(!0)},hemi.makeCitizen(o,"hemi.Camera",{cleanup:o.prototype._clean,toOctane:o.prototype._octane});var s=function(a,b){this.eye=a,this.target=b};s.prototype._clean=function(){this.eye=null,this.target=null},s.prototype._octane=["eye","target"],hemi.makeCitizen(s,"hemi.CameraCurve",{cleanup:s.prototype._clean,toOctane:s.prototype._octane}),hemi.ViewData=function(c){var d=c||{};this.eye=d.eye||new THREE.Vector3(0,0,-1),this.target=d.target||new THREE.Vector3(0,0,0),this.fov=d.fov||b,this.np=d.np||i,this.fp=d.fp||a};var t=function(c){var d=c||{};this.name=d.name||"",this.eye=d.eye||new THREE.Vector3(0,0,-1),this.target=d.target||new THREE.Vector3(0,0,0),this.fov=d.fov||b,this.np=d.np||i,this.fp=d.fp||a};t.prototype._clean=function(){this.eye=null,this.target=null},t.prototype._octane=["eye","target","fov","np","fp"],t.prototype.getData=function(){return new hemi.ViewData(this)},t.prototype.setData=function(a){this.eye=a.eye,this.target=a.target,this.fov=a.fov,this.np=a.np,this.fp=a.fp},hemi.makeCitizen(t,"hemi.Viewpoint",{cleanup:t.prototype._clean,toOctane:t.prototype._octane}),hemi.createViewData=function(a){return new hemi.ViewData({eye:a.getEye(),target:a.getTarget(),fov:a.fov.current,np:a.threeCamera.near,fp:a.threeCamera.far})},hemi.createViewpoint=function(a,b){var c=new hemi.Viewpoint({name:a});return c.setData(this.createViewData(b)),c}}(),function(){function b(a,c){var d=a.children,e;a.geometry?(e=new hemi.Mesh,e.geometry=a.geometry,e.material=a.material,e.boundRadius=a.boundRadius,e.geometry.morphTargets.length&&(e.morphTargetBase=a.morphTargetBase,e.morphTargetForcedOrder=a.morphTargetForcedOrder,e.morphTargetInfluences=a.morphTargetInfluences,e.morphTargetDictionary=a.morphTargetDictionary),this.materials.indexOf(a.material)===-1&&this.materials.push(a.material),this.geometries.indexOf(a.geometry)===-1&&this.geometries.push(a.geometry)):e=new hemi.Transform,e.name=a.name,e.visible=a.visible,e.position=a.position,e.rotation=a.rotation,e.quaternion=a.quaternion,e.scale=a.scale,e.useQuaternion=a.useQuaternion,e.matrix=a.matrix,e.matrixWorld=a.matrixWorld,c[a.id]!==undefined&&(c[a.id]=e);for(var f=0;f<d.length;++f){var g=b.call(this,d[f],c);e.add(g)}return e}function c(a){var b=a.dae.cameras,c=a.dae.visualScenes;for(var d in c)for(var e=0,f=c[d].nodes.length;e<f;e++){var g=c[d].nodes[e];if(g.cameras.length>0){var h=new THREE.Vector3,i=new THREE.Vector3,j=new THREE.Vector3;h=h.getPositionFromMatrix(g.matrix),i=i.getRotationFromMatrix(g.matrix);var k=h.x,l=h.y,m=h.z,n=h.distanceTo(new THREE.Vector3),o=n<1?1:n,p;p=hemi.utils.sphericalToCartesian([o,hemi.HALF_PI-i.x,hemi.HALF_PI-i.z]),k+=p[0],l+=p[2],m-=p[1],j.set(k,l,m);for(var q=0,r=g.cameras.length;q<r;q++){var s=g.cameras[q],t;t=new hemi.Viewpoint,t.name=g.name+"_"+q,t.eye=h,t.target=j,t.np=b[s.url].znear,t.fp=b[s.url].zfar,t.fov=b[s.url].yfov*hemi.DEG_TO_RAD}}}}function d(a,b,c){for(var e=0;e<b.children.length;++e){var f=b.children[e];f.name===a&&c.push(f),d(a,f,c)}}var a=function(a){this._fileName=null,this._loaded=!1,this.animations=[],this.morphs=[],this.skins=[],this.autoLoad=!0,this.client=a,this.geometries=[],this.materials=[],this.root=null};a.prototype._clean=function(){this.unload(),this.client=null},a.prototype._msgSent=[hemi.msg.load,hemi.msg.unload],a.prototype._octane=function(){return[{name:"autoLoad",val:this.autoLoad},{name:"client",id:this.client._getId()},{name:"root",id:this.root._getId()},{name:"setFileName",arg:[this._fileName]}]},a.prototype.getMaxAnimationTime=function(){var a=this.animations,b=null;for(var c=0,d=a.length;c<d;++c){var e=a[c].data.length;if(b===null||b<e)b=e}return b},a.prototype.getMinAnimationTime=function(){var a=this.animations,b=null;for(var c=0,d=a.length;c<d;++c){var e=a[c].data.hierarchy;for(var f=0,g=e.length;f<g;++f){var h=e[f].keys;for(var i=0,j=h.length;i<j;++i){var k=h[i].time;if(b===null||b>k)b=k}}}return b},a.prototype.getTransforms=function(a){var b=[];return d(a,this.root,b),b},a.prototype.getTransform=function(a){var b=[],c=null;d(a,this.root,b);var e=b.length;return e>0&&(c=b[0],e>1&&console.log("Warning: found "+e+" transforms with name "+a)),c},a.prototype.load=function(a){a=a||{},a.modelFileName&&(this._fileName=a.modelFileName),this._loaded&&this.unload();var d=this,e=function(a){var e=THREE.AnimationHandler,f=a.animations||[],g=a.scene?a.scene:a.materials.length>0?new hemi.Mesh(a,new THREE.MeshFaceMaterial):new hemi.Mesh(a,new THREE.MeshLambertMaterial({color:16777215,overdraw:!0})),h={};d.morphs=a.morphs,d.skins=a.skins,d._loaded=!0;for(var i=0,j=f.length;i<j;++i){var k=f[i].node;h[k.id]=k}if(d.root===null)if(g instanceof hemi.Mesh){d.root=g;if(a.materials)for(var l=0,m=a.materials.length;l<m;l++){var n=a.materials[l];d.materials.indexOf(n)===-1&&d.materials.push(n)}}else d.root=b.call(d,g,h);else d.root._init(g,h,d);d.client.scene.add(d.root);for(var i=0,j=f.length;i<j;++i){var o=f[i],p;e.add(o),p=new THREE.KeyFrameAnimation(h[o.node.id],o.name),p.timeScale=1,d.animations.push(p)}a.dae&&c(a),d.send(hemi.msg.load,{root:g})},f=this._fileName.split(".").pop();switch(f.toLowerCase()){case"utf8":hemi.loadUTF8(this._fileName,e,a);break;case"dae":hemi.loadCollada(this._fileName,e,a);break;default:var g=this;hemi.utils.get(hemi.getLoadPath(this._fileName),function(a,b){var c=JSON.parse(a);c.buffers!==undefined?hemi.loadBinary(g._fileName,e):hemi.loadJson(g._fileName,e)},"application/json")}},a.prototype.setFileName=function(a){this._fileName=a,this.autoLoad&&this.load()},a.prototype.unload=function(){this.send(hemi.msg.unload,{root:this.root}),this.root&&(this.root.cleanup(),this.root=null),this._loaded=!1,this.animations=[],this.geometries=[],this.materials=[]},a.prototype.setVisible=function(a){var b=this.root.getAllChildren();for(var c=0;c<b.length;++c)b[c].visible=a;this.root.visible=a},hemi.makeCitizen(a,"hemi.Model",{cleanup:a.prototype._clean,toOctane:a.prototype._octane})}(),function(){function d(a,b){for(var c=0,e=a.length;c<e;++c){var f=a[c];b.push(f),f.children.length>0&&d(f.children,b)}}var a=new THREE.Projector,b=new THREE.Ray,c=new THREE.Vector3;b.setPrecision(1e-6),hemi.Picker=function(a,b){this.camera=b,this.scene=a,this.height=1,this.width=1,this.pickGrabber=null,hemi.input.addMouseDownListener(this)},hemi.Picker.prototype.cleanup=function(){hemi.input.removeMouseDownListener(this),this.camera=null,this.pickGrabber=null,this.scene=null},hemi.Picker.prototype.onMouseDown=function(e){var f=e.x/this.width*2-1,g=-(e.y/this.height)*2+1,h=this.camera.threeCamera.position,i=[];c.set(f,g,1),a.unprojectVector(c,this.camera.threeCamera),b.origin.copy(h),b.direction.copy(c.subSelf(h).normalize()),d(this.scene.children,i);var j=b.intersectObjects(i);if(j.length>0)for(var k=0;k<j.length;++k){var l=j[k];if(l.object.pickable){var m=l.object.parent.matrixWorld.multiplyVector3(l.point.clone()),n={mouseEvent:e,pickedMesh:l.object,worldIntersectionPosition:m};this.pickGrabber!==null?this.pickGrabber.onPick(n):hemi.send(hemi.msg.pick,n);break}}},hemi.Picker.prototype.removePickGrabber=function(){var a=this.pickGrabber;return this.pickGrabber=null,a},hemi.Picker.prototype.setPickGrabber=function(a){this.pickGrabber=a}}(),function(){var a=new THREE.Projector,b=function(a){this._bgAlpha=1,this._bgColor=0,this.camera=a?new hemi.Camera:null,this.scene=a?new hemi.Scene:null,this.picker=new hemi.Picker(this.scene,this.camera),this.renderer=null,a&&(this.useCameraLight(!0),this.scene.add(this.camera.threeCamera)),hemi.clients.push(this)};b.prototype._clean=function(){var a=hemi.clients.indexOf(this);a!==-1&&hemi.clients.splice(a,1),this.picker.cleanup(),this.picker=null,this.camera=null,this.scene=null,this.renderer=null},b.prototype._init=function(a){var b=hemi._getRenderer(a);b?this.setRenderer(b):console.log("Unable to find renderer for Client with id "+client._getId())},b.prototype._octane=function(){return[{name:"_bgColor",val:this._bgColor},{name:"_bgAlpha",val:this._bgAlpha},{name:"setScene",arg:[hemi.dispatch.ID_ARG+this.scene._getId()]},{name:"setCamera",arg:[hemi.dispatch.ID_ARG+this.camera._getId()]},{name:"_init",arg:[this.renderer.domElement.parentNode.id]}]},b.prototype._resize=function(){var a=this.renderer.domElement,b=a.clientWidth>1?a.clientWidth:1,c=a.clientHeight>1?a.clientHeight:1;this.renderer.setSize(b,c),this.camera.updateProjection(b,c),this.picker.width=b,this.picker.height=c},b.prototype.addGrid=function(a,b){var c=new THREE.LineBasicMaterial({color:13421772,opacity:.2}),d=new THREE.Geometry,e=-0.04;for(var f=0,g=a/b*2;f<=g;++f)d.vertices.push(new THREE.Vertex(-a,e,f*b-a)),d.vertices.push(new THREE.Vertex(a,e,f*b-a)),d.vertices.push(new THREE.Vertex(f*b-a,e,-a)),d.vertices.push(new THREE.Vertex(f*b-a,e,a));var h=new THREE.Line(d,c,THREE.LinePieces);this.scene.add(h)},b.prototype.castRay=function(b,c){var d=this.renderer.domElement,e=b/d.clientWidth*2-1,f=-(c/d.clientHeight)*2+1,g=new THREE.Vector3(e,f,.5),h=this.camera.threeCamera;return a.unprojectVector(g,h),g.subSelf(h.position).normalize(),new THREE.Ray(h.position,g)},b.prototype.getWidth=function(){return this.renderer.domElement.clientWidth},b.prototype.getHeight=function(){return this.renderer.domElement.clientHeight},b.prototype.onRender=function(){this.renderer.render(this.scene,this.camera.threeCamera)},b.prototype.setBGColor=function(a,b){this._bgColor=a,this._bgAlpha=b===undefined?1:b,this.renderer.setClearColorHex(this._bgColor,this._bgAlpha)},b.prototype.setCamera=function(a){this.scene&&(this.camera&&(this.scene.remove(this.camera.threeCamera),this.scene.remove(this.camera.light)),this.scene.add(a.threeCamera),this.scene.add(a.light)),this.camera&&this.camera.cleanup(),this.picker.camera=a,this.camera=a},b.prototype.setRenderer=function(a){a.setClearColorHex(this._bgColor,this._bgAlpha),this.renderer=a,this._resize(),hemi.hudManager.addClient(this)},b.prototype.setScene=function(a){this.scene&&(this.camera&&(this.scene.remove(this.camera.threeCamera),this.scene.remove(this.camera.light)),this.scene.cleanup()),this.camera&&(a.add(this.camera.threeCamera),a.add(this.camera.light)),this.picker.scene=a,this.scene=a},b.prototype.useCameraLight=function(a){a?this.scene.add(this.camera.light):this.scene.remove(this.camera.light)},hemi.makeCitizen(b,"hemi.Client",{cleanup:b.prototype._clean,toOctane:b.prototype._octane});var c=function(a,c){b.call(this,a),this._bottom=0,this._height=1,this._left=0,this._width=1,this.bounds=c||[0,1,0,1]},d=c.prototype=new b;c.constructor=c,hemi.clients.splice(hemi.clients.indexOf(d),1),d.picker.cleanup(),c.prototype._resize=function(){var a=this.renderer.domElement,b=a.clientWidth>1?a.clientWidth:1,c=a.clientHeight>1?a.clientHeight:1;this.renderer.setSize(b,c),this._bottom=Math.floor(c*this.bounds[0]),this._height=Math.ceil(c*this.bounds[1]),this._left=Math.floor(b*this.bounds[2]),this._width=Math.ceil(b*this.bounds[3]),this.camera.updateProjection(this._width,this._height),this.picker.width=this._width,this.picker.height=this._height},c.prototype.onRender=function(){this.renderer.setViewport(this._left,this._bottom,this._width,this._height),this.renderer.setScissor(this._left,this._bottom,this._width,this._height),this.renderer.setClearColorHex(this._bgColor,this._bgAlpha),this.renderer.render(this.scene,this.camera.threeCamera)},hemi.makeCitizen(c,"hemi.SharedClient",{cleanup:c.prototype._clean,toOctane:c.prototype._octane})}(),function(){function c(){for(var a=0,b=this.loops.length;a<b;++a){var c=this.loops[a];c._current!==c.iterations&&this._currentTime>=c.stopTime&&(this._currentTime=c.startTime,c._current++)}}var a=function(){this._current=0,this.iterations=-1,this.name="",this.startTime=0,this.stopTime=0};a.prototype._octane=["iterations","name","startTime","stopTime"],hemi.Loop=a,hemi.makeOctanable(hemi.Loop,"hemi.Loop",hemi.Loop.prototype._octane);var b=function(a,b,c){this._currentTime=a?a:0,this._isAnimating=!1,this.model=c?c:null,this.beginTime=a?a:0,this.endTime=b?b:0,this.loops=[]};b.prototype._clean=function(){this._isAnimating&&this.stop(),this.model=null,this.loops=[]},b.prototype._msgSent=[hemi.msg.animate,hemi.msg.start,hemi.msg.stop],b.prototype._octane=["beginTime","endTime","loops","reset","model"],b.prototype.addLoop=function(a){this.loops.indexOf(a)===-1&&this.loops.push(a)},b.prototype.onRender=function(a){var b=this._currentTime,d=a.elapsedTime;this._currentTime+=d,c.call(this),this._currentTime!==b+d&&(d=0);var e=[];if(this.model){e=this.model.animations;if(d===0){this.send(hemi.msg.animate,{previous:this._currentTime,time:this._currentTime});for(var f=0,g=e.length;f<g;++f)e[f].stop();for(var f=0,g=e.length;f<g;++f)e[f].play(!1,this._currentTime)}else{this.send(hemi.msg.animate,{previous:b,time:this._currentTime}),this._currentTime>=this.endTime&&(d=this.endTime-b,this.stop(),this.reset());for(var f=0,g=e.length;f<g;++f)e[f].update(d)}}},b.prototype.removeLoop=function(a){var b=this.loops.indexOf(a),c=null;return b!==-1&&(c=this.loops.splice(b,1)[0]),c},b.prototype.reset=function(){this._currentTime=this.beginTime;for(var a=0,b=this.loops.length;a<b;++a)this.loops[a]._current=0},b.prototype.start=function(){if(!this._isAnimating){var a=[];if(this.model){a=this.model.animations;for(var b=0,c=a.length;b<c;++b){var d=a[b];for(var e=0,f=d.hierarchy.length;e<f;e++){var g=d.data.hierarchy[e].keys,h=d.data.hierarchy[e].sids,i=d.hierarchy[e];if(g.length&&h){for(var j=0;j<h.length;j++){var k=h[j],l=d.getNextKeyWith(k,e,0);l&&l.apply(k)}i.matrixAutoUpdate=!1,d.data.hierarchy[e].node.updateMatrix(),i.matrixWorldNeedsUpdate=!0}}d.play(!1,this._currentTime)}this._isAnimating=!0,hemi.addRenderListener(this),this.send(hemi.msg.start,{})}}},b.prototype.stop=function(){if(this._isAnimating){var a=[];if(this.model){a=this.model.animations;for(var b=0,c=a.length;b<c;++b)a[b].stop();hemi.removeRenderListener(this),this._isAnimating=!1,this.send(hemi.msg.stop,{})}}},hemi.makeCitizen(b,"hemi.AnimationGroup",{cleanup:b.prototype._clean,toOctane:b.prototype._octane})}(),function(){function g(a){var b=function(a,c){c.acceleration=[b.factor[0]*c.velocity[0],b.factor[1]*c.velocity[1],b.factor[2]*c.velocity[2]]};return b.factor=a.factor===undefined?[0,0,0]:a.factor,b}function h(a){var b=function(a,c){var d=Math.random()*2*Math.PI,e=.8*b.size,f=-0.003*b.size;c.velocity=hemi.core.math.matrix4.transformPoint(hemi.core.math.matrix4.rotationY(7*d),[e,e,e]),c.velocity=hemi.core.math.matrix4.transformPoint(hemi.core.math.matrix4.rotationX(d),c.velocity),c.acceleration=hemi.core.math.mulVectorVector(c.velocity,[f,f,f]),c.acceleration=hemi.core.math.addVector(c.acceleration,b.wind)};return b.wind=a.wind===undefined?[0,0,0]:a.wind,b.size=a.size===undefined?1:a.size,b}var a=new hemi.particles.System,b=new THREE.Vector3;hemi.addRenderListener({isParticleSystem:!0,onRender:function(b){a.update(b.elapsedTime)}}),hemi.ParticleFunctionIds={Acceleration:"Acceleration",Puff:"Puff"};var c=function(){this.name=null,this.options={}};hemi.ParticleFunction=c,hemi.makeOctanable(hemi.ParticleFunction,"hemi.ParticleFunction",["name","options"]);var d=function(a){this._newSystem=!1,this._system=null,this.blending=THREE.AdditiveBlending,this.client=a,this.colorRamp=[],this.params={},this.particleFunction=null,this.particles=null,this.transform=null};d.prototype._clean=function(){var a=this._system.emitters,b=a.indexOf(this.particles);a.splice(b,1),this.transform&&this.transform.parent.remove(this.transform),this.transform=null,this.particles=null},d.prototype._msgSent=[hemi.msg.visible],d.prototype._octane=["_newSystem","blending","client","colorRamp","params","particleFunction","setup"],d.prototype.hide=function(){this.particles===null&&this.setup(),this.transform.visible&&(this.transform.visible=!1,this.send(hemi.msg.visible,{visible:!1}))},d.prototype.setup=function(){var b=hemi.utils.clone(this.params),c=null,d=null;this.particleFunction!==null&&(c=hemi.getParticleFunction(this.particleFunction)),b.position&&(d=b.position,b.position=[0,0,0]),this._system=this._newSystem?new hemi.particles.System:a,this.particles=this._system.createEmitter(this.client.camera.threeCamera),this.particles.setBlending(this.blending),this.particles.setColorRamp(this.colorRamp),this.particles.setParameters(b,c),this.transform=new THREE.Mesh(this.particles.shape,this.particles.material),this.transform.doubleSided=!0,this.transform.matrixAutoUpdate=!1,d!==null&&(this.transform.position.set(d[0],d[1],d[2]),this.transform.updateMatrix()),this.client.scene.add(this.transform)},d.prototype.show=function(){this.particles===null&&this.setup(),this.transform.visible||(this.transform.visible=!0,this.send(hemi.msg.visible,{visible:!0}))},hemi.makeCitizen(d,"hemi.ParticleEmitter",{cleanup:d.prototype._clean,toOctane:d.prototype._octane});var e=function(a){d.call(this,a),this.oneShot=null};e.prototype=new d,e.constructor=e,e.prototype._clean=function(){d.prototype._clean.call(this),this.oneShot=null},e.prototype._msgSent=d.prototype._msgSent.concat([hemi.msg.burst]),e.prototype.setup=function(){var b=hemi.utils.clone(this.params),c=null,d=null;this.particleFunction!==null&&(c=hemi.getParticleFunction(this.particleFunction)),b.position&&(d=b.position,b.position=[0,0,0]),this._system=this._newSystem?new hemi.particles.System:a,this.particles=this._system.createEmitter(this.client.camera.threeCamera),this.particles.setBlending(this.blending),this.particles.setColorRamp(this.colorRamp),this.particles.setParameters(b,c),this.transform=new THREE.Object3D,this.transform.matrixAutoUpdate=!1,d!==null&&(this.transform.position.set(d[0],d[1],d[2]),this.transform.updateMatrix()),this.client.scene.add(this.transform),this.oneShot=this.particles.createOneShot(this.transform)},e.prototype.trigger=function(){this.oneShot===null&&this.setup();var a=this.params.position;this.oneShot.trigger(b.set(a[0],a[1],a[2])),this.send(hemi.msg.burst,{position:this.params.position})},hemi.makeCitizen(e,"hemi.ParticleBurst",{cleanup:e.prototype._clean,toOctane:e.prototype._octane});var f=function(a){d.call(this,a),this.isAnimating=!1,this.fireInterval=1,this.count=0};f.prototype=new d,f.constructor=f,f.prototype._msgSent=d.prototype._msgSent.concat([hemi.msg.start,hemi.msg.stop]),f.prototype._octane=["fireInterval"].concat(d.prototype._octane),f.prototype.onRender=function(a){this.count+=a.elapsedTime,this.count>=this.fireInterval&&(this.count=0,this.particles.birthParticles([0,0,0]))},f.prototype.setup=function(){this.params.timeRange=undefined;var b=hemi.utils.clone(this.params),c=null,d=null,e=this.params.numParticles||1,f=this.params.lifeTime||1+this.params.lifeTimeRange||0,g=f/this.fireInterval+1,h=Math.ceil(g*e);this.particleFunction!==null&&(c=hemi.getParticleFunction(this.particleFunction)),b.position&&(d=b.position,b.position=[0,0,0]),this._system=this._newSystem?new hemi.particles.System:a,this.particles=this._system.createTrail(this.client.camera.threeCamera,h,b,null,c),this.particles.setBlending(this.blending),this.particles.setColorRamp(this.colorRamp),this.transform=new THREE.Mesh(this.particles.shape,this.particles.material),this.transform.doubleSided=!0,this.transform.matrixAutoUpdate=!1,d!==null&&(this.transform.position.set(d[0],d[1],d[2]),this.transform.updateMatrix()),this.client.scene.add(this.transform)},f.prototype.start=function(){this.particles===null&&this.setup(),this.isAnimating||(this.isAnimating=!0,hemi.addRenderListener(this),this.send(hemi.msg.start,{}))},f.prototype.stop=function(){this.particles===null&&this.setup(),this.isAnimating&&(hemi.removeRenderListener(this),this.isAnimating=!1,this.count=0,this.send(hemi.msg.stop,{}))},hemi.makeCitizen(f,"hemi.ParticleTrail",{cleanup:f.prototype._clean,toOctane:f.prototype._octane}),hemi.createParticleEmitter=function(a,b,c,d,e){var f=new hemi.ParticleEmitter(a);return f.colorRamp=b,f.params=c,d!==undefined&&(f.blending=d),e!==undefined&&(f.particleFunction=e),f.setup(),f},hemi.createParticleBurst=function(a,b,c,d,e){var f=new hemi.ParticleBurst(a);return f.colorRamp=b,f.params=c,d!==undefined&&(f.blending=d),e!==undefined&&(f.particleFunction=e),f.setup(),f},hemi.createParticleTrail=function(a,b,c,d,e,f){var g=new hemi.ParticleTrail(a);return g.colorRamp=b,g.params=c,g.fireInterval=d,e!==undefined&&(g.blending=e),f!==undefined&&(g.particleFunction=f),g.setup(),g},hemi.getParticleFunction=function(a){var b;switch(a.name){case hemi.ParticleFunctionIds.Acceleration:b=g(a.options);break;case hemi.ParticleFunctionIds.Puff:b=h(a.options);break;default:b=null}return b}}(),function(){var a=function(){this.isLoaded=!1,this.next=null,this.prev=null};a.prototype._clean=function(){this.next!==null&&(this.next.prev=this.prev),this.prev!==null&&(this.prev.next=this.next),this.next=null,this.prev=null},a.prototype.load=function(){this.isLoaded||(this.isLoaded=!0,this.send(hemi.msg.load,{}))},a.prototype.unload=function(){this.isLoaded&&(this.isLoaded=!1,this.send(hemi.msg.unload,{}))},a.prototype.nextState=function(){this.isLoaded&&this.next!=null&&(this.unload(),this.next.load())},a.prototype.previousState=function(){this.isLoaded&&this.prev!=null&&(this.unload(),this.prev.load())},a.prototype._octane=["next","prev"],a.prototype._msgSent=[hemi.msg.load,hemi.msg.unload],hemi.makeCitizen(a,"hemi.State",{toOctane:a.prototype._octane,cleanup:a.prototype._clean})}(),function(){function k(a){return"rgba("+Math.round(a[0]*255)+","+Math.round(a[1]*255)+","+Math.round(a[2]*255)+","+a[3]+")"}function l(a,b){var c=b.textStyle==null?"":b.textStyle+" ";b.textSize!=null?c+=b.textSize+"px ":c+="12px ",b.textTypeface!=null?c+='"'+b.textTypeface+'"':c+="helvetica",a.font=c,b.textAlign!=null&&(a.textAlign=b.textAlign),b.color!=null&&(a.fillStyle=k(b.color));if(b.outline!=null)a.strokeStyle=k(b.outline),a.shadowColor="rgba(0,0,0,0)";else if(b.shadow!=null){var d=b.shadow;a.shadowBlur=d.radius,a.shadowColor=k(d.color),a.shadowOffsetX=d.offsetX,a.shadowOffsetY=d.offsetY}else a.shadowColor="rgba(0,0,0,0)"}var a=function(){this.image={shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,1]}},this.page={color:[0,0,0,.45],curve:0,shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,0]},outline:null},this.text={textSize:12,textTypeface:"helvetica",textAlign:"center",textStyle:"bold",strictWrapping:!0,lineMargin:5,color:[1,1,.6,1],shadow:{radius:.5,offsetY:1,offsetX:1,color:[0,0,0,1]},outline:null},this.video={shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,1]}}};a.prototype._octane=["image","page","text","load"],a.prototype.load=function(){hemi.setHudTheme(this)},hemi.HudTheme=a,hemi.makeOctanable(hemi.HudTheme,"hemi.HudTheme",hemi.HudTheme.prototype._octane);var b=function(){this._bottom=0,this._left=0,this._right=0,this._top=0,this.config={},this.mouseDown=null,this.mouseUp=null,this.mouseMove=null,this.visible=!0};b.prototype._checkEvent=function(a){return a.x<=this._right&&a.x>=this._left&&a.y<=this._bottom&&a.y>=this._top},b.prototype._octane=["_bottom","_left","_right","_top","config"],b.prototype.cleanup=function(){this.mouseDown=null,this.mouseUp=null,this.mouseMove=null,this.config={}},b.prototype.onMouseDown=function(a){var b=this._checkEvent(a);return b&&this.mouseDown&&this.mouseDown(a),b},b.prototype.onMouseMove=function(a){if(this.mouseMove){var b=this._checkEvent(a);this.mouseMove(a,b)}},b.prototype.onMouseUp=function(a){var b=this._checkEvent(a);return b&&this.mouseUp&&this.mouseUp(a),b};var c=function(){b.call(this),this._text=[],this._width=0,this._wrappedHeight=0,this._wrappedText=[],this._wrappedWidth=0,this.x=0,this.y=0,this.percentX=null,this.percentY=null};c.prototype=new b,c.constructor=c,c.prototype._octane=b.prototype._octane.concat(["_text","_width","x","y","wrapText","percentX","percentY"]),c.prototype.calculateBounds=function(){var a;this.config.textAlign!=null?a=this.config.textAlign.toLowerCase():a=j.text.textAlign.toLowerCase(),this._top=this.y,this._bottom=this._top+this._wrappedHeight;switch(a){case"left":this._left=this.x,this._right=this._left+this._wrappedWidth;break;case"right":this._right=this.x,this._left=this._right-this._wrappedWidth;break;default:var b=this._wrappedWidth/2;this._left=this.x-b,this._right=this.x+b}},c.prototype.draw=function(){hemi.hudManager.createTextOverlay(this,this.config)},c.prototype.setConfig=function(a){this.config=a,this.wrapText()},c.prototype.setText=function(a){this._text=hemi.utils.isArray(a)?a:[a],this.wrapText()},c.prototype.setWidth=function(a){this._width=a,this.wrapText()},c.prototype.wrapText=function(){if(this._width<=0||this._text.length===0)return;var a=0,b=0,c=[];for(var d=0,e=this._text.length;d<e;++d){var f=hemi.hudManager.doTextWrapping(this._text[d],this._width,this.config);f.width>a&&(a=f.width),b+=f.height,c=c.concat(f.text)}this._wrappedWidth=a,this._wrappedHeight=b,this._wrappedText=c},hemi.HudText=c,hemi.makeOctanable(hemi.HudText,"hemi.HudText",hemi.HudText.prototype._octane);var d=function(){b.call(this),this._height=0,this._image=null,this._width=0,this.srcX=0,this.srcY=0,this.url=null,this.x=0,this.y=0,this.percentX=null,this.percentY=null};d.prototype=new b,d.constructor=d,d.prototype._octane=b.prototype._octane.concat(["srcX","srcY","url","x","y","loadImage","percentX","percentY"]),d.prototype.calculateBounds=function(){this._top=this.y,this._bottom=this._top+this._height,this._left=this.x,this._right=this._left+this._width},d.prototype.cleanup=function(){b.prototype.cleanup.call(this),this._image=null},d.prototype.draw=function(){hemi.hudManager.createImageOverlay(this,this.config)},d.prototype.loadImage=function(a){var b=this;hemi.loadImage(this.url,function(c){b._image=c,b._height=c.height,b._width=c.width,a&&a(b)})},d.prototype.setUrl=function(a,b){this.url=a,this.loadImage(b)},hemi.HudImage=d,hemi.makeOctanable(hemi.HudImage,"hemi.HudImage",hemi.HudImage.prototype._octane);var e=function(){b.call(this),this.disabledImg=null,this.enabled=!0,this.enabledImg=null,this.hovering=!1,this.hoverImg=null,this.selected=!1,this.selectedImg=null,this.x=0,this.y=0;var a=this;this.mouseMove=function(b,c){if(!a.enabled||a.selected)return;c?a.hovering||(a.hovering=!0,a.draw()):a.hovering&&(a.hovering=!1,a.draw())}};e.prototype=new b,e.constructor=e,e.prototype._octane=b.prototype._octane.concat(["disabledImg","enabledImg","hoverImg","selectedImg","x","y"]),e.prototype.calculateBounds=function(){var a=this.getImage();this._top=this.y,this._bottom=this._top+a._height,this._left=this.x,this._right=this._left+a._width},e.prototype.cleanup=function(){b.prototype.cleanup.call(this),this.mouseMove=null,this.enabledImg&&(this.enabledImg.cleanup(),this.enabledImg=null),this.disabledImg&&(this.disabledImg.cleanup(),this.disabledImg=null),this.selectedImg&&(this.selectedImg.cleanup(),this.selectedImg=null),this.hoverImg&&(this.hoverImg.cleanup(),this.hoverImg=null)},e.prototype.draw=function(){var a=this.getImage();a.x=this.x,a.y=this.y,a.draw()},e.prototype.getImage=function(){var a=this.enabledImg;return this.enabled?this.selected?this.selectedImg&&(a=this.selectedImg):this.hovering&&this.hoverImg&&(a=this.hoverImg):this.disabledImg&&(a=this.disabledImg),a},e.prototype.select=function(a){this.selected=a,this.draw()},e.prototype.setSrcCoords=function(a){var b=a.disabled,c=a.enabled,d=a.hover,e=a.selected;c!=null&&(this.enabledImg===null&&(this.enabledImg=new hemi.HudImage),this.enabledImg.srcX=c[0],this.enabledImg.srcY=c[1]),b!=null&&(this.disabledImg===null&&(this.disabledImg=new hemi.HudImage),this.disabledImg.srcX=b[0],this.disabledImg.srcY=b[1]),d!=null&&(this.hoverImg===null&&(this.hoverImg=new hemi.HudImage),this.hoverImg.srcX=d[0],this.hoverImg.srcY=d[1]),e!=null&&(this.selectedImg===null&&(this.selectedImg=new hemi.HudImage),this.selectedImg.srcX=e[0],this.selectedImg.srcY=e[1])},e.prototype.setUrls=function(a){var b=a.disabled,c=a.enabled,d=a.hover,e=a.selected;b!=null&&(this.disabledImg=new hemi.HudImage,this.disabledImg.setUrl(b)),c!=null&&(this.enabledImg=new hemi.HudImage,this.enabledImg.setUrl(c)),d!=null&&(this.hoverImg=new hemi.HudImage,this.hoverImg.setUrl(d)),e!=null&&(this.selectedImg=new hemi.HudImage,this.selectedImg.setUrl(e))},hemi.HudButton=e,hemi.makeOctanable(hemi.HudButton,"hemi.HudButton",hemi.HudButton.prototype._octane);var f=function(){b.call(this),this._height=0,this._urls=[],this._video=document.createElement("video"),this._width=0,this.x=0,this.y=0;var a=this._video,c=this;this._video.onloadeddata=function(){c._height===0?c._height=a.videoHeight:a.setAttribute("height",""+c._height),c._width===0?c._width=a.videoWidth:a.setAttribute("width",""+c._width)}};f.prototype=new b,f.constructor=f,f.prototype._octane=function(){var a=b.protothype._octane.concat(["x","y"]);for(var c=0,d=this._urls.length;c<d;++c){var e=this._urls[c];a.push({name:"addUrl",arg:[e.url,e.type]})}return a},f.prototype.addUrl=function(a,b){var c=document.createElement("source"),d=hemi.getLoadPath(a);c.setAttribute("src",d),c.setAttribute("type","video/"+b),this._video.appendChild(c),this._urls.push({url:a,type:b,node:c})},f.prototype.calculateBounds=function(){this._top=this.y,this._bottom=this._top+this._height,this._left=this.x,this._right=this._left+this._width},f.prototype.cleanup=function(){b.prototype.cleanup.call(this),this._video=null,this._urls=[]},f.prototype.draw=function(){hemi.hudManager.createVideoOverlay(this,this.config)},f.prototype.removeUrl=function(a){for(var b=0,c=this._urls.length;b<c;++b){var d=this._urls[b];if(d.url===a){this._video.removeChild(d.node),this._urls.splice(b,1);break}}},f.prototype.setHeight=function(a){this._height=a,this._video!==null&&this._video.setAttribute("height",""+a)},f.prototype.setWidth=function(a){this._width=a,this._video!==null&&this._video.setAttribute("width",""+a)},hemi.HudVideo=f,hemi.makeOctanable(hemi.HudVideo,"hemi.HudVideo",hemi.HudVideo.prototype._octane);var g=function(){b.call(this),this.auto=!0,this.drawBackground=!0,this.margin=5,this.elements=[]};g.prototype=new b,g.constructor=g,g.prototype._octane=b.prototype._octane.concat(["auto","drawBackground","elements","margin"]),g.prototype.add=function(a){this.elements.indexOf(a)===-1&&this.elements.push(a)},g.prototype.calculateBounds=function(){var a,b=this.elements.length;if(b===0){this._top=0,this._bottom=0,this._left=0,this._right=0;return}for(a=0;a<b;a++)this.elements[a].calculateBounds();if(this.auto){var c=this.elements[0];this._top=c._top,this._bottom=c._bottom,this._left=c._left,this._right=c._right;for(a=1;a<b;a++)c=this.elements[a],c._top<this._top&&(this._top=c._top),c._bottom>this._bottom&&(this._bottom=c._bottom),c._left<this._left&&(this._left=c._left),c._right>this._right&&(this._right=c._right);this._top-=this.margin,this._bottom+=this.margin,this._left-=this.margin,this._right+=this.margin}},g.prototype.cleanup=function(){b.prototype.cleanup.call(this);for(var a=0,c=this.elements.length;a<c;++a)this.elements[a].cleanup();this.elements=[]},g.prototype.clear=function(){this.elements=[]},g.prototype.draw=function(){this.calculateBounds(),this.drawBackground&&hemi.hudManager.createRectangleOverlay(this,this.config);for(var a=0,b=this.elements.length;a<b;++a)this.elements[a].visible&&this.elements[a].draw()},g.prototype.onMouseDown=function(a){if(!this.visible)return!1;var b=this._checkEvent(a);if(b||!this.auto){var c=!1;for(var d=0,e=this.elements.length;d<e&&!c;++d)this.elements[d].visible&&(c=this.elements[d].onMouseDown(a));b&&!c&&this.mouseDown&&this.mouseDown(a)}return b},g.prototype.onMouseMove=function(a){if(!this.visible)return;for(var b=0,c=this.elements.length;b<c;++b)this.elements[b].visible&&this.elements[b].onMouseMove(a);if(this.mouseMove){var d=this._checkEvent(a);this.mouseMove(a,d)}},g.prototype.onMouseUp=function(a){var b=this._checkEvent(a);if(b||!this.auto){var c=!1,d=this.elements.length;for(var e=0,f=this.elements.length;e<f&&!c;++e)c=this.elements[e].onMouseUp(a);b&&!c&&this.mouseUp&&this.mouseUp(a)}return b},g.prototype.remove=function(a){var b=this.elements.indexOf(a),c=null;return b!==-1&&(c=this.elements.splice(b,1)[0]),c},g.prototype.setSize=function(a,b,c,d){this._top=a,this._bottom=b,this._left=c,this._right=d,this.auto=!1},hemi.HudPage=g,hemi.makeOctanable(hemi.HudPage,"hemi.HudPage",hemi.HudPage.prototype._octane);var h=function(a){this._visible=!1,this.client=a,this.currentPage=0,this.pages=[]};h.prototype._clean=function(){for(var a=0,b=this.pages.length;a<b;++a)this.pages[a].cleanup();this.pages=[]},h.prototype._msgSent=[hemi.msg.visible],h.prototype._octane=["client","pages"],h.prototype.add=function(a){this.pages.indexOf(a)===-1&&this.pages.push(a)},h.prototype.clear=function(){this._visible&&this.hide(),this.pages=[]},h.prototype.getCurrentPage=function(){return this.currentPage<this.pages.length?this.pages[this.currentPage]:null},h.prototype.getNumberOfPages=function(){return this.pages.length},h.prototype.hide=function(){this._visible&&(hemi.input.removeMouseMoveListener(this),hemi.input.removeMouseUpListener(this),hemi.input.removeMouseDownListener(this),hemi.hudManager.clearDisplay(),this._visible=!1,this.currentPage=0,this.send(hemi.msg.visible,{page:0}))},h.prototype.onMouseDown=function(a){var b=this.getCurrentPage(),c=!1;return b&&(c=b.onMouseDown(a)),c},h.prototype.onMouseMove=function(a){var b=this.getCurrentPage();b&&b.onMouseMove(a)},h.prototype.onMouseUp=function(a){var b=this.getCurrentPage(),c=!1;return b&&(c=b.onMouseUp(a)),c},h.prototype.nextPage=function(){var a=this.pages.length;this.currentPage++,this.currentPage>=a?this.currentPage=a-1:this.showPage()},h.prototype.previousPage=function(){this.currentPage--,this.currentPage<0?this.currentPage=0:this.showPage()},h.prototype.remove=function(a){var b=this.pages.indexOf(a),c=null;return b!==-1&&(this._visible&&b===this.currentPage&&(b!==0?this.previousPage():this.pages.length>1?this.nextPage():this.hide()),c=this.pages.splice(b,1)[0]),c},h.prototype.show=function(){this._visible||(this._visible=!0,hemi.input.addMouseDownListener(this),hemi.input.addMouseUpListener(this),hemi.input.addMouseMoveListener(this)),this.showPage()},h.prototype.showPage=function(){if(!this.client)return;hemi.hudManager.setClient(this.client),hemi.hudManager.clearDisplay();var a=this.getCurrentPage();a.draw(),this.send(hemi.msg.visible,{page:this.currentPage+1})},hemi.makeCitizen(h,"hemi.HudDisplay",{cleanup:h.prototype._clean,toOctane:h.prototype._octane});var i=function(){this._contexts={},this._videos=[],this.currentContext=null,hemi.addRenderListener(this)};i.prototype.addClient=function(a){var b=a.renderer.domElement,c=b.parentNode,d=c.id+"_hudCanvas",e=c.firstChild,f;while(e&&e.id!==d)e=e.nextSibling;if(!e){e=document.createElement("canvas"),e.id=d,e.height=b.height,e.width=b.width;var g=e.style;g.left=b.offsetLeft+"px",g.position="absolute",g.top=b.offsetTop+"px",g.zIndex="10",e.addEventListener("DOMMouseScroll",hemi.input.scroll,!0),e.addEventListener("mousewheel",hemi.input.scroll,!0),e.addEventListener("mousedown",hemi.input.mouseDown,!0),e.addEventListener("mousemove",hemi.input.mouseMove,!0),e.addEventListener("mouseup",hemi.input.mouseUp,!0),c.appendChild(e)}var f=e.getContext("2d"),h=this;f.textBaseline="top",this._contexts[a._getId()]=f,this.currentContext=f,a.subscribe(hemi.msg.cleanup,function(a){h._contexts[a.src._getId()]=undefined})},i.prototype.clearDisplay=function(){var a=this.currentContext,b=a.canvas,c=this._videos;this._videos=[];for(var d=0,e=c.length;d<e;++d)c[d].video.pause();a.clearRect(0,0,b.width,b.height),a.beginPath()},i.prototype.createRectangleOverlay=function(a,b){var c=hemi.utils.join({},j.page,b),d=this.currentContext;d.save(),l(d,c);if(c.curve>0){var e=c.curve<=1?c.curve/2:.5;this.drawRoundRect(a,e,!0),c.outline!=null&&this.drawRoundRect(a,e,!1)}else{var f=a._left,g=a._top,h=a._right-f,i=a._bottom-g;d.fillRect(f,g,h,i),c.outline!=null&&d.strokeRect(f,g,h,i)}d.restore()},i.prototype.createTextOverlay=function(a,b){var c=hemi.utils.join({},j.text,b),d=c.textSize+c.lineMargin,e=this.currentContext,f=a._wrappedText,g=a.x,h=a.y;e.save(),l(e,c);for(var i=0,k=f.length;i<k;++i){var m=f[i];e.fillText(m,g,h),c.outline!=null&&e.strokeText(m,g,h),h+=d}e.restore()},i.prototype.createImageOverlay=function(a,b){var c=hemi.utils.join({},j.image,b),d=this.currentContext,e=a._image;d.save(),l(d,c),a._width!==e.width||a._height!==e.height||a.srcX!==0||a.srcY!==0?d.drawImage(e,a.srcX,a.srcY,a._width,a._height,a.x,a.y,a._width,a._height):d.drawImage(e,a.x,a.y),d.restore()},i.prototype.createVideoOverlay=function(a,b){var c=hemi.utils.join({},j.video,b),d=a._video;this._videos.push({video:d,config:c,context:this.currentContext,x:a.x,y:a.y,width:a._width||d.videoWidth,height:a._height||d.videoHeight}),d.play()},i.prototype.doTextWrapping=function(a,b,c){var d=hemi.utils.join({},j.text,c),e=this.currentContext,f;e.save(),l(e,d);if(d.strictWrapping)f=hemi.utils.wrapTextStrict(a,b,e);else{var g=e.measureText(a),h=g.width/a.length;f=hemi.utils.wrapText(a,b,h)}var i=f.length*(d.textSize+d.lineMargin),k=0;for(var m=0,n=f.length;m<n;++m){var g=e.measureText(f[m]);k<g.width&&(k=g.width)}return e.restore(),{text:f,height:i,width:k}},i.prototype.drawRoundRect=function(a,b,c){var d=this.currentContext,e=a._left,f=a._right,g=a._top,h=a._bottom,i=f-e,j=h-g,k=j>i?i*b:j*b,l=270*hemi.DEG_TO_RAD,m=0,n=90*hemi.DEG_TO_RAD,o=180*hemi.DEG_TO_RAD;d.beginPath(),d.moveTo(e,g+k),d.lineTo(e,h-k),d.arc(e+k,h-k,k,o,n,!0),d.lineTo(f-k,h),d.arc(f-k,h-k,k,n,m,!0),d.lineTo(f,g+k),d.arc(f-k,g+k,k,m,l,!0),d.lineTo(e+k,g),d.arc(e+k,g+k,k,l,o,!0),d.closePath(),c?d.fill():d.stroke()},i.prototype.onRender=function(a){var b=this._videos;for(var c=0,d=b.length;c<d;++c){var e=b[c],f=e.context;f.save(),l(f,e.config),f.drawImage(e.video,e.x,e.y,e.width,e.height),f.restore()}},i.prototype.resetTextBaseline=function(){for(var a in this._contexts)this._contexts[a].textBaseline="top"},i.prototype.setClient=function(a){this.currentContext=this._contexts[a._getId()]},hemi.getHudTheme=function(a){return j},hemi.setHudTheme=function(a){j=a};var j=new hemi.HudTheme;j.name="Default",hemi.hudManager=new i}(),function(){function k(){if(this.local){var b=hemi.utils;a[0].copy(this.plane[0]),a[1].copy(this.plane[1]),a[2].copy(this.plane[2]),b.pointAsWorld(this._activeTransform,a[0]),b.pointAsWorld(this._activeTransform,a[1]),b.pointAsWorld(this._activeTransform,a[2])}else{var c=this._activeTransform.matrixWorld.getPosition();a[0].add(this.plane[0],c),a[1].add(this.plane[1],c),a[2].add(this.plane[2],c)}return a}function m(a){var b=this._uv[0]+a[0],c=this._uv[1]+a[1];this.umin!==null&&b<this.umin&&(b=this.umin),this.umax!==null&&b>this.umax&&(b=this.umax),this.vmin!==null&&c<this.vmin&&(c=this.vmin),this.vmax!==null&&c>this.vmax&&(c=this.vmax),a[0]=b-this._uv[0],a[1]=c-this._uv[1],this._uv[0]=b,this._uv[1]=c}function n(a,b,c){var d=this._client.castRay(a,b),e=c||k.call(this),f=hemi.utils.intersect(d,e);return[f[1],f[2]]}function p(a,b){var c=k.call(this),d=this._client.castRay(a,b),e=hemi.utils.intersect(d,c);return Math.atan2(e[2],e[1])}function r(a,b){var d=c.set(a-this._originXY[0],b-this._originXY[1]),e=Math.abs(this._pickXY.dot(d));return e}function s(a){return this.local?hemi.utils.pointAsWorld(this._activeTransform,a):a.addSelf(this._activeTransform.position),hemi.utils.worldToScreenFloat(this._client,a),[a.x,a.y]}var a=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],b=new THREE.Vector3,c=new THREE.Vector2,d=new THREE.Vector3(1,0,0),e=new THREE.Vector3(0,1,0),f=new THREE.Vector3(0,0,1),g=[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0)],h=[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1)],i=[new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)];hemi.Plane={XY:"xy",XZ:"xz",YZ:"yz"},hemi.Axis={X:"x",Y:"y",Z:"z"};var j=function(){this._activeTransform=null,this._client=null,this._enabled=!1,this._msgHandler=null,this.local=!1,this.transforms=[]};j.prototype.addTransform=function(a){this.transforms.push(a)},j.prototype.clearTransforms=function(){this.transforms.length=0},j.prototype.containsTransform=function(a){for(var b=0,c=this.transforms.length;b<c;++b){var d=this.transforms[b].getAllChildren();for(var e=0,f=d.length;e<f;++e)if(a.id===d[e].id)return!0}return!1},j.prototype.disable=function(){this._enabled&&(hemi.unsubscribe(this._msgHandler,hemi.msg.pick),hemi.input.removeMouseMoveListener(this),hemi.input.removeMouseUpListener(this),this._enabled=!1,this._msgHandler=null)},j.prototype.enable=function(){this._enabled||(this._msgHandler=hemi.subscribe(hemi.msg.pick,this,"onPick",[hemi.dispatch.MSG_ARG+"data.pickedMesh",hemi.dispatch.MSG_ARG+"data.mouseEvent"]),hemi.input.addMouseMoveListener(this),hemi.input.addMouseUpListener(this),this._enabled=!0)},j.prototype.onMouseUp=function(a){this._activeTransform=null},j.prototype.removeTransform=function(a){var b=this.transforms.indexOf(a);b!==-1&&this.transforms.splice(b,1)};var l=function(a,b){j.call(this),this._pickUV=null,this._uv=[0,0],this.plane=null,this.umin=null,this.umax=null,this.vmin=null,this.vmax=null,this.setPlane(a||hemi.Plane.XZ),b!==undefined&&this.setLimits(b),this.enable()};l.prototype=new j,l.constructor=l,l.prototype._octane=function(){var a=["local","umin","umax","vmin","vmax"],b=[],c=this.plane;for(var d=0,e=a.length;d<e;++d){var f=a[d];b.push({name:f,val:this[f]})}return c===g?b.push({name:"setPlane",arg:[hemi.Plane.XY]}):c===h?b.push({name:"setPlane",arg:[hemi.Plane.XZ]}):c===i?b.push({name:"setPlane",arg:[hemi.Plane.YZ]}):b.push({name:"plane",oct:[c[0]._toOctane(),c[1]._toOctane(),c[2]._toOctane()]}),b},l.prototype.clear=function(){this._activeTransform=null,this._client=null,this._uv[0]=this._uv[1]=0,this.local=!1,this.setPlane(hemi.Plane.XZ),this.disable(),this.clearTransforms(),this.clearLimits()},l.prototype.clearLimits=function(){this.umin=null,this.umax=null,this.vmin=null,this.vmax=null},l.prototype.getPlaneString=function(){return this.plane===g?hemi.Plane.XY:this.plane===h?hemi.Plane.XZ:this.plane===i?hemi.Plane.YZ:"UNKNOWN"},l.prototype.onMouseMove=function(a){if(this._activeTransform===null)return;var c=k.call(this),d=n.call(this,a.x,a.y,c),e=[d[0]-this._pickUV[0],d[1]-this._pickUV[1]];m.call(this,e);var f=hemi.utils.uvToXYZ(e,c),g=hemi.utils.uvToXYZ([0,0],c),h=b.sub(f,g);for(var i=0,j=this.transforms.length;i<j;++i)hemi.utils.worldTranslate(h,this.transforms[i]);this.transforms[0].send(hemi.msg.move,{delta:h})},l.prototype.onPick=function(a,b){var c=a.id;for(var d=0,e=this.transforms.length;d<e;++d)if(this.transforms[d].id===c){this._activeTransform=a,this._client=hemi.getClient(a),this._pickUV=n.call(this,b.x,b.y);break}},l.prototype.setLimits=function(a){this.umin=a[0],this.umax=a[1],this.vmin=a[2],this.vmax=a[3]},l.prototype.setPlane=function(a){switch(a.toLowerCase()){case hemi.Plane.XY:this.plane=g;break;case hemi.Plane.XZ:this.plane=h;break;case hemi.Plane.YZ:this.plane=i}},hemi.Movable=l,hemi.makeOctanable(hemi.Movable,"hemi.Movable",hemi.Movable.prototype._octane);var o=function(a,b){j.call(this),this._angle=0,this._pickAngle=null,this.axis=new THREE.Vector3,this.min=null,this.max=null,this.plane=null,this.setAxis(a||hemi.Axis.Y),b!==undefined&&this.setLimits(b),this.enable()};o.prototype=new j,o.constructor=o,o.prototype._octane=function(){var a=["local","max","min"],b=[],c=this.plane;for(var d=0,e=a.length;d<e;++d){var f=a[d];b.push({name:f,val:this[f]})}return c===g?b.push({name:"setAxis",arg:[hemi.Axis.Z]}):c===h?b.push({name:"setAxis",arg:[hemi.Axis.Y]}):c===i?b.push({name:"setAxis",arg:[hemi.Axis.X]}):(b.push({name:"axis",oct:this.axis._toOctane()}),b.push({name:"plane",oct:[c[0]._toOctane(),c[1]._toOctane(),c[2]._toOctane()]})),b},o.prototype.clear=function(){this._activeTransform=null,this._angle=0,this._client=null,this.local=!1,this.setAxis(hemi.Axis.Y),this.disable(),this.clearTransforms(),this.clearLimits()},o.prototype.clearLimits=function(){this.min=null,this.max=null},o.prototype.getAxisString=function(){return hemi.utils.vector3Equals(this.axis,b.set(-1,0,0))?hemi.Axis.X:hemi.utils.vector3Equals(this.axis,b.set(0,-1,0))?hemi.Axis.Y:hemi.utils.vector3Equals(this.axis,b.set(0,0,1))?hemi.Axis.Z:"UNKNOWN"},o.prototype.onMouseMove=function(a){if(this._activeTransform===null)return;var b=p.call(this,a.x,a.y)-this._pickAngle;this.max!==null&&this._angle+b>=this.max&&(b=this.max-this._angle),this.min!==null&&this._angle+b<=this.min&&(b=this.min-this._angle),this._angle+=b,this.local||(this._pickAngle+=b);for(var c=0,d=this.transforms.length;c<d;++c){var e=this.transforms[c];this.local?hemi.utils.axisRotate(this.axis,b,e):hemi.utils.worldRotate(this.axis,b,e)}},o.prototype.onPick=function(a,b){var c=a.id;for(var d=0,e=this.transforms.length;d<e;++d)if(this.transforms[d].id===c){this._activeTransform=a,this._client=hemi.getClient(a),this._pickAngle=p.call(this,b.x,b.y);break}},o.prototype.setAxis=function(a){switch(a.toLowerCase()){case hemi.Axis.X:this.axis.copy(d),this.axis.x*=-1,this.plane=i;break;case hemi.Axis.Y:this.axis.copy(e),this.axis.y*=-1,this.plane=h;break;case hemi.Axis.Z:this.axis.copy(f),this.plane=g}},o.prototype.setLimits=function(a){this.min=a[0],this.max=a[1]},hemi.Turnable=o,hemi.makeOctanable(hemi.Turnable,"hemi.Turnable",hemi.Turnable.prototype._octane);var q=function(a){j.call(this),this._originXY=null,this._pickXY=new THREE.Vector2,this._scale=null,this.axis=null,this.setAxis(a||hemi.Axis.Y),this.enable()};q.prototype=new j,q.constructor=q,q.prototype._octane=function(){return[]},q.prototype.clear=function(){this._activeTransform=null,this._scale=null,this._client=null,this.local=!1,this.setAxis(hemi.Axis.Y),this.disable(),this.clearTransforms()},q.prototype.onMouseMove=function(a){if(this._activeTransform===null)return;var c=r.call(this,a.x,a.y),d=c/this._scale,e=b.set(this.axis.x?d:1,this.axis.y?d:1,this.axis.z?d:1);for(var f=0,g=this.transforms.length;f<g;++f){var h=this.transforms[f];this.local?(h.scale.multiplySelf(e),h.updateMatrix(),h.updateMatrixWorld(!0)):hemi.utils.worldScale(e,h)}this._scale=c,this.transforms[0].send(hemi.msg.resize,{scale:c})},q.prototype.onPick=function(a,c){var d=a.id;for(var e=0,f=this.transforms.length;e<f;++e)if(this.transforms[e].id===d){this._activeTransform=a,this._client=hemi.getClient(a),this._originXY=s.call(this,b.set(0,0,0));var g=s.call(this,b.copy(this.axis));this._pickXY.set(g[0]-this._originXY[0],g[1]-this._originXY[1]).normalize(),this._scale=r.call(this,c.x,c.y);break}},q.prototype.setAxis=function(a){switch(a.toLowerCase()){case hemi.Axis.X:this.axis=d;break;case hemi.Axis.Y:this.axis=e;break;case hemi.Axis.Z:this.axis=f}},hemi.Resizable=q,hemi.makeOctanable(hemi.Resizable,"hemi.Resizable",hemi.Resizable.prototype._octane)}(),function(a){function n(){if(!this._mesh||!this._materialSrc||this._boxes.length<2)return;var b=this.client.renderer.context,c=f.vert,d=f.frag,e=this._mesh.material,g=e.program,h=e.program=g.isCurveGen?g:b.createProgram(),i=this._materialSrc.frag,j=this._materialSrc.vert,k=this._boxes.length,l=this._colors.length,m=this._scales.length,n=l>1,p=m>1,q=a.utils.getShaders(this.client,e),r=q.fragShd,s=q.vertShd,v=1,w=3,x=1.1,y=["sysTime","ptcMaxTime","ptcDec","numPtcs","tension","ptcScales","ptcScaleKeys","minXYZ","maxXYZ","ptcColors","ptcColorKeys","viewIT"];for(var z=0,A=y.length;z<A;++z){var B=y[z],C=e.uniforms[B];C&&(B==="ptcDec"?v=C.value:B==="ptcMaxTime"?w=C.value:B==="sysTime"&&(x=C.value),delete e.uniforms[B],delete h.uniforms[B])}if(j.search("ptcInterp")<0){var D=c.header.replace(/NUM_BOXES/g,k),E=c.support,F=c.bodySetup.replace(/NUM_BOXES/g,k);n?(D+=c.headerColors.replace(/NUM_COLORS/g,l),E+=c.supportColors.replace(/NUM_COLORS/g,l)):E+=c.supportNoColors,this._aim?(E+=c.supportAim,F+=c.bodyAim):F+=c.bodyNoAim,p?(D+=c.headerScales.replace(/NUM_SCALES/g,m),E+=c.supportScale.replace(/NUM_SCALES/g,m),F+=c.bodyScale):F+=c.bodyNoScale,F+=c.bodyEnd;var G=a.utils.parseSrc(j),H=G.body.replace(/modelViewMatrix/g,"ptcWorldView").replace(/objectMatrix/g,"ptcWorld").replace(/normalMatrix/g,"ptcNorm");G.postSprt=D+E,G.preBody=F,G.body=H,j=e.vertexShader=a.utils.buildSrc(G);var I=b.createShader(b.VERTEX_SHADER);b.shaderSource(I,j),b.compileShader(I),b.detachShader(h,s),b.attachShader(h,I)}if(i.search("ptcColor")<0){var J=a.utils.parseSrc(i,"gl_FragColor"),K=J.glob;J.postSprt=d.header,J.preBody=d.bodySetup,n&&(J.body.indexOf("diffuse")!==-1?J.body=J.body.replace(/diffuse/g,"ptcColor.rgb"):J.body=J.body.replace(/emissive/g,"ptcColor.rgb")),J.body=J.body.replace(/opacity/g,"(opacity * ptcColor.a)"),i=e.fragmentShader=a.utils.buildSrc(J);var L=b.createShader(b.FRAGMENT_SHADER);b.shaderSource(L,i),b.compileShader(L),b.detachShader(h,r),b.attachShader(h,L)}var M={idOffset:{type:"v2",value:this.idOffsets,needsUpdate:!0}},N={sysTime:{type:"f",value:x},ptcMaxTime:{type:"f",value:w},ptcDec:{type:"f",value:v},numPtcs:{type:"f",value:this._particles},tension:{type:"f",value:(1-this._tension)/2},minXYZ:{type:"v3v",value:[]},maxXYZ:{type:"v3v",value:[]},viewIT:{type:"m4",value:new THREE.Matrix4}};n&&(N.ptcColors={type:"v4v",value:[]},N.ptcColorKeys={type:"fv1",value:[]}),p&&(N.ptcScales={type:"v3v",value:[]},N.ptcScaleKeys={type:"fv1",value:[]}),e.uniforms=THREE.UniformsUtils.merge([e.uniforms,N]),e.attributes=THREE.UniformsUtils.merge([e.attributes,M]),e.uniformsList=[],b.linkProgram(h),b.getProgramParameter(h,b.LINK_STATUS)||a.error("Could not initialise shader. VALIDATE_STATUS: "+b.getProgramParameter(h,b.VALIDATE_STATUS)+", gl error ["+b.getError()+"]"),h.uniforms={},h.attributes={},h.isCurveGen=!0;for(var O in e.uniforms)e.uniformsList.push([e.uniforms[O],O]);for(var O in g.uniforms)var P=h.uniforms[O]=b.getUniformLocation(h,O);for(var O in N)h.uniforms[O]=b.getUniformLocation(h,O);for(var Q in g.attributes){var P=h.attributes[Q]=b.getAttribLocation(h,Q);b.enableVertexAttribArray(P)}for(var Q in M){var P=h.attributes[Q]=b.getAttribLocation(h,Q);b.enableVertexAttribArray(P)}this._decparam=e.uniforms.ptcDec,this._maxTimeParam=e.uniforms.ptcMaxTime,this._timeParam=e.uniforms.sysTime,this._viewITParam=e.uniforms.viewIT,o.call(this);var R=!1;for(var z=0;z<l&&!R;z++)R=this._colors[z].value[3]<1;e.transparent=R,n&&t(e,this._colors),p&&u(e,this._scales),this._mesh.dynamic=!0,this._mesh.__webglInit=this._mesh.__webglActive=!1,delete this._mesh.geometry.geometryGroups,delete this._mesh.geometry.geometryGroupsList,this.client.scene.__objectsAdded.push(this._mesh)}function o(){if(this._mesh){var a=this._mesh.material,b=this._boxes,c=a.uniforms.minXYZ,d=a.uniforms.maxXYZ;c._array=new Float32Array(3*b.length),d._array=new Float32Array(3*b.length);for(var e=0,f=b.length;e<f;++e){var g=b[e];c.value[e]=g.min,d.value[e]=g.max}}}function q(a,b,c){var d=c.edges==null?!0:c.edges,f=c.edgeSize||1,g=c.edgeColor==null?8912896:c.edgeColor,h=new THREE.MeshBasicMaterial({color:g}),i=new THREE.Geometry,j;for(var k=0;k<a.length;k++)if(d&&k<a.length-1){var l=a[k].clone();k%2&&(l.y+=f),i.vertices.push((new THREE.Vertex).copy(l)),i.colors.push(g)}j=new THREE.Ribbon(i,h),j.doubleSided=!0,b.scene.add(j),e.push(j)}function r(a,b){var c=a.vertices,d=a.faces,e=a.faceVertexUvs,f=c.length,g=d.length,h=[],i=[],j=[];for(var k=0;k<f;k++)h.push(0),i.push(0),j.push(new THREE.Vector2);for(var k=1;k<b;k++){var l=k*f,m=k/b,n=[],o=[];for(var p=0;p<f;p++){h.push(k),i.push(m),j.push(new THREE.Vector2(k,m));var q=c[p];n.push(new THREE.Vertex(q.x,q.y,q.z))}for(var p=0;p<g;p++){var r=d[p],s=null;r instanceof THREE.Face3?s=new THREE.Face3(r.a+l,r.b+l,r.c+l,null,null,r.material):s=new THREE.Face4(r.a+l,r.b+l,r.c+l,r.d+l,null,null,r.material),o.push(s)}a.vertices=a.vertices.concat(n),a.faces=a.faces.concat(o),a.faceVertexUvs=a.faceVertexUvs.concat(e)}return a.computeCentroids(),a.computeFaceNormals(),{ids:h,offsets:i,idOffsets:j}}function s(a,b,c){var d={color:c==null?16711680:c,opacity:1,transparent:b===undefined?!0:b},e;return a==="lambert"?e=new THREE.MeshLambertMaterial(d):e=new THREE.MeshPhongMaterial(d),e}function t(a,b){var c=a.uniforms.ptcColors,d=a.uniforms.ptcColorKeys;c._array=new Float32Array(4*b.length);for(var e=0,f=b.length;e<f;++e){var g=b[e],h=e*4;c.value[e]=new THREE.Vector4(g.value[0],g.value[1],g.value[2],g.value[3]),d.value[e]=g.key}}function u(a,b){var c=a.uniforms.ptcScales,d=a.uniforms.ptcScaleKeys;c._array=new Float32Array(3*b.length);for(var e=0,f=b.length;e<f;++e){var g=b[e];c.value[e]=g.value,d.value[e]=g.key}}var b=new THREE.MeshPhongMaterial({color:136,wireframe:!0,wireframeLinewidth:1}),c={},e=[];a.hideCurves=function(a){for(var b=0,c=e.length;b<c;b++)a.scene.remove(e[b])};var f={vert:{header:"uniform float sysTime; \nuniform float ptcMaxTime; \nuniform float ptcDec; \nuniform float numPtcs; \nuniform float tension; \nuniform mat4 viewIT; \nuniform vec3 minXYZ[NUM_BOXES]; \nuniform vec3 maxXYZ[NUM_BOXES]; \nattribute vec4 idOffset; \nvarying vec4 ptcColor; \n",headerColors:"uniform vec4 ptcColors[NUM_COLORS]; \nuniform float ptcColorKeys[NUM_COLORS]; \n",headerScales:"uniform vec3 ptcScales[NUM_SCALES]; \nuniform float ptcScaleKeys[NUM_SCALES]; \n",support:"float rand(vec2 co) { \n  return fract(sin(dot(co.xy, vec2(12.9898,78.233))) * 43758.5453); \n} \nvec3 randXYZ(vec2 co, vec3 min, vec3 max) { \n  float rX = rand(vec2(co.x, co.x)); \n  float rY = rand(vec2(co.y, co.y)); \n  float rZ = rand(co); \n  return vec3(mix(max.x, min.x, rX), \n              mix(max.y, min.y, rY), \n              mix(max.z, min.z, rZ)); \n} \nvec3 ptcInterp(float t, vec3 p0, vec3 p1, vec3 m0, vec3 m1) { \n  float t2 = pow(t, 2.0); \n  float t3 = pow(t, 3.0); \n  return (2.0*t3 - 3.0*t2 + 1.0)*p0 + (t3 -2.0*t2 + t)*m0 + \n   (-2.0*t3 + 3.0*t2)*p1 + (t3-t2)*m1; \n} \n",supportColors:"void setPtcClr(float ptcTime) { \n  if (ptcTime > 1.0) { \n    ptcColor = vec4(0.0); \n  } else { \n    int ndx; \n    float key; \n    for (int i = 0; i < NUM_COLORS-1; i++) { \n      if (ptcColorKeys[i] < ptcTime) { \n        ndx = i; \n        key = ptcColorKeys[i]; \n      } \n    } \n    float t = (ptcTime - key)/(ptcColorKeys[ndx+1] - key); \n    ptcColor = mix(ptcColors[ndx], ptcColors[ndx+1], t); \n  } \n} \n",supportNoColors:"void setPtcClr(float ptcTime) { \n  if (ptcTime > 1.0) { \n    ptcColor = vec4(0.0); \n  } else { \n    ptcColor = vec4(1.0); \n  } \n} \n",supportAim:"mat4 getRotMat(float t, vec3 p0, vec3 p1, vec3 m0, vec3 m1) { \n  float tM = max(0.0,t-0.02); \n  float tP = min(1.0,t+0.02); \n  vec3 posM = ptcInterp(tM, p0, p1, m0, m1); \n  vec3 posP = ptcInterp(tP, p0, p1, m0, m1); \n  vec3 dPos = posP-posM; \n  float dxz = sqrt(pow(dPos.x,2.0)+pow(dPos.z,2.0)); \n  float dxyz = length(dPos); \n  float cx = dPos.y/dxyz; \n  float cy = dPos.z/dxz; \n  float sx = dxz/dxyz; \n  float sy = dPos.x/dxz; \n  return mat4(cy,0.0,-1.0*sy,0.0, \n   sx*sy,cx,sx*cy,0.0, \n   cx*sy,-1.0*sx,cx*cy,0.0, \n   0.0,0.0,0.0,1.0); \n} \n",supportScale:"vec3 getScale(float ptcTime) { \n  if (ptcTime > 1.0) { \n    return vec3(1.0); \n  } else { \n    int ndx; \n    float key; \n    for (int i = 0; i < NUM_SCALES-1; i++) { \n      if (ptcScaleKeys[i] < ptcTime) { \n        ndx = i; \n        key = ptcScaleKeys[i]; \n      } \n    } \n    float t = (ptcTime - key)/(ptcScaleKeys[ndx+1] - key); \n    return mix(ptcScales[ndx], ptcScales[ndx+1], t); \n  } \n} \n",bodySetup:"  float id = idOffset[0]; \n  float offset = idOffset[1]; \n  vec2 seed = vec2(id, numPtcs-id); \n  float ptcTime = sysTime + offset; \n  if (ptcTime > ptcMaxTime) { \n    ptcTime -= ptcDec; \n  } \n  setPtcClr(ptcTime); \n  if (ptcTime > 1.0) { \n    ptcTime = 0.0; \n  } \n  float boxT = float(NUM_BOXES-1)*ptcTime; \n  int ndx = int(floor(boxT)); \n  float t = fract(boxT); \n  vec3 p0 = randXYZ(seed,minXYZ[ndx],maxXYZ[ndx]); \n  vec3 p1 = randXYZ(seed,minXYZ[ndx+1],maxXYZ[ndx+1]); \n  vec3 m0; \n  vec3 m1; \n  if (ndx == 0) { \n    m0 = vec3(0,0,0); \n  } else { \n    vec3 pm1 = randXYZ(seed,minXYZ[ndx-1],maxXYZ[ndx-1]); \n    m0 = (p1-pm1)*tension; \n  } \n  if (ndx == NUM_BOXES-2) { \n    m1 = vec3(0,0,0); \n  } else { \n    vec3 p2 = randXYZ(seed,minXYZ[ndx+2],maxXYZ[ndx+2]); \n    m1 = (p2-p0)*tension; \n  } \n  vec3 pos = ptcInterp(t, p0, p1, m0, m1); \n  mat4 tMat = mat4(1.0,0.0,0.0,0.0, \n   0.0,1.0,0.0,0.0, \n   0.0,0.0,1.0,0.0, \n   pos.x,pos.y,pos.z,1.0); \n  mat4 tMatIT = mat4(1.0,0.0,0.0,-1.0*pos.x, \n   0.0,1.0,0.0,-1.0*pos.y, \n   0.0,0.0,1.0,-1.0*pos.z, \n   0.0,0.0,0.0,1.0); \n",bodyAim:"  mat4 rMat = getRotMat(t, p0, p1, m0, m1); \n",bodyNoAim:"  mat4 rMat = mat4(1.0); \n",bodyScale:"  vec3 scale = getScale(ptcTime); \n  mat4 sMat = mat4(scale.x,0.0,0.0,0.0, \n   0.0,scale.y,0.0,0.0, \n   0.0,0.0,scale.z,0.0, \n   0.0,0.0,0.0,1.0); \n",bodyNoScale:"  mat4 sMat = mat4(1.0); \n",bodyEnd:"  mat4 ptcWorld = tMat*rMat*sMat; \n  mat4 ptcWorldViewIT = viewIT*tMatIT*rMat*sMat; \n  mat3 ptcNorm = mat3(ptcWorldViewIT[0].xyz, ptcWorldViewIT[1].xyz, ptcWorldViewIT[2].xyz); \n  mat4 ptcWorldView = viewMatrix * ptcWorld; \n"},frag:{header:"varying vec4 ptcColor; \n",bodySetup:"  if (ptcColor.a == 0.0) {\n    discard;\n  }\n",globNoColors:"gl_FragColor.a *= ptcColor.a; \n"}};a.CurveType={Linear:0,Bezier:1,CubicHermite:2,LinearNorm:3,Cardinal:4,Custom:5},a.BoundingBox=function(a,b){this.min=a||new THREE.Vector3,this.max=b||new THREE.Vector3};var g=function(a,b,c){this.count=0,this.tension=0,this.type=b,this.weights=[],this.points=[],this.tangents=[],a&&(c=c||{},c.points=a,this.loadConfig(c))};g.prototype._octane=function(){var a=["count","tension","weights"],b=[],c,d;for(c=0,d=a.length;c<d;++c){var e=a[c];b.push({name:e,val:this[e]})}a=["points","tangents"];for(c=0,d=a.length;c<d;++c){var e=a[c],f=this[e],g=[];for(var h=0,i=f.length;h<i;++h)g.push(f[h]._toOctane());b.push({name:e,oct:g})}return b.push({name:"setType",arg:[this.type]}),b},g.prototype.draw=function(a,b,c){var d=[],c=c||{};for(var e=0,f=a+2;e<f;++e)d[e]=this.interpolate(e/(a+1));q(d,b,c)},g.prototype.getEnd=function(){var a=this.count-1;return this.points[a].clone()},g.prototype.getStart=function(){return this.points[0].clone()},g.prototype.interpolate=function(a){return new THREE.Vector3(a,a,a)},g.prototype.loadConfig=function(b){var c=b.points,d=b.type||this.type||a.CurveType.Linear,e;this.setType(d);if(c){this.count=c.length;for(e=0;e<this.count;e++)this.weights[e]=1,this.points[e]=c[e].clone(),this.tangents[e]=new THREE.Vector3(0,0,0)}if(b.weights)for(e=0;e<this.count;e++)this.weights[e]=b.weights[e]!==undefined?b.weights[e]:1;if(b.tangents)for(e=0;e<this.count;e++)b.tangents[e]&&(this.tangents[e]=b.tangents[e]||new THREE.Vector3(0,0,0));b.tension&&(this.tension=b.tension),this.type===a.CurveType.Cardinal&&l.call(this)},g.prototype.setType=function(b){this.type=b;switch(b){case a.CurveType.Bezier:this.interpolate=h;break;case a.CurveType.CubicHermite:case a.CurveType.Cardinal:this.interpolate=i;break;case a.CurveType.Linear:this.interpolate=j;break;case a.CurveType.LinearNorm:this.interpolate=k;break;default:}};var h=function(b){var c=this.count,d=0,e=0,f=0,g=0;for(var h=0;h<c;++h){var i=this.weights[h]*a.utils.choose(c-1,h)*Math.pow(b,h)*Math.pow(1-b,c-1-h),j=this.points[h];d+=i*j.x,e+=i*j.y,f+=i*j.z,g+=i}return new THREE.Vector3(d/g,e/g,f/g)},i=function(b){var c=this.count-1,d=Math.floor(b*c);d>=c&&(d=c-1);var e=d/c,f=(b-e)/((d+1)/c-e),g=this.points[d],h=this.points[d+1],i=this.tangents[d],j=this.tangents[d+1],k=a.utils.cubicHermite(f,g.x,i.x,h.x,j.x);return y=a.utils.cubicHermite(f,g.y,i.y,h.y,j.y),z=a.utils.cubicHermite(f,g.z,i.z,h.z,j.z),new THREE.Vector3(k,y,z)},j=function(a){var b=this.count-1,c=Math.floor(a*b);c>=b&&(c=b-1);var d=c/b,e=(a-d)/((c+1)/b-d),f=this.points[c],g=this.points[c+1],h=(1-e)*f.x+e*g.x;return y=(1-e)*f.y+e*g.y,z=(1-e)*f.z+e*g.z,new THREE.Vector3(h,y,z)},k=function(a){var b=0,c=[0],e,f;for(var g=1,h=this.count;g<h;++g){var e=this.points[g-1],f=this.points[g],i=e.x-f.x,j=e.y-f.y,k=e.z-f.z;b+=Math.sqrt(i*i+j*j+k*k),c[g]=d}var l=a*b,m=0;for(var g=1,h=this.count;g<h;++g)c[g]<l&&(m=g);e=this.points[m],f=this.points[m+1];var n=(l-c[m])/(c[m+1]-c[m]),o=(1-n)*e.x+n*f.x,p=(1-n)*e.y+n*f.y,q=(1-n)*e.z+n*f.z;return new THREE.Vector3(o,p,q)},l=function(){var b=a.utils.clone(this.points);b.unshift(b[0]),b.push(b[b.length-1]);for(var c=0;c<this.count;c++){var d=b[c+2],e=b[c],f=this.tangents[c];f.x=(1-this.tension)*(d.x-e.x)/2,f.y=(1-this.tension)*(d.y-e.y)/2,f.z=(1-this.tension)*(d.z-e.z)/2}};a.Curve=g,a.makeOctanable(a.Curve,"hemi.Curve",a.Curve.prototype._octane);var m=function(a,b){this._aim=!1,this._boxes=[],this._colors=[],this._decparam=null,this._materialSrc=null,this._maxTimeParam=null,this._mesh=null,this._particles=0,this._scales=[],this._shapeConfig=null,this._tension=0,this._timeParam=null,this._viewITParam=null,this.active=!1,this.client=a,this.life=0,b&&this.loadConfig(b)};m.prototype._msgSent=[a.msg.start,a.msg.stop],m.prototype._octane=function(){return[{name:"client",id:this.client._getId()},{name:"loadConfig",arg:[{aim:this._aim,boxes:this._boxes,colorKeys:this._colors,life:this.life,particleCount:this._particles,scaleKeys:this._scales,tension:this._tension,particleShape:this._shapeConfig}]}]},m.prototype.hideBoxes=function(){if(this._mesh){var a=c[this._mesh.id]||[];for(var b=0,d=a.length;b<d;++b)this._mesh.remove(a[b]);delete c[this._mesh.id]}},m.prototype.loadConfig=function(b){this._aim=b.aim===undefined?!1:b.aim,this._boxes=b.boxes?a.utils.clone(b.boxes):[],this.life=b.life||5,this._particles=b.particleCount||0,this._tension=b.tension||0,this._shapeConfig=b.particleShape||null,b.colorKeys?this.setColorKeys(b.colorKeys):b.colors?this.setColors(b.colors):this._colors=[],b.scaleKeys?this.setScaleKeys(b.scaleKeys):b.scales?this.setScales(b.scales):this._scales=[],b.particleShape?this.setParticleShape(b.particleShape):b.customMesh?this.setParticleMesh(b.customMesh):this._mesh=null},m.prototype.onRender=function(a){var b=a.elapsedTime/this.life,c=this._timeParam.value+b;while(c>1)--c;this._timeParam.value=c,this._viewITParam.value.copy(this.client.camera.threeCamera.matrixWorld).transpose()},m.prototype.pause=function(){this.active&&(a.removeRenderListener(this),this.active=!1)},m.prototype.play=function(){this.active||(this._maxTimeParam.value===1?(a.addRenderListener(this),this.active=!0):this.start())},m.prototype.setAim=function(a){this._aim!==a&&(this._aim=a,this._mesh?this.setParticleShape(this._shapeConfig):n.call(this))},m.prototype.setBoxes=function(b){var c=this._boxes.length;this._boxes=a.utils.clone(b),this._boxes.length===c?o.call(this):n.call(this)},m.prototype.setColors=function(a){var b=a.length,c=b===1?1:1/(b-1),d=[];for(var e=0;e<b;++e)d.push({key:e*c,value:a[e]});this.setColorKeys(d)},m.prototype.setColorKeys=function(a){var b=a.length;if(b===1){var c=a[0].value;this._colors=[{key:0,value:c},{key:1,value:c}]}else b>1?(a[0].key=0,a[a.length-1].key=1,this._colors=a):this._colors=[];this._mesh?this.setParticleShape(this._shapeConfig):n.call(this)},m.prototype.setMaterial=function(b){if(this._mesh){this._mesh.material=b;if(!b.program||b.needsUpdate){var c=this.client.scene;this.client.renderer.initMaterial(b,c.__lights,c.fog,this._mesh),b.needsUpdate=!1}var d=a.utils.getShaders(this.client,b);this._materialSrc={frag:d.fragSrc,vert:d.vertSrc},n.call(this)}},m.prototype.setParticleCount=function(a){this._particles=a,this._mesh&&this.setParticleShape(this._shapeConfig)},m.prototype.setParticleMesh=function(a){this._mesh&&(this._mesh.parent&&this.client.scene.remove(this._mesh),this._mesh=null),a.parent||this.client.scene.add(a),a.frustumCulled=!1,this._mesh=a,this._particles=this._particles||1;var b=r(this._mesh.geometry,this._particles);this.idArray=b.ids,this.offsetArray=b.offsets,this.idOffsets=b.idOffsets,this.setMaterial(a.material||s())},m.prototype.setParticleShape=function(b){var c=this._timeParam?this._timeParam.value:null,d=this._maxTimeParam?this._maxTimeParam.value:null,e=a.createShape(b);a.world.removeCitizen(e),this._shapeConfig=b,this.setParticleMesh(e),c!==null&&d!==null&&(this._timeParam.value=c,this._maxTimeParam.value=d)},m.prototype.setScales=function(a){var b=a.length,c=b===1?1:1/(b-1),d=[];for(var e=0;e<b;e++)d.push({key:e*c,value:a[e]});this.setScaleKeys(d)},m.prototype.setScaleKeys=function(a){var b=a.length;if(b===1){var c=a[0].value;this._scales=[{key:0,value:c},{key:1,value:c}]}else b>1?(a[0].key=0,a[b-1].key=1,this._scales=a):this._scales=[];n.call(this)},m.prototype.setTension=function(a){this._tension=a,this._mesh&&(this._mesh.material.uniforms.tension.value=(1-this._tension)/2)},m.prototype.showBoxes=function(){if(this._mesh){var a=c[this._mesh.id]||[];for(var d=0;d<this._boxes.length;d++){var e=this._boxes[d],f=e.max.x-e.min.x,g=e.max.y-e.min.y,h=e.max.z-e.min.z,i=e.min.x+f/2,j=e.min.y+g/2,k=e.min.z+h/2,l=new THREE.CubeGeometry(f,g,h),m=new THREE.Mesh(l,b);m.position.addSelf(new THREE.Vector3(i,j,k)),this._mesh.add(m),a.push(m)}c[this._mesh.id]=a}},m.prototype.start=function(){this.active||(this.active=!0,this._timeParam.value=1,this._maxTimeParam.value=1,a.addRenderListener(this))},m.prototype.stop=function(){this.active&&(this.active=!1,this._timeParam.value=1.1,this._maxTimeParam.value=3,a.removeRenderListener(this))},m.prototype.translate=function(a,b,c){for(var d=0,e=this._boxes.length;d<e;d++){var f=this._boxes[d],g=f.min,h=f.max;g[0]+=a,h[0]+=a,g[1]+=b,h[1]+=b,g[2]+=c,h[2]+=c}o.call(this)},a.makeCitizen(m,"hemi.ParticleCurve",{toOctane:m.prototype._octane});var p=function(a,b){m.call(this,a,b),this.endTime=1,this.starting=!1,this.stopping=!1};p.prototype=new m,p.prototype.constructor=p,p.prototype.onRender=function(b){var c=b.elapsedTime/this.life,d=this._timeParam.value+c;if(d>this.endTime)if(this.stopping)this.active=!1,this.stopping=!1,this._maxTimeParam.value=3,a.removeRenderListener(this),d=1.1;else{this.starting&&(this.starting=!1,this.endTime=1,this._decparam.value=1,this._maxTimeParam.value=1);while(--d>this.endTime);}this.stopping&&(this._maxTimeParam.value+=c),this._timeParam.value=d,this._viewITParam.value.copy(this.client.camera.threeCamera.matrixWorld).transpose()},p.prototype.play=function(){this.active||(this.starting||this.stopping||this._maxTimeParam.value===1?(a.addRenderListener(this),this.active=!0):this.start())},p.prototype.start=function(){this.stopping&&(a.removeRenderListener(this),this.active=!1,this.stopping=!1),this.active||(this.active=!0,this.starting=!0,this.stopping=!1,this.endTime=2,this._decparam.value=2,this._maxTimeParam.value=2,this._timeParam.value=1,a.addRenderListener(this))},p.prototype.stop=function(a){this.active&&(a?this.endTime=-1:this.stopping||(this.endTime=this._timeParam.value+1),this.starting=!1,this.stopping=!0)},a.makeCitizen(p,"hemi.ParticleCurveTrail",{toOctane:p.prototype._octane})}(hemi),function(){var a=function(a,b){function h(){++d>=c.length&&b.callback&&b.callback()}var c=b.maps,d=0;this._clock=0,this._cycle=0,this._maps=[],this._maxCycles=0,this._running=!1,this.client=a,this.period=1;for(var e=0,f=c.length;e<f;++e){var g=c[e];g instanceof THREE.Texture?(this._maps.push(g),h()):this.addFrame(g,h),e===0&&(b.map=this._maps[0],THREE.Sprite.call(this,b))}a.scene.add(this)};a.prototype=new THREE.Sprite({map:new THREE.Texture(new Image)}),a.prototype.constructor=a,a.prototype.addFrame=function(a,b){var c=hemi.loadTextureSync(a,function(a){b&&b(a)});this._maps.push(c)},a.prototype.onRender=function(a){if(!this._running)return;this._clock+=a.elapsedTime,this._clock>=this.period&&(this._cycle++,this._cycle===this._maxCycles?this.stop():(this.setFrame(this._cycle),this._clock%=this.period))},a.prototype.run=function(a){this._running||(this._cycle=0,this._maxCycles=a||this.samplers.length,this._clock=0,this.setFrame(0),this._running=!0,hemi.addRenderListener(this))},a.prototype.setFrame=function(a){if(this._maps.length>0){var b=a%this._maps.length;this.map=this._maps[b]}},a.prototype.stop=function(){this._running&&(this._running=!1,hemi.removeRenderListener(this))},hemi.makeCitizen(a,"hemi.Sprite",{})}(),function(){function b(a,b,c){var d=a+b,e=a/2,f=d/2,g=e/2,h=0,i=f,j=[new THREE.Vector2(h,i),new THREE.Vector2(h+=e,i-=a),new THREE.Vector2(h-=g,i),new THREE.Vector2(h,i-=b),new THREE.Vector2(h-=e,i),new THREE.Vector2(h,i+=b),new THREE.Vector2(h-=g,i),new THREE.Vector2(h+=e,i+=a)],k=new THREE.Shape(j);return k.extrude({amount:c,bevelEnabled:!1})}function c(a,b,c){var d=new THREE.Geometry;d.vertices=a,d.faces=b,d.faceVertexUvs[0]=c;for(var e=0,f=b.length;e<f;++e){var g=b[e],h=hemi.utils.computeNormal(a[g.a],a[g.b],a[g.c]);g.normal.copy(h),g.vertexNormals.push(h.clone(),h.clone(),h.clone())}return d.computeCentroids(),d.mergeVertices(),d}function d(a,b,d){var e=a/2,f=b/2,g=d/2,h=[new THREE.Vertex(f,-e,g),new THREE.Vertex(-f,-e,g),new THREE.Vertex(-f,-e,-g),new THREE.Vertex(f,-e,-g),new THREE.Vertex(0,e,0)],i=[new THREE.Face3(0,1,2),new THREE.Face3(0,2,3),new THREE.Face3(1,0,4),new THREE.Face3(2,1,4),new THREE.Face3(3,2,4),new THREE.Face3(0,3,4)],j=[[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)]];return c(h,i,j)}function e(a){var b=a/2,d=[new THREE.Vertex(b,b,b),new THREE.Vertex(-b,-b,b),new THREE.Vertex(-b,b,-b),new THREE.Vertex(b,-b,-b)],e=[new THREE.Face3(0,2,1),new THREE.Face3(0,1,3),new THREE.Face3(0,3,2),new THREE.Face3(1,2,3)],f=[[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)],[new THREE.UV(0,0),new THREE.UV(0,1),new THREE.UV(1,0)]];return c(d,e,f)}hemi.ShapeType={ARROW:"arrow",BOX:"box",CONE:"cone",CUBE:"cube",CUSTOM:"custom",CYLINDER:"cylinder",OCTA:"octa",PLANE:"plane",PYRAMID:"pyramid",SPHERE:"sphere",TETRA:"tetra"};var a=function(a,b){this.client=a,this.config=b||{},this.mesh=null,this.config.shape&&this.create()};a.prototype._clean=function(){this.mesh!==null&&(this.mesh.cleanup(),this.mesh=null),this.client=null,this.config={}},a.prototype._octane=["client","config","mesh","create"],a.prototype.create=function(){var a=this.client.renderer,b=this.client.scene;this.mesh===null?this.mesh=new hemi.Mesh:this.mesh.__webglInit&&(b.__objectsRemoved.push(this.mesh),a.initWebGLObjects(b),a.deallocateObject(this.mesh)),hemi.createShape(this.config,this.mesh),this.setName(this.name),this.mesh.parent===undefined?(this.mesh.updateMatrix(),b.add(this.mesh)):(b.__objectsAdded.push(this.mesh),a.initWebGLObjects(b))},a.prototype.setColor=function(a){this.config.material?this.config.material.color=a:(this.config.color=a,this.mesh.material.color=a)},a.prototype.setName=function(a){this.name=a,this.mesh.name=this.name+" Mesh",this.mesh.geometry.name=this.name+" Geometry"},a.prototype.setOpacity=function(a){this.config.opacity=a,this.mesh.material.opacity=a,this.mesh.material.transparent=a<1},a.prototype.setType=function(a){this.config.shape=a,this.create()},a.prototype.translate=function(a,b,c){this.mesh.translateX(a),this.mesh.translateY(b),this.mesh.translateZ(c),this.mesh.updateMatrix(),this.mesh.updateMatrixWorld(!0)},hemi.makeCitizen(a,"hemi.Shape",{cleanup:a.prototype._clean,toOctane:a.prototype._octane}),hemi.createShape=function(a,f){var g=f||new hemi.Mesh,h=a.shape||hemi.ShapeType.Box,i=a.color||0,j=a.opacity===undefined?1:a.opacity;a.material!==undefined?g.material=a.material:g.material=new THREE.MeshPhongMaterial({color:i,opacity:j,transparent:j<1});switch(h.toLowerCase()){case hemi.ShapeType.BOX:var k=a.width!==undefined?a.width:a.w!==undefined?a.w:1,l=a.height!==undefined?a.height:a.h!==undefined?a.h:1,m=a.depth!==undefined?a.depth:a.d!==undefined?a.d:1;g.geometry=new THREE.CubeGeometry(k,l,m);break;case hemi.ShapeType.CUBE:var n=a.size!==undefined?a.size:1;g.geometry=new THREE.CubeGeometry(n,n,n);break;case hemi.ShapeType.SPHERE:var o=a.radius!==undefined?a.radius:a.r!==undefined?a.r:1;g.geometry=new THREE.SphereGeometry(o,24,12);break;case hemi.ShapeType.CYLINDER:var p=a.radiusB!==undefined?a.radiusB:a.r1!==undefined?a.r1:1,q=a.radiusT!==undefined?a.radiusT:a.r2!==undefined?a.r2:1,l=a.height!==undefined?a.height:a.h!==undefined?a.h:1;g.geometry=new THREE.CylinderGeometry(p,q,l,24);break;case hemi.ShapeType.CONE:var o=a.radius!==undefined?a.radius:a.r!==undefined?a.r:1,l=a.height!==undefined?a.height:a.h!==undefined?a.h:1;g.geometry=new THREE.CylinderGeometry(0,o,l,24);break;case hemi.ShapeType.PLANE:var k=a.width!==undefined?a.width:a.w!==undefined?a.w:1,l=a.height!==undefined?a.height:a.h!==undefined?a.h:1;g.geometry=new THREE.PlaneGeometry(k,l);break;case hemi.ShapeType.ARROW:g.geometry=b(a.size!==undefined?a.size:1,a.tail!==undefined?a.tail:1,a.depth!==undefined?a.depth:1);break;case hemi.ShapeType.TETRA:g.geometry=e(a.size!==undefined?a.size:1);break;case hemi.ShapeType.OCTA:var n=a.size!==undefined?a.size:1;g.geometry=new THREE.OctahedronGeometry(n/2,0);break;case hemi.ShapeType.PYRAMID:g.geometry=d(a.height!==undefined?a.height:a.h!==undefined?a.h:1,a.width!==undefined?a.width:a.w!==undefined?a.w:1,a.depth!==undefined?a.depth:a.d!==undefined?a.d:1);break;case hemi.ShapeType.CUSTOM:g.geometry=c(a.vertices!==undefined?a.vertices:a.v!==undefined?a.v:[],a.faces!==undefined?a.faces:a.f!==undefined?a.f:[],a.faceVertexUvs!==undefined?a.faceVertexUvs:a.uvs!==undefined?a.uvs:[])}return g.geometry.computeBoundingSphere(),g.geometry.computeBoundingBox(),g.boundRadius=g.geometry.boundingSphere.radius,g}}(),function(){function b(b){var c=null;for(var d=0,e=a.length;d<e&&c===null;d++)a[d].client===b&&(c=a[d]);return c}var a=[];hemi.fx=hemi.fx||{},hemi.fx.cleanup=function(){a=[]},hemi.fx.clearFog=function(a){var c=b(a);if(c&&c.fog){a.scene.fog=undefined,a.setBGColor(c.oldBGHex);for(var d=0,e=c.materials.length;d<e;d++){var f=c.materials[d];a.renderer.initMaterial(f.mat,a.scene.__lights,a.scene.fog,f.obj)}}},hemi.fx.setFog=function(c,d,e,f){var g=b(c),h=c.scene.__webglObjects.concat(c.scene.__webglObjectsImmediate),i=[],j=!1;g||(g={client:c},a.push(g)),g.fog||(g.fog=new THREE.Fog,g.oldBGHex=c.renderer.getClearColor().getHex(),j=!0),g.fog.color.setHex(d),g.fog.near=e,g.fog.far=f,c.scene.fog=g.fog,c.setBGColor(d);if(j){for(var k=0,l=h.length;k<l;k++){var m=h[k],n=m.object,o=m.opaque,p=m.transparent;o&&i.push({mat:o,obj:n}),p&&i.push({mat:p,obj:n})}g.materials=i}for(var k=0,l=g.materials.length;k<l;k++){var q=g.materials[k],r=q.mat,n=q.obj,s=c.scene.fog;if(j)c.renderer.initMaterial(r,c.scene.__lights,s,n);else{var t=r.uniforms;t.fogColor.value=s.color,t.fogNear.value=s.near,t.fogFar.value=s.far}}},hemi.fx.setOpacity=function(a,b){var c=a.material;a._opacity===null&&(c=a.material=hemi.utils.cloneMaterial(c)),a._opacity=c.opacity=b,c.transparent=b<1}}(),function(){var a=function(a,b){this._callback=b||null,this.count=0,this.loaded=0,this.textures={};if(a)for(var c in a)this.addTexture(c,a[c])};a.prototype.addLoadedTexture=function(a,b){this.count++,this.loaded++,this.textures[a]=b},a.prototype.addTexture=function(a,b){var c=this;this.count++,hemi.loadTexture(b,function(b){c.textures[a]=b,c.loaded++,c.loaded===c.count&&c._callback&&c._callback(c.textures)})},a.prototype.getTexture=function(a){return this.textures[a]},hemi.TextureSet=a}(),function(){function b(a){a.reset(),a.send(hemi.msg.stop,{time:a.startTime})}var a=function(){this._started=null,this._time=0,this._timeId=null,this.startTime=1e3};a.prototype._clean=function(){this._timeId!==null&&(clearTimeout(this._timeId),this._timeId=null,this._started=null)},a.prototype._msgSent=[hemi.msg.start,hemi.msg.stop],a.prototype._octane=["startTime"],a.prototype.pause=function(){if(this._timeId!==null){clearTimeout(this._timeId),this._timeId=null;var a=(new Date).getTime();this._time+=a-this._started}},a.prototype.reset=function(){this._started=null,this._time=0,this._timeId=null},a.prototype.resume=function(){this._timeId===null&&this._started!==null&&(this._timeId=setTimeout(b,this.startTime-this._time,this),this._started=(new Date).getTime())},a.prototype.start=function(){this._timeId!==null&&clearTimeout(this._timeId),this._time=0,this.send(hemi.msg.start,{time:this.startTime}),this._timeId=setTimeout(b,this.startTime,this),this._started=(new Date).getTime()},a.prototype.stop=function(){if(this._timeId!==null){clearTimeout(this._timeId);var a=(new Date).getTime();this._time+=a-this._started}if(this._started!==null){var b=this._time;this.reset(),this.send(hemi.msg.stop,{time:b})}},hemi.makeCitizen(a,"hemi.Timer",{cleanup:a.prototype._clean,toOctane:a.prototype._octane})}(),function(){var a=function(){this.citizen=null,this.values=[],this.valueParams=[],this.handler=null,this.func=null,this.args=[]};a.prototype._clean=function(){this.citizen=null,this.values=[],this.handler=null,this.args=[]},a.prototype._octane=function(){var a=["values","valueParams","func","args"],b=[];for(var c=0,d=a.length;c<d;++c){var e=a[c];b.push({name:e,val:this[e]})}return b.push({name:"handler",id:this.handler._getId()}),this.citizen&&b.push({name:"citizen",id:this.citizen._getId()}),b},a.prototype.handleMessage=function(a){var b=hemi.dispatch.getArguments(a,this.valueParams),c=!0;for(var d=0,e=b.length;c&&d<e;++d){var f=b[d];f&&f._getId!==undefined?c=this.values[d]===f._getId():c=this.values[d]===f}if(c){var g=hemi.dispatch.getArguments(a,this.args);this.handler[this.func].apply(this.handler,g)}},a.prototype.handleKeyMessage=function(a){var b=hemi.dispatch.getArguments(a,this.valueParams)[0],c=this.values[0],d=b.keyCode===c.keyCode;d&&c.altKey&&(d=b.altKey),d&&c.ctrlKey&&(d=b.ctrlKey),d&&c.shiftKey&&(d=b.shiftKey);if(d){var e=hemi.dispatch.getArguments(a,this.args);this.handler[this.func].apply(this.handler,e)}},hemi.makeCitizen(a,"hemi.ValueCheck",{cleanup:a.prototype._clean,toOctane:a.prototype._octane}),hemi.handlePick=function(a,b,c,d,e){var f=new hemi.ValueCheck;return f.citizen=a,f.values=[b],f.valueParams=[hemi.dispatch.MSG_ARG+"data.pickedMesh.name"],f.handler=c,f.func=d,e&&(f.args=e),hemi.subscribe(hemi.msg.pick,f,"handleMessage")},hemi.handleCameraMove=function(a,b,c,d,e){var f=new hemi.ValueCheck;return f.citizen=a,f.values=[b._getId()],f.valueParams=[hemi.dispatch.MSG_ARG+"data.viewpoint"],f.handler=c,f.func=d,e&&(f.args=e),a.subscribe(hemi.msg.stop,f,"handleMessage")},hemi.handleKeyEvent=function(a,b,c,d,e){var f=new hemi.ValueCheck;return f.values=[b],f.valueParams=[hemi.dispatch.MSG_ARG+"data"],f.handler=c,f.func=d,e&&(f.args=e),hemi.subscribe(a,f,"handleKeyMessage")}}(),function(){function d(b){var c=null;for(var d=0,e=a.length;d<e&&c===null;d++)a[d].client===b&&(c=a[d]);return c}hemi.LightType={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional",AMBIENT:"ambient"};var a=[],b=[],c=function(a,b){this.client=a,this.light=b,this.name="",this.light&&this.addToScene()};c.prototype._clean=function(){this.client&&this.client.scene&&this.removeFromScene(),this.client=null,this.light=null,this.name=""},c.prototype._octane=["client","light","addToScene"],c.prototype.addToScene=function(){if(this.client){var a=this.client.scene;this.light&&(a.add(this.light),this.updateTargetMatrix(),this.refreshMaterial())}},c.prototype.removeFromScene=function(){if(this.client){var a=this.client.scene;this.light&&(a.remove(this.light),this.updateTargetMatrix(),this.refreshMaterial())}},c.prototype.updateTargetMatrix=function(){this.light.target&&(this.light.target.updateMatrix(),this.light.target.updateMatrixWorld())},c.prototype.setName=function(a){this.name=a},c.prototype.refreshMaterial=function(){if(!this.client.scene.__webglObjects)return;var c=d(this.client),e=this.client.scene.__webglObjects.concat(this.client.scene.__webglObjectsImmediate);c||(c={client:this.client},a.push(c));for(var f=0,g=e.length;f<g;f++){var h=e[f],i=h.object,j=h.opaque,k=h.transparent;j&&b.push({mat:j,obj:i}),k&&b.push({mat:k,obj:i})}c.materials=b;for(var f=0,g=c.materials.length;f<g;f++){var l=c.materials[f],m=l.mat,i=l.obj,n=this.client.scene.fog;this.client.renderer.initMaterial(m,this.client.scene.__lights,n,i)}},hemi.makeCitizen(c,"hemi.Light",{cleanup:c.prototype._clean,toOctane:c.prototype._octane}),hemi.makeOctanable(THREE.Vector3,"THREE.Vector3",["x","y","z"]),hemi.makeOctanable(THREE.AmbientLight,"THREE.AmbientLight",["color"]),hemi.makeOctanable(THREE.PointLight,"THREE.PointLight",["color","intensity","position","distance"]),hemi.makeOctanable(THREE.DirectionalLight,"THREE.DirectionalLight",["color","intensity","position","target"]),hemi.makeOctanable(THREE.SpotLight,"THREE.SpotLight",["color","intensity","position","distance"]),hemi.makeOctanable(THREE.Object3D,"THREE.Object3D",["position"])}()